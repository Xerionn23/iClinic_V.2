<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patients - iClinic Healthcare Management System</title>
    <!-- Cache busting for development -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>    <!-- Suppress Tailwind CDN Warning -->
    <script>
        // Suppress Tailwind CDN production warning
        const originalWarn = console.warn;
        console.warn = function(...args) {
            if (args[0] && typeof args[0] === 'string' && args[0].includes('cdn.tailwindcss.com')) {
                return; // Suppress Tailwind CDN warning
            }
            originalWarn.apply(console, args);
        };
    </script>

    <script>
        // Suppress Tailwind CDN production warning
        if (typeof tailwind !== 'undefined' && tailwind.config) {
            const originalWarn = console.warn;
            console.warn = function(...args) {
                if (args[0] && typeof args[0] === 'string' && args[0].includes('cdn.tailwindcss.com')) {
                    return;
                }
                originalWarn.apply(console, args);
            };
        }
    </script>
    <!-- Alpine.js -->
    <script defer src="/assets/js/libs/alpine.min.js"></script>
    
    <!-- Feather Icons -->
    <script src="/assets/js/libs/feather.min.js"></script>
    
    <!-- AOS Animation -->
    <link href="/assets/css/libs/aos.css" rel="stylesheet">
    <script src="/assets/js/libs/aos.js"></script>
    
    <!-- Inter Font -->
    <link href="/assets/css/libs/inter-font.css" rel="stylesheet">
    
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }
        
        /* Smooth transitions for all interactive elements */
        * {
            transition-property: transform, box-shadow, background-color, border-color;
            transition-duration: 200ms;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background-color: #f3f4f6;
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background-color: #9ca3af;
        }
        
        /* Glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
        }
        
        .dark .glass {
            background: rgba(20, 35, 55, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(55, 65, 81, 0.3);
        }
        
        body.dark {
            --tw-bg-opacity: 1;
            background-color: #0f172a;
        }
        
        body {
            background-color: #ffffff;
        }
        
        /* Sidebar gradient */
        .gradient-bg-sidebar {
            background: linear-gradient(135deg, #0056b3 0%, #003d82 100%);
            position: relative;
        }
        
        .gradient-bg-sidebar::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(45deg, transparent, rgba(253, 184, 19, 0.1), transparent);
            pointer-events: none;
        }
        
        .dark .gradient-bg-sidebar {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        }
        
        /* COMPREHENSIVE RESPONSIVE DESIGN SYSTEM */
        
        /* Extra Small Devices (320px - 374px) */
        @media (max-width: 374px) {
            .patient-card {
                padding: 0.625rem;
                font-size: 0.75rem;
            }
            .patient-info-card {
                padding: 0.625rem;
            }
            .page-title {
                font-size: 1.125rem;
            }
            .mobile-header h1 {
                font-size: 0.875rem;
            }
            .filter-pill {
                padding: 0.375rem 0.5rem;
                font-size: 0.7rem;
            }
            .two-panel-layout {
                height: calc(100vh - 60px);
            }
            .patient-list-panel {
                min-height: 250px;
            }
            .patient-details-panel {
                min-height: 250px;
            }
        }

        /* Small Devices (375px - 640px) */
        @media (max-width: 640px) {
            .sidebar-collapsed {
                transform: translateX(-100%);
                position: fixed;
                z-index: 50;
                width: 280px;
            }
            
            .sidebar-collapsed.mobile-open {
                transform: translateX(0);
            }
            
            .page-title {
                font-size: 1.5rem;
            }
            .two-panel-layout {
                flex-direction: column;
                height: calc(100vh - 70px);
                margin-top: 0 !important;
            }
            .patient-list-panel {
                width: 100%;
                height: 50vh;
                border-right: none;
                border-bottom: 1px solid #e5e7eb;
                min-height: 300px;
            }
            .patient-details-panel {
                width: 100%;
                height: 50vh;
                min-height: 300px;
            }
            .medical-records-table {
                font-size: 0.8125rem;
            }
            .medical-records-table th,
            .medical-records-table td {
                padding: 0.4375rem;
            }
            .action-button {
                min-width: 32px;
                min-height: 32px;
                padding: 0.375rem;
            }
            
            /* Hide desktop header on mobile */
            main > div:first-child {
                display: none !important;
            }
            
            /* Optimize patient list scrolling on mobile */
            .patient-list-panel > div:last-child {
                max-height: calc(50vh - 140px) !important;
            }
        }
        
        /* Desktop - restore normal height */
        @media (min-width: 768px) {
            .patient-list-panel > div:last-child {
                max-height: calc(100vh - 250px) !important;
            }
        }

        /* Medium Devices - Tablets (641px - 767px) */
        @media (min-width: 641px) and (max-width: 767px) {
            .tablet-optimized {
                padding: 1.5rem;
            }
            .patient-list-panel {
                width: 100%;
                height: 45vh;
            }
            .patient-details-panel {
                width: 100%;
                height: 55vh;
            }
            .medical-records-table {
                font-size: 0.875rem;
            }
            .medical-records-table th,
            .medical-records-table td {
                padding: 0.5rem;
            }
        }

        /* Large Devices (768px+) */
        @media (min-width: 768px) {
            .two-panel-layout {
                flex-direction: row;
                height: calc(100vh - 200px);
            }
            .patient-list-panel {
                width: 400px;
                height: 100%;
                border-right: 1px solid #e5e7eb;
                border-bottom: none;
            }
            .patient-details-panel {
                flex: 1;
                height: 100%;
            }
        }

        /* ENHANCED MOBILE OVERLAY SYSTEM */
        .mobile-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 30;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .mobile-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* RESPONSIVE TABLE SYSTEM */
        .medical-records-table {
            min-width: 320px;
        }
        
        @media (max-width: 374px) {
            .medical-records-table {
                font-size: 0.75rem;
                min-width: 300px;
            }
            .medical-records-table th,
            .medical-records-table td {
                padding: 0.375rem;
            }
        }
        
        @media (min-width: 375px) and (max-width: 640px) {
            .medical-records-table {
                font-size: 0.8125rem;
                min-width: 600px;
            }
            .medical-records-table th,
            .medical-records-table td {
                padding: 0.4375rem;
            }
        }
        
        @media (min-width: 641px) and (max-width: 767px) {
            .medical-records-table {
                font-size: 0.875rem;
                min-width: 800px;
            }
            .medical-records-table th,
            .medical-records-table td {
                padding: 0.5rem;
            }
        }
        
        @media (min-width: 768px) {
            .medical-records-table {
                min-width: 1000px;
            }
            .medical-records-table th,
            .medical-records-table td {
                padding: 0.625rem;
            }
        }
        
        /* Active sidebar item */
        .sidebar-item-active {
            background: linear-gradient(90deg, rgba(253, 184, 19, 0.2) 0%, rgba(253, 184, 19, 0.05) 100%);
            border-left: 4px solid var(--accent);
            box-shadow: 0 0 20px rgba(253, 184, 19, 0.2);
        }
        
        .dark .sidebar-item-active {
            background: linear-gradient(90deg, rgba(253, 184, 19, 0.25) 0%, rgba(253, 184, 19, 0.05) 100%);
            border-left: 4px solid var(--accent);
            box-shadow: 0 0 25px rgba(253, 184, 19, 0.3);
        }
        
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --secondary: #FDB813;
            --accent: #FDB813;
            --accent-hover: #e5a200;
            --neutral: #6b7280;
            --success: #10b981;
            --danger: #ef4444;
            --purple: #8b5cf6;
            --navy-dark: #1e293b;
            --navy-darker: #0f172a;
        }
        
        /* Smooth fade in animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Pulse animation for loading states */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        /* Scale animation on hover */
        .hover\:scale-102:hover {
            transform: scale(1.02);
        }
        
        /* TOUCH-FRIENDLY INTERFACE */
        .touch-target {
            min-height: 44px;
            min-width: 44px;
            touch-action: manipulation;
        }
        
        /* Prevent flash of unstyled content */
        [x-cloak] {
            display: none !important;
        }
        
        
        /* Scroll indicator shadow */
        .scroll-shadow {
            position: relative;
        }
        
        .scroll-shadow::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 10px;
            background: linear-gradient(to top, rgba(0,0,0,0.1), transparent);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .scroll-shadow.has-scroll::after {
            opacity: 1;
        }
        
        /* Card hover effects */
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        /* Smooth entrance animation */
        [x-show] {
            animation: fadeIn 0.3s ease-out;
        }
        
        .dark .bg-navy-dark {
            background-color: #2d3748;
        }
        
        .dark .bg-navy-darker {
            background-color: #1a202c;
        }
    </style>
    <script>
        function patientsDirectory() {
            return {
                userDropdown: false,
                showSettingsModal: false,
                showLogoutConfirm: false,
                sidebarHovered: false,
                notificationDropdown: false,
                searchQuery: '',
                activeFilter: 'all',
                selectedPatient: null,
                activeRecordTab: 'history',
                showAddVisitorModal: false,
                showDuplicateConfirmModal: false,
                duplicatePatients: [],
                pendingVisitorData: null,
                showAddRecordModal: false,
                showEditRecordModal: false,
                showViewRecordModal: false,
                showDeleteConfirmModal: false,
                showClinicStayModal: false,
                showPrintReportModal: false,
                showPrintPreviewModal: false,
                showPrintHistoryModal: false,
                showPrintReasonModal: false,
                showPdfPreviewModal: false,
                selectedRecordForPrint: null,
                printReason: '',
                printHistory: [],
                loadingPrintHistory: false,
                printingCertificate: false,
                pdfPreviewUrl: null,
                currentPdfBlob: null,
                generatingPdfPreview: false,
                showInsuranceModal: false,
                insuranceData: [],
                insuranceSummary: {},
                loadingInsurance: false,
                showArchiveModal: false,
                archivedPatients: [],
                loadingArchive: false,
                archiveFilter: 'all', // all, students, teaching, non-teaching, deans, visitors
                archiveSearchQuery: '',
                archiveYearFilter: 'all', // all, 2025, 2024, 2023, etc.
                insuranceFilter: 'all', // all, paid, unpaid, first-year
                insuranceDepartmentFilter: 'all', // all, BSED, Computer Science, BEED, HM
                insuranceSectionFilter: 'all', // all, 1A, 1B, 2A, 2B, 3A, 3B, 4A, 4B
                selectedStudent: null,
                showPaymentModal: false,
                paymentForm: {
                    insurance_paid: 'paid',
                    insurance_amount: 50.00,
                    insurance_payment_date: new Date().toISOString().split('T')[0],
                    insurance_notes: ''
                },
                showCheckoutModal: false,
                viewingRecord: null,
                deletingRecord: null,
                patients: [],
                filteredPatients: [],
                loadingPatients: false,
                loadingPatientRecords: false,
                addingRecord: false,
                addingVisitor: false,
                newVisitor: {
                    first_name: '',
                    middle_name: '',
                    last_name: '',
                    age: '',
                    contact_number: ''
                },
                editingRecord: null,
                newRecord: {
                    visit_date: new Date().toISOString().split('T')[0], // Default to today
                    visit_time: new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' }),
                    chief_complaint: '',
                    medical_history: '',
                    fever_duration: '',
                    current_medication: '',
                    medication_schedule: '',
                    blood_pressure_systolic: '',
                    blood_pressure_diastolic: '',
                    pulse_rate: '',
                    temperature: '',
                    respiratory_rate: '',
                    weight: '',
                    height: '',
                    symptoms: '',
                    treatment: '',
                    prescribed_medicine: '',
                    prescribed_medicines: [], // Array of prescribed medicines with quantities
                    dental_procedure: '',
                    procedure_notes: '',
                    follow_up_date: '',
                    special_instructions: '',
                    notes: '',
                    // Clinic stay fields
                    will_stay_in_clinic: false,
                    stay_reason: ''
                },
                // Medicine inventory data
                availableMedicines: [],
                loadingMedicines: false,
                
                // Common dropdown options for easy selection
                commonComplaints: [
                    'Headache / Sakit ng ulo',
                    'Fever / Lagnat',
                    'Cough / Ubo',
                    'Cold / Sipon',
                    'Stomach ache / Sakit ng tiyan',
                    'Toothache / Sakit ng ngipin',
                    'Sore throat / Sakit ng lalamunan',
                    'Dizziness / Nahihilo',
                    'Body pain / Sakit ng katawan',
                    'Nausea / Nahihilo/nagsusuka',
                    'Diarrhea / Pagtatae',
                    'Constipation / Hindi makatae',
                    'Skin rash / Pantal sa balat',
                    'Eye irritation / Sakit ng mata',
                    'Ear pain / Sakit ng tenga',
                    'Menstrual cramps / Dysmenorrhea',
                    'Injury / Sugat',
                    'Allergic reaction / Allergy',
                    'Hypertension / Mataas na BP',
                    'Asthma attack / Hika',
                    'Other (specify)'
                ],
                
                commonTreatments: [
                    'Medication given / Binigyan ng gamot',
                    'Rest and observation / Pahinga at observation',
                    'First aid treatment / First aid',
                    'Wound cleaning and dressing / Linis at takip ng sugat',
                    'Ice pack application / Ice pack',
                    'Hot compress / Mainit na compress',
                    'Blood pressure monitoring / Monitor ng BP',
                    'Temperature monitoring / Monitor ng lagnat',
                    'Referral to doctor / Refer sa doctor',
                    'Referral to hospital / Refer sa hospital',
                    'Health education / Health teaching',
                    'Dental consultation / Dental check',
                    'Eye examination / Eye check',
                    'Injection given / Binigyan ng injection',
                    'Nebulization / Nebulizer',
                    'Other (specify)'
                ],
                
                commonSymptoms: [
                    'Fever with chills / Lagnat na may panginginig',
                    'Severe headache / Matinding sakit ng ulo',
                    'Persistent cough / Tuloy-tuloy na ubo',
                    'Difficulty breathing / Hirap sa paghinga',
                    'Chest pain / Sakit sa dibdib',
                    'Abdominal pain / Sakit sa tiyan',
                    'Vomiting / Pagsusuka',
                    'Diarrhea / Pagtatae',
                    'Dizziness and weakness / Hilo at panghihina',
                    'Skin rash with itching / Pantal na makati',
                    'Swollen lymph nodes / Maga na kulani',
                    'Joint pain / Sakit ng kasukasuan',
                    'Muscle pain / Sakit ng kalamnan',
                    'Fatigue / Pagkapagod',
                    'Loss of appetite / Walang gana kumain',
                    'Runny nose / Sipon',
                    'Sore throat / Sakit ng lalamunan',
                    'Eye redness / Pamumula ng mata',
                    'Ear discharge / Tubig sa tenga',
                    'Irregular heartbeat / Hindi regular na tibok',
                    'Other (specify)'
                ],
                
                commonProcedures: [
                    'Tooth extraction / Bunot ng ngipin',
                    'Dental cleaning / Linis ng ngipin',
                    'Dental filling / Pasta sa ngipin',
                    'Injection (IM/IV) / Injection',
                    'Wound suturing / Tahi ng sugat',
                    'Bandaging / Bendahe',
                    'Splinting / Splint',
                    'Nebulization / Nebulizer',
                    'Blood pressure check / BP taking',
                    'Temperature taking / Lagnat check',
                    'Weight and height measurement / Timbang at taas',
                    'Eye examination / Tingnan ang mata',
                    'Ear examination / Tingnan ang tenga',
                    'Throat examination / Tingnan ang lalamunan',
                    'ECG / Electrocardiogram',
                    'Other (specify)'
                ],
                
                commonInstructions: [
                    'Take medicine as prescribed / Inumin ang gamot ayon sa tagubilin',
                    'Rest for 24 hours / Magpahinga ng 24 oras',
                    'Drink plenty of water / Maraming tubig',
                    'Avoid strenuous activities / Iwasan ang mabibigat na gawain',
                    'Return if symptoms worsen / Bumalik kung lumala',
                    'Follow-up after 3 days / Follow-up pagkatapos ng 3 araw',
                    'Apply ice pack for 15 minutes / Ice pack ng 15 minuto',
                    'Keep wound clean and dry / Panatilihing malinis at tuyo ang sugat',
                    'Take paracetamol for fever / Paracetamol para sa lagnat',
                    'Avoid cold drinks / Iwasan ang malamig na inumin',
                    'Gargle with warm salt water / Mouthwash ng maaalat na tubig',
                    'Use prescribed eye drops / Gamitin ang eye drops',
                    'Monitor blood pressure daily / I-monitor ang BP araw-araw',
                    'Avoid allergens / Iwasan ang mga nakaka-allergy',
                    'Complete bed rest / Kumpleto na bed rest',
                    'Other (specify)'
                ],
                clinicStays: [],
                currentStays: [],
                selectedStay: null,
                newClinicStay: {
                    medical_record_id: null,
                    student_number: null,
                    patient_name: '',
                    stay_reason: ''
                },
                checkoutData: {
                    checkout_notes: ''
                },
                
                getCurrentDateTime() {
                    const now = new Date();
                    const date = now.toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    });
                    const time = now.toLocaleTimeString('en-US', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: true
                    });
                    return `${date} at ${time}`;
                },
                
                async initPatients() {
                    // Reset modal states to prevent flash
                    this.showAddVisitorModal = false;
                    this.showAddRecordModal = false;
                    this.showEditRecordModal = false;
                    this.showViewRecordModal = false;
                    this.showDeleteConfirmModal = false;
                    this.showSettingsModal = false;
                    this.showPrintReportModal = false;
                    this.showPrintPreviewModal = false;
                    this.showLogoutConfirm = false;
                    this.viewingRecord = null;
                    this.editingRecord = null;
                    this.deletingRecord = null;
                    
                    this.loading = true;
                    await this.loadPatients();
                    await this.loadMedicines();
                    this.filterPatients();
                    this.loading = false;
                },

                initializeFeatherIcons() {
                    try {
                        if (typeof feather !== 'undefined' && feather.icons) {
                            // Safe feather icon replacement
                            const icons = document.querySelectorAll('[data-feather]');
                            icons.forEach(icon => {
                                try {
                                    const iconName = icon.getAttribute('data-feather');
                                    if (iconName && feather.icons[iconName]) {
                                        const parent = icon.parentNode;
                                        if (parent && parent.nodeType === Node.ELEMENT_NODE) {
                                            const svg = feather.icons[iconName].toSvg({
                                                width: icon.getAttribute('width') || icon.style.width || '24',
                                                height: icon.getAttribute('height') || icon.style.height || '24',
                                                class: icon.className
                                            });
                                            const tempDiv = document.createElement('div');
                                            tempDiv.innerHTML = svg;
                                            const newSvg = tempDiv.firstChild;
                                            if (newSvg && newSvg.nodeType === Node.ELEMENT_NODE) {
                                                parent.replaceChild(newSvg, icon);
                                            }
                                        }
                                    }
                                } catch (e) {
                                    // Silently ignore individual icon errors
                                }
                            });
                        }
                    } catch (error) {
                        console.log('Feather icons initialization skipped');
                    }
                },

                async loadMedicines() {
                    this.loadingMedicines = true;
                    try {
                        // Use new endpoint that only returns NON-EXPIRED medicines with stock > 0
                        const response = await fetch('/api/medicine/available-for-prescription');
                        if (response.ok) {
                            const medicines = await response.json();
                            // API already filters for non-expired and quantity > 0
                            this.availableMedicines = medicines;
                            // Medicines loaded successfully
                        } else {
                            console.error('âŒ Failed to load medicines');
                            this.availableMedicines = [];
                        }
                    } catch (error) {
                        console.error('ðŸ”¥ Error loading medicines:', error);
                        this.availableMedicines = [];
                    } finally {
                        this.loadingMedicines = false;
                    }
                },

                async loadPatients() {
                    try {
                        // Load students from database
                        await this.loadStudentsFromDatabase();
                        
                        this.$nextTick(() => {
                            this.initializeFeatherIcons();
                            AOS.init({
                                duration: 600,
                                once: true,
                                offset: 50
                            });
                        });
                        
                        // Handle responsive sidebar
                        this.handleResize();
                        window.addEventListener('resize', () => this.handleResize());
                    } catch (error) {
                        this.showError('Failed to load patient data');
                    } finally {
                        this.loading = false;
                    }
                },

                getDepartmentFullName(department) {
                    const departmentMap = {
                        'Comscie': 'COMPUTING STUDIES',
                        'ComSci': 'COMPUTING STUDIES',
                        'Computer Science': 'COMPUTING STUDIES',
                        'BS Computer Science': 'COMPUTING STUDIES',
                        'Educ': 'EDUCATION',
                        'Education': 'EDUCATION',
                        'HM': 'HOSPITALITY MANAGEMENT',
                        'Hospitality Management': 'HOSPITALITY MANAGEMENT',
                        'Tourism': 'TOURISM MANAGEMENT',
                        'Tourism Management': 'TOURISM MANAGEMENT',
                        'Business': 'BUSINESS ADMINISTRATION',
                        'Business Administration': 'BUSINESS ADMINISTRATION',
                        'Engineering': 'ENGINEERING',
                        'Nursing': 'NURSING',
                        'Psychology': 'PSYCHOLOGY',
                        'Criminology': 'CRIMINOLOGY',
                        'Information Technology': 'INFORMATION TECHNOLOGY',
                        'IT': 'INFORMATION TECHNOLOGY'
                    };
                    return departmentMap[department] || department.toUpperCase();
                },

                async loadStudentsFromDatabase() {
                    try {
                        const response = await fetch('/api/all-patients');
                        if (response.ok) {
                            const data = await response.json();
                            
                            // Handle both response formats: direct array or {patients: [...]}
                            const students = Array.isArray(data) ? data : (data.patients || []);
                            
                            // Transform students data to match patients format
                            this.patients = students.map(student => ({
                                id: student.id,
                                name: student.name,
                                identifier: student.identifier,
                                role: student.role,
                                age: student.age,
                                department: student.department,
                                contact: student.contact || student.contact_num || 'N/A',
                                email: student.email || 'N/A',
                                course: student.course,
                                level: student.level,
                                gender: student.gender,
                                status: student.status,
                                rank: student.rank,
                                position: student.position,
                                specialization: student.specialization,
                                college: student.college,
                                // Additional student information
                                surname: student.surname,
                                firstname: student.firstname,
                                middlename: student.middlename,
                                suffix: student.suffix,
                                birthdate: student.birthdate,
                                civil_status: student.civil_status,
                                citizenship: student.citizenship,
                                religion: student.religion,
                                address: student.address,
                                father_name: student.father_name,
                                father_age: student.father_age,
                                father_occupation: student.father_occupation,
                                father_contact: student.father_contact,
                                father_email: student.father_email,
                                father_education: student.father_education,
                                mother_name: student.mother_name,
                                mother_age: student.mother_age,
                                mother_occupation: student.mother_occupation,
                                mother_contact: student.mother_contact,
                                mother_email: student.mother_email,
                                mother_education: student.mother_education,
                                last_school: student.last_school,
                                last_school_type: student.last_school_type,
                                last_school_address: student.last_school_address,
                                academic_strand: student.academic_strand,
                                pwd: student.pwd,
                                course_choice1: student.course_choice1,
                                course_choice2: student.course_choice2,
                                course_choice3: student.course_choice3,
                                picture: student.picture,
                                paying: student.paying,
                                curriculum: student.curriculum,
                                // Emergency Contact Information
                                emergency_contact_name: student.emergency_contact_name || 'N/A',
                                emergency_contact_relationship: student.emergency_contact_relationship || 'N/A',
                                emergency_contact_number: student.emergency_contact_number || 'N/A',
                                blood_type: student.blood_type || 'N/A',
                                allergies: student.allergies || 'None',
                                medical_conditions: student.medical_conditions || 'None',
                                medicalHistory: [],
                                clinicVisits: [],
                                prescriptions: [],
                                labResults: []
                            }));
                            
                            this.filteredPatients = this.patients;
                        } else {
                            console.error('Failed to load students:', response.statusText);
                        }
                    } catch (error) {
                        console.error('Error loading students:', error);
                    }
                },

                async loadPrintHistory() {
                    this.loadingPrintHistory = true;
                    try {
                        const response = await fetch('/api/print-history');
                        if (response.ok) {
                            this.printHistory = await response.json();
                        } else {
                            console.error('Failed to load print history:', response.statusText);
                            this.showError('Failed to load print history');
                        }
                    } catch (error) {
                        console.error('Error loading print history:', error);
                        this.showError('Error loading print history');
                    } finally {
                        this.loadingPrintHistory = false;
                    }
                },

                async fixPrintHistoryDates() {
                    try {
                        const response = await fetch('/api/fix-print-history-dates', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            this.showSuccess(result.message);
                            // Reload the print history to show updated dates
                            await this.loadPrintHistory();
                        } else {
                            console.error('Failed to fix print history dates:', response.statusText);
                            this.showError('Failed to fix print history dates');
                        }
                    } catch (error) {
                        console.error('Error fixing print history dates:', error);
                        this.showError('Error fixing print history dates');
                    }
                },
                
                handleResize() {
                    if (window.innerWidth < 768) {
                        this.sidebarCollapsed = true;
                    }
                },
                
                filterPatients() {
                    let filtered = this.patients;
                    
                    // Filter by role
                    if (this.activeFilter !== 'all') {
                        filtered = filtered.filter(patient => {
                            switch(this.activeFilter) {
                                case 'students': return patient.role === 'Student';
                                case 'teaching': return patient.role === 'Teaching Staff';
                                case 'non-teaching': return patient.role === 'Non-Teaching Staff';
                                case 'deans': return patient.role === 'Dean';
                                case 'president': return patient.role === 'President';
                                case 'visitors': return patient.role === 'Visitor';
                                default: return true;
                            }
                        });
                    }
                    
                    // Filter by search query
                    if (this.searchQuery) {
                        const query = this.searchQuery.toLowerCase();
                        filtered = filtered.filter(patient => 
                            patient.name.toLowerCase().includes(query) ||
                            patient.identifier.toLowerCase().includes(query) ||
                            patient.department.toLowerCase().includes(query)
                        );
                    }
                    
                    this.filteredPatients = filtered;
                },
                
                getRankOrCourse() {
                    if (!this.selectedPatient) {
                        return 'N/A';
                    }
                    
                    if (this.selectedPatient.role === 'Teaching Staff') {
                        const rank = this.selectedPatient.rank;
                        return rank || 'No Rank';
                    } else if (this.selectedPatient.role === 'Non-Teaching Staff') {
                        let position = this.selectedPatient.position;
                        // Treat 'N/A' as empty
                        if (!position || position === 'N/A') {
                            return 'No Position';
                        }
                        return position;
                    } else if (this.selectedPatient.role === 'Dean') {
                        const college = this.selectedPatient.college;
                        return college || 'No Department';
                    } else if (this.selectedPatient.role === 'President') {
                        return 'College President';
                    } else {
                        const course = this.selectedPatient.course;
                        return course || 'No Course';
                    }
                },
                
                getPatientSubtitle() {
                    if (!this.selectedPatient) {
                        return '';
                    }
                    
                    const identifier = this.selectedPatient.identifier || '';
                    
                    if (this.selectedPatient.role === 'Teaching Staff') {
                        const rank = this.selectedPatient.rank || 'Faculty';
                        return identifier + ' â€¢ ' + rank;
                    } else if (this.selectedPatient.role === 'Non-Teaching Staff') {
                        let position = this.selectedPatient.position;
                        if (!position || position === 'N/A') {
                            position = 'Staff';
                        }
                        return identifier + ' â€¢ ' + position;
                    } else if (this.selectedPatient.role === 'Dean') {
                        // Display full college name from database
                        const college = this.selectedPatient.college || 'Dean';
                        return identifier + ' â€¢ ' + college;
                    } else if (this.selectedPatient.role === 'President') {
                        return identifier ? identifier + ' â€¢ College President' : 'College President';
                    } else if (this.selectedPatient.role === 'Visitor') {
                        // For visitors, only show identifier without N/A
                        return identifier || '';
                    } else {
                        const course = this.selectedPatient.course || 'Student';
                        return identifier + ' â€¢ ' + course;
                    }
                },
                
                async selectPatient(patient) {
                    this.selectedPatient = patient;
                    this.activeRecordTab = 'history';
                    this.loadingPatientRecords = true;
                    
                    // Load patient's medical records
                    await this.loadPatientRecords(patient.id);
                    this.loadingPatientRecords = false;
                    
                    // Re-initialize Feather icons after patient selection
                    this.$nextTick(() => {
                        if (typeof feather !== 'undefined') {
                            try {
                                feather.replace();
                            } catch (error) {
                                console.warn('Feather icons initialization warning:', error);
                            }
                        }
                    });
                },

                async loadPatientRecords(patientId) {
                    try {
                        // Determine patient type and appropriate endpoint
                        const role = this.selectedPatient?.role;
                        const isVisitor = role === 'Visitor';
                        const isTeaching = role === 'Teaching Staff';
                        const isNonTeaching = role === 'Non-Teaching Staff';
                        const isDean = role === 'Dean';
                        const isPresident = role === 'President';
                        
                        let endpoint;
                        let patientType;
                        
                        if (isVisitor) {
                            endpoint = `/api/visitor-medical-records/${this.selectedPatient.id.replace('V', '')}`;
                            patientType = 'visitor';
                        } else if (isTeaching) {
                            endpoint = `/api/teaching-medical-records/${this.selectedPatient.id.replace('T', '')}`;
                            patientType = 'teaching';
                        } else if (isNonTeaching) {
                            endpoint = `/api/non-teaching-medical-records/${this.selectedPatient.id.replace('NT', '')}`;
                            patientType = 'non_teaching';
                        } else if (isDean) {
                            endpoint = `/api/dean-medical-records/${this.selectedPatient.id.replace('D', '')}`;
                            patientType = 'dean';
                        } else if (isPresident) {
                            endpoint = `/api/president-medical-records/${this.selectedPatient.id.replace('P', '')}`;
                            patientType = 'president';
                        } else {
                            endpoint = `/api/student-medical-records/${this.selectedPatient.id}`;
                            patientType = 'student';
                        }
                        
                        // Loading medical records
                        
                        const response = await fetch(endpoint);
                        if (response.ok) {
                            const records = await response.json();
                            // Update selected patient with medical records from database
                            if (this.selectedPatient) {
                                this.selectedPatient.medical_records = records.map(record => ({
                                    id: record.id,
                                    date: this.formatDate(record.visit_date),
                                    time: this.formatTime(record.created_at),
                                    visit_date: record.visit_date,
                                    visit_time: record.visit_time,
                                    // Map symptoms/chief_complaint properly
                                    symptoms: record.symptoms || record.chief_complaint || 'No complaint recorded',
                                    chief_complaint: record.chief_complaint || record.symptoms || 'No complaint recorded',
                                    dental_procedure: record.dental_procedure || '',
                                    treatment: record.treatment || 'No treatment specified',
                                    prescribed_medicine: record.prescribed_medicine || '',
                                    // Map vital signs properly
                                    blood_pressure: record.blood_pressure || '',
                                    blood_pressure_systolic: record.blood_pressure_systolic || '',
                                    blood_pressure_diastolic: record.blood_pressure_diastolic || '',
                                    temperature: record.temperature || '',
                                    heart_rate: record.heart_rate || record.pulse_rate || '',
                                    pulse_rate: record.pulse_rate || record.heart_rate || '',
                                    weight: record.weight || '',
                                    notes: record.notes || '',
                                    doctor_name: record.doctor_name || 'Unknown Doctor',
                                    // Clinic stay fields
                                    will_stay_in_clinic: record.will_stay_in_clinic || false,
                                    stay_reason: record.stay_reason || '',
                                    stay_status: record.stay_status || 'not_staying',
                                    actual_checkout_time: record.actual_checkout_time || null,
                                    checkout_notes: record.checkout_notes || '',
                                    // Handle admission_time: convert "None", "null", empty string to null
                                    admission_time: (record.admission_time && record.admission_time !== 'None' && record.admission_time !== 'null') ? record.admission_time : null,
                                    // Handle discharge_time: convert "None", "null", empty string to null
                                    discharge_time: (record.discharge_time && record.discharge_time !== 'None' && record.discharge_time !== 'null') ? record.discharge_time : null
                                }));
                                
                                // Medical records loaded successfully
                            }
                        } else {
                            // If no records found, set empty array
                            if (this.selectedPatient) {
                                this.selectedPatient.medical_records = [];
                            }
                        }
                    } catch (error) {
                        console.error('Error loading patient records:', error);
                        this.showError('Failed to load patient records');
                        // Set empty array on error
                        if (this.selectedPatient) {
                            this.selectedPatient.medical_records = [];
                        }
                    }
                },

                formatVitalSigns(record) {
                    const vitals = [];
                    if (record.blood_pressure_systolic && record.blood_pressure_diastolic) {
                        vitals.push(`BP: ${record.blood_pressure_systolic}/${record.blood_pressure_diastolic}`);
                    }
                    if (record.temperature) {
                        vitals.push(`Temp: ${record.temperature}Â°C`);
                    }
                    if (record.pulse_rate) {
                        vitals.push(`Pulse: ${record.pulse_rate} bpm`);
                    }
                    return vitals.length > 0 ? vitals.join(', ') : 'N/A';
                },
                
                getRoleColor(role) {
                    const colors = {
                        'Student': 'bg-blue-500',
                        'Teaching Staff': 'bg-yellow-500',
                        'Non-Teaching Staff': 'bg-green-500',
                        'Dean': 'bg-purple-500',
                        'President': 'bg-red-500',
                        'Visitor': 'bg-gray-500'
                    };
                    return colors[role] || 'bg-gray-500';
                },
                
                getRoleBadge(role) {
                    const badges = {
                        'Student': 'bg-blue-100 text-blue-700',
                        'Teaching Staff': 'bg-yellow-100 text-yellow-700',
                        'Non-Teaching Staff': 'bg-green-100 text-green-700',
                        'Dean': 'bg-purple-100 text-purple-700',
                        'President': 'bg-red-100 text-red-700',
                        'Visitor': 'bg-gray-100 text-gray-700'
                    };
                    return badges[role] || 'bg-gray-100 text-gray-700';
                },

                calculateBMI() {
                    if (this.newRecord.weight && this.newRecord.height) {
                        const weight = parseFloat(this.newRecord.weight);
                        const height = parseFloat(this.newRecord.height) / 100; // Convert cm to meters
                        if (weight > 0 && height > 0) {
                            const bmi = weight / (height * height);
                            return bmi.toFixed(2);
                        }
                    }
                    return '';
                },
                

                formatDate(dateString) {
                    if (!dateString) return 'N/A';
                    const date = new Date(dateString);
                    return date.toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    });
                },

                formatTime(dateTimeString) {
                    if (!dateTimeString) return 'N/A';
                    const date = new Date(dateTimeString);
                    return date.toLocaleTimeString('en-US', {
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: true
                    });
                },

                // Reset form to initial state
                resetNewRecordForm() {
                    console.log('ðŸ”„ Resetting medical record form...');
                    this.newRecord = {
                        visit_date: new Date().toISOString().split('T')[0],
                        visit_time: new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' }),
                        chief_complaint: '',
                        medical_history: '',
                        fever_duration: '',
                        current_medication: '',
                        medication_schedule: '',
                        blood_pressure_systolic: '',
                        blood_pressure_diastolic: '',
                        pulse_rate: '',
                        temperature: '',
                        respiratory_rate: '',
                        weight: '',
                        height: '',
                        bmi: '',
                        symptoms: '',
                        treatment: '',
                        prescribed_medicine: '',
                        prescribed_medicines: [],
                        dental_procedure: '',
                        procedure_notes: '',
                        follow_up_date: '',
                        special_instructions: '',
                        notes: '',
                        will_stay_in_clinic: false,
                        stay_reason: ''
                    };
                    
                    // Reset all dropdown selections to default (empty)
                    this.$nextTick(() => {
                        if (this.$refs.complaintDropdown) this.$refs.complaintDropdown.value = '';
                        if (this.$refs.symptomsDropdown) this.$refs.symptomsDropdown.value = '';
                        if (this.$refs.treatmentDropdown) this.$refs.treatmentDropdown.value = '';
                        if (this.$refs.dentalProcedureDropdown) this.$refs.dentalProcedureDropdown.value = '';
                        if (this.$refs.instructionsDropdown) this.$refs.instructionsDropdown.value = '';
                        console.log('âœ… Dropdowns reset complete');
                    });
                    
                    console.log('âœ… Form reset complete');
                },

                async addMedicalRecord() {
                    if (!this.selectedPatient) {
                        this.showError('No patient selected');
                        return;
                    }
                    
                    // Form validation (date and time are automatic) - removed diagnosis requirement
                    if (!this.newRecord.chief_complaint || !this.newRecord.treatment) {
                        this.showError('Please fill in all required fields (Reason for Visit, Treatment)');
                        return;
                    }
                    
                    // âœ… VALIDATE MEDICINE AVAILABILITY BEFORE SAVING
                    if (this.newRecord.prescribed_medicines.length > 0) {
                        const insufficientMedicines = [];
                        
                        console.log('ðŸ” Validating medicines:', this.newRecord.prescribed_medicines);
                        console.log('ðŸ“¦ Available medicines:', this.availableMedicines.map(m => ({id: m.id, name: m.medicine_name, qty: m.quantity})));
                        
                        for (const prescribed of this.newRecord.prescribed_medicines) {
                            // Find the medicine in available medicines (use == for type coercion)
                            const medicine = this.availableMedicines.find(m => m.id == prescribed.medicine_id);
                            
                            console.log(`ðŸ”Ž Looking for medicine_id: ${prescribed.medicine_id} (${typeof prescribed.medicine_id})`);
                            console.log(`âœ… Found:`, medicine);
                            
                            if (!medicine) {
                                insufficientMedicines.push(`${prescribed.medicine_name}: Medicine not found in inventory`);
                                continue;
                            }
                            
                            const availableQty = medicine.quantity || medicine.quantity_in_stock || 0;
                            const requestedQty = prescribed.quantity || 0;
                            
                            if (requestedQty > availableQty) {
                                insufficientMedicines.push(
                                    `${prescribed.medicine_name}: Requested ${requestedQty} pcs, but only ${availableQty} pcs available`
                                );
                            }
                        }
                        
                        // If there are insufficient medicines, show error and STOP
                        if (insufficientMedicines.length > 0) {
                            const errorMessage = 'âŒ Cannot add medical record - Insufficient medicine stock:\n\n' + 
                                insufficientMedicines.join('\n');
                            this.showError(errorMessage);
                            return; // STOP - Do not proceed
                        }
                    }
                    
                    this.addingRecord = true;
                    
                    try {
                        // Determine patient type and appropriate endpoint
                        const role = this.selectedPatient?.role;
                        const isVisitor = role === 'Visitor';
                        const isTeaching = role === 'Teaching Staff';
                        const isNonTeaching = role === 'Non-Teaching Staff';
                        const isDean = role === 'Dean';
                        const isPresident = role === 'President';
                        
                        let endpoint;
                        let patientIdField;
                        let patientType;
                        
                        if (isVisitor) {
                            endpoint = '/api/add-visitor-medical-record';
                            patientIdField = 'visitor_id';
                            patientType = 'visitor';
                        } else if (isTeaching) {
                            endpoint = '/api/add-teaching-medical-record';
                            patientIdField = 'teaching_id';
                            patientType = 'teaching staff';
                        } else if (isNonTeaching) {
                            endpoint = '/api/add-non-teaching-medical-record';
                            patientIdField = 'non_teaching_id';
                            patientType = 'non-teaching staff';
                        } else if (isDean) {
                            endpoint = '/api/add-dean-medical-record';
                            patientIdField = 'dean_id';
                            patientType = 'dean';
                        } else if (isPresident) {
                            endpoint = '/api/add-president-medical-record';
                            patientIdField = 'president_id';
                            patientType = 'president';
                        } else {
                            endpoint = '/api/add-student-medical-record';
                            patientIdField = 'student_number';
                            patientType = 'student';
                        }
                        
                        console.log(`Adding medical record for ${patientType} ID: ${this.selectedPatient.id}`);
                        
                        // âœ… Build request body - ONLY include NON-EMPTY fields
                        const requestBody = {
                            [patientIdField]: this.selectedPatient.id,
                            visit_date: this.newRecord.visit_date,
                            visit_time: this.newRecord.visit_time,
                            chief_complaint: this.newRecord.chief_complaint,
                            treatment: this.newRecord.treatment,
                            symptoms: this.newRecord.symptoms
                        };
                        
                        // Add optional fields ONLY if they have values
                        if (this.newRecord.medical_history && this.newRecord.medical_history.trim()) {
                            requestBody.medical_history = this.newRecord.medical_history;
                        }
                        if (this.newRecord.fever_duration && this.newRecord.fever_duration.trim()) {
                            requestBody.fever_duration = this.newRecord.fever_duration;
                        }
                        if (this.newRecord.current_medication && this.newRecord.current_medication.trim()) {
                            requestBody.current_medication = this.newRecord.current_medication;
                        }
                        if (this.newRecord.medication_schedule && this.newRecord.medication_schedule.trim()) {
                            requestBody.medication_schedule = this.newRecord.medication_schedule;
                        }
                        
                        // Vital signs - only if filled
                        if (this.newRecord.blood_pressure_systolic && this.newRecord.blood_pressure_systolic > 0) {
                            requestBody.blood_pressure_systolic = this.newRecord.blood_pressure_systolic;
                        }
                        if (this.newRecord.blood_pressure_diastolic && this.newRecord.blood_pressure_diastolic > 0) {
                            requestBody.blood_pressure_diastolic = this.newRecord.blood_pressure_diastolic;
                        }
                        if (this.newRecord.pulse_rate && this.newRecord.pulse_rate > 0) {
                            requestBody.pulse_rate = this.newRecord.pulse_rate;
                        }
                        if (this.newRecord.temperature && this.newRecord.temperature > 0) {
                            requestBody.temperature = this.newRecord.temperature;
                        }
                        if (this.newRecord.respiratory_rate && this.newRecord.respiratory_rate > 0) {
                            requestBody.respiratory_rate = this.newRecord.respiratory_rate;
                        }
                        
                        // Physical measurements - only if filled
                        if (this.newRecord.weight && this.newRecord.weight > 0) {
                            requestBody.weight = this.newRecord.weight;
                        }
                        if (this.newRecord.height && this.newRecord.height > 0) {
                            requestBody.height = this.newRecord.height;
                        }
                        if (this.newRecord.bmi && this.newRecord.bmi.trim()) {
                            requestBody.bmi = this.newRecord.bmi;
                        }
                        
                        // Prescribed medicine - only if filled
                        const prescribedMedicineText = this.formatPrescribedMedicines();
                        if (prescribedMedicineText && prescribedMedicineText.trim()) {
                            requestBody.prescribed_medicine = prescribedMedicineText;
                            requestBody.prescribed_medicines = this.newRecord.prescribed_medicines;
                        }
                        
                        // Procedures - only if filled
                        if (this.newRecord.dental_procedure && this.newRecord.dental_procedure.trim()) {
                            requestBody.dental_procedure = this.newRecord.dental_procedure;
                        }
                        if (this.newRecord.procedure_notes && this.newRecord.procedure_notes.trim()) {
                            requestBody.procedure_notes = this.newRecord.procedure_notes;
                        }
                        if (this.newRecord.follow_up_date && this.newRecord.follow_up_date.trim()) {
                            requestBody.follow_up_date = this.newRecord.follow_up_date;
                        }
                        if (this.newRecord.special_instructions && this.newRecord.special_instructions.trim()) {
                            requestBody.special_instructions = this.newRecord.special_instructions;
                        }
                        if (this.newRecord.notes && this.newRecord.notes.trim()) {
                            requestBody.notes = this.newRecord.notes;
                        }
                        
                        // Clinic stay fields
                        if (this.newRecord.will_stay_in_clinic) {
                            requestBody.will_stay_in_clinic = this.newRecord.will_stay_in_clinic;
                            requestBody.stay_reason = this.newRecord.stay_reason;
                        }
                        
                        console.log('ðŸ“¤ Sending request body (NON-EMPTY fields only):', requestBody);
                        
                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(requestBody)
                        });
                        
                        if (response.ok) {
                            // Update inventory if medicines were prescribed
                            if (this.newRecord.prescribed_medicines.length > 0) {
                                await this.updateInventoryAfterPrescription(this.newRecord.prescribed_medicines);
                            }

                            // Reset form using the reset function
                            this.resetNewRecordForm();
                            this.showAddRecordModal = false;
                            
                            // Reload patient records and recent visits
                            await this.loadPatientRecords(this.selectedPatient.id);
                            
                            this.showSuccess('Medical record added successfully! Inventory updated.');
                        } else {
                            const errorData = await response.json();
                            this.showError(errorData.message || 'Failed to add medical record');
                        }
                    } catch (error) {
                        console.error('Error adding medical record:', error);
                        this.showError('Network error. Please check your connection and try again.');
                    } finally {
                        this.addingRecord = false;
                    }
                },

                async updateMedicalRecord() {
                    if (!this.editingRecord) {
                        this.showError('No record selected for editing');
                        return;
                    }
                    
                    // Form validation
                    if (!this.editingRecord.chief_complaint && !this.editingRecord.symptoms) {
                        this.showError('Please fill in the reason for visit');
                        return;
                    }
                    
                    if (!this.editingRecord.treatment) {
                        this.showError('Please fill in the treatment');
                        return;
                    }
                    
                    // âœ… VALIDATE MEDICINE AVAILABILITY BEFORE UPDATING
                    if (this.editingRecord.prescribed_medicines && this.editingRecord.prescribed_medicines.length > 0) {
                        const insufficientMedicines = [];
                        
                        console.log('ðŸ” Validating medicines (EDIT):', this.editingRecord.prescribed_medicines);
                        console.log('ðŸ“¦ Available medicines:', this.availableMedicines.map(m => ({id: m.id, name: m.medicine_name, qty: m.quantity})));
                        
                        for (const prescribed of this.editingRecord.prescribed_medicines) {
                            // Find the medicine in available medicines (use == for type coercion)
                            const medicine = this.availableMedicines.find(m => m.id == prescribed.medicine_id);
                            
                            console.log(`ðŸ”Ž Looking for medicine_id: ${prescribed.medicine_id} (${typeof prescribed.medicine_id})`);
                            console.log(`âœ… Found:`, medicine);
                            
                            if (!medicine) {
                                insufficientMedicines.push(`${prescribed.medicine_name}: Medicine not found in inventory`);
                                continue;
                            }
                            
                            const availableQty = medicine.quantity || medicine.quantity_in_stock || 0;
                            const requestedQty = prescribed.quantity || 0;
                            
                            if (requestedQty > availableQty) {
                                insufficientMedicines.push(
                                    `${prescribed.medicine_name}: Requested ${requestedQty} pcs, but only ${availableQty} pcs available`
                                );
                            }
                        }
                        
                        // If there are insufficient medicines, show error and STOP
                        if (insufficientMedicines.length > 0) {
                            const errorMessage = 'âŒ Cannot update medical record - Insufficient medicine stock:\n\n' + 
                                insufficientMedicines.join('\n');
                            this.showError(errorMessage);
                            return; // STOP - Do not proceed
                        }
                    }
                    
                    this.addingRecord = true;
                    
                    try {
                        // Determine patient type and appropriate endpoint
                        const role = this.selectedPatient?.role;
                        const isVisitor = role === 'Visitor';
                        const isTeaching = role === 'Teaching Staff';
                        const isNonTeaching = role === 'Non-Teaching Staff';
                        const isDean = role === 'Dean';
                        const isPresident = role === 'President';
                        
                        let endpoint;
                        
                        if (isVisitor) {
                            endpoint = `/api/update-visitor-medical-record/${this.editingRecord.id}`;
                        } else if (isTeaching) {
                            endpoint = `/api/update-teaching-medical-record/${this.editingRecord.id}`;
                        } else if (isNonTeaching) {
                            endpoint = `/api/update-non-teaching-medical-record/${this.editingRecord.id}`;
                        } else if (isDean) {
                            endpoint = `/api/update-dean-medical-record/${this.editingRecord.id}`;
                        } else if (isPresident) {
                            endpoint = `/api/update-president-medical-record/${this.editingRecord.id}`;
                        } else {
                            endpoint = `/api/update-student-medical-record/${this.editingRecord.id}`;
                        }
                        
                        console.log(`Updating medical record ID: ${this.editingRecord.id}`);
                        
                        // Format prescribed medicines from array to string
                        let prescribedMedicineText = this.editingRecord.prescribed_medicine || '';
                        if (this.editingRecord.prescribed_medicines && this.editingRecord.prescribed_medicines.length > 0) {
                            prescribedMedicineText = this.editingRecord.prescribed_medicines.map(med => {
                                let formatted = med.medicine_name;
                                if (med.quantity > 0) formatted += ` (${med.quantity} pcs)`;
                                if (med.dosage) formatted += ` - ${med.dosage}`;
                                if (med.instructions) formatted += ` - ${med.instructions}`;
                                return formatted;
                            }).join('; ');
                        }
                        
                        const requestBody = {
                            chief_complaint: this.editingRecord.chief_complaint || this.editingRecord.symptoms,
                            symptoms: this.editingRecord.symptoms || this.editingRecord.chief_complaint,
                            treatment: this.editingRecord.treatment,
                            prescribed_medicine: prescribedMedicineText,
                            notes: this.editingRecord.notes,
                            medical_history: this.editingRecord.medical_history,
                            fever_duration: this.editingRecord.fever_duration,
                            current_medication: this.editingRecord.current_medication,
                            medication_schedule: this.editingRecord.medication_schedule,
                            blood_pressure_systolic: this.editingRecord.blood_pressure_systolic,
                            blood_pressure_diastolic: this.editingRecord.blood_pressure_diastolic,
                            pulse_rate: this.editingRecord.pulse_rate,
                            heart_rate: this.editingRecord.heart_rate,
                            temperature: this.editingRecord.temperature,
                            respiratory_rate: this.editingRecord.respiratory_rate,
                            weight: this.editingRecord.weight,
                            height: this.editingRecord.height
                        };
                        
                        const response = await fetch(endpoint, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(requestBody)
                        });
                        
                        if (response.ok) {
                            // Update inventory if medicines were prescribed
                            // Note: This will deduct ALL medicines in the list
                            // Staff should be careful not to edit the same record multiple times
                            // as it will deduct inventory each time
                            if (this.editingRecord.prescribed_medicines && this.editingRecord.prescribed_medicines.length > 0) {
                                console.log('ðŸ’Š Updating inventory for prescribed medicines...');
                                await this.updateInventoryAfterPrescription(this.editingRecord.prescribed_medicines);
                            }
                            
                            // Close all modals first
                            this.showEditRecordModal = false;
                            this.editingRecord = null;
                            this.showViewRecordModal = false;
                            this.viewingRecord = null;
                            
                            // Reload patient records
                            await this.loadPatientRecords(this.selectedPatient.id);
                            
                            // Ensure modals stay closed after reload
                            this.$nextTick(() => {
                                this.showViewRecordModal = false;
                                this.viewingRecord = null;
                            });
                            
                            this.showSuccess('Medical record updated successfully!');
                        } else {
                            const errorData = await response.json();
                            this.showError(errorData.message || 'Failed to update medical record');
                        }
                    } catch (error) {
                        console.error('Error updating medical record:', error);
                        this.showError('Network error. Please check your connection and try again.');
                    } finally {
                        this.addingRecord = false;
                    }
                },

                // Medicine management functions
                addPrescribedMedicine() {
                    this.newRecord.prescribed_medicines.push({
                        medicine_id: '',
                        medicine_name: '',
                        quantity: 1,
                        dosage: '',
                        instructions: ''
                    });
                },

                removePrescribedMedicine(index) {
                    this.newRecord.prescribed_medicines.splice(index, 1);
                },

                updateMedicineName(index, medicineId) {
                    const medicine = this.availableMedicines.find(med => med.id == medicineId);
                    if (medicine) {
                        this.newRecord.prescribed_medicines[index].medicine_name = medicine.medicine_name;
                        this.newRecord.prescribed_medicines[index].medicine_id = medicineId;
                        // Auto-fill dosage if strength is available
                        if (medicine.strength && !this.newRecord.prescribed_medicines[index].dosage) {
                            this.newRecord.prescribed_medicines[index].dosage = medicine.strength;
                        }
                    }
                },

                getMedicineStock(medicineId) {
                    const medicine = this.availableMedicines.find(med => med.id == medicineId);
                    return medicine ? (medicine.quantity || medicine.quantity_in_stock || 0) : 0;
                },

                formatPrescribedMedicines() {
                    if (this.newRecord.prescribed_medicines.length === 0) {
                        return this.newRecord.prescribed_medicine || '';
                    }
                    
                    return this.newRecord.prescribed_medicines.map(med => {
                        let formatted = med.medicine_name;
                        if (med.quantity > 0) formatted += ` (${med.quantity} pcs)`;
                        if (med.dosage) formatted += ` - ${med.dosage}`;
                        if (med.instructions) formatted += ` - ${med.instructions}`;
                        return formatted;
                    }).join('; ');
                },

                async updateInventoryAfterPrescription(prescribedMedicines) {
                    try {
                        console.log('ðŸ”„ Updating inventory for prescribed medicines:', prescribedMedicines);
                        
                        for (const prescribed of prescribedMedicines) {
                            if (prescribed.medicine_id && prescribed.quantity > 0) {
                                console.log(`ðŸ“¦ Reducing ${prescribed.medicine_name} by ${prescribed.quantity} units`);
                                
                                const response = await fetch('/api/medicine/reduce-quantity', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        medicine_id: prescribed.medicine_id,
                                        quantity_used: prescribed.quantity
                                    })
                                });

                                if (response.ok) {
                                    const result = await response.json();
                                    console.log(`âœ… ${result.message}`);
                                } else {
                                    const error = await response.json();
                                    console.error(`âŒ Failed to update inventory for ${prescribed.medicine_name}:`, error.error);
                                    this.showError(`Failed to update inventory for ${prescribed.medicine_name}: ${error.error}`);
                                }
                            }
                        }
                        // Reload medicines to reflect updated quantities
                        console.log('ðŸ”„ Reloading medicine inventory...');
                        await this.loadMedicines();
                        console.log('âœ… Inventory updated successfully');
                    } catch (error) {
                        console.error('âŒ Error updating inventory:', error);
                        this.showError('Failed to update medicine inventory');
                    }
                },

                // Action button functions for medical records
                async viewRecord(record) {
                    try {
                        // Show loading state
                        this.viewingRecord = null;
                        this.showViewRecordModal = true;
                        
                        // Determine the correct endpoint based on patient type
                        const role = this.selectedPatient?.role;
                        const isVisitor = role === 'Visitor';
                        const isTeaching = role === 'Teaching Staff';
                        const isNonTeaching = role === 'Non-Teaching Staff';
                        const isDean = role === 'Dean';
                        const isPresident = role === 'President';
                        
                        let endpoint;
                        if (isVisitor) {
                            endpoint = `/api/visitor-medical-record/${record.id}`;
                        } else if (isTeaching) {
                            endpoint = `/api/teaching-medical-record/${record.id}`;
                        } else if (isNonTeaching) {
                            endpoint = `/api/non-teaching-medical-record/${record.id}`;
                        } else if (isDean) {
                            endpoint = `/api/dean-medical-record/${record.id}`;
                        } else if (isPresident) {
                            endpoint = `/api/president-medical-record/${record.id}`;
                        } else {
                            endpoint = `/api/medical-record/${record.id}`;
                        }
                        
                        console.log(`ðŸ” Viewing ${this.selectedPatient.role} medical record using: ${endpoint}`);
                        
                        // Fetch complete record details from database
                        const response = await fetch(endpoint);
                        if (response.ok) {
                            const fullRecord = await response.json();
                            
                            // Map the complete record data - INCLUDE ALL FIELDS
                            this.viewingRecord = {
                                id: fullRecord.id,
                                visit_date: fullRecord.visit_date,
                                visit_time: fullRecord.visit_time,
                                chief_complaint: fullRecord.chief_complaint || '',
                                symptoms: fullRecord.symptoms || fullRecord.chief_complaint || 'Not specified',
                                treatment: fullRecord.treatment || 'Not specified',
                                prescribed_medicine: fullRecord.prescribed_medicine || 'No medicine prescribed',
                                // Medical History fields
                                medical_history: fullRecord.medical_history || '',
                                fever_duration: fullRecord.fever_duration || '',
                                current_medication: fullRecord.current_medication || '',
                                medication_schedule: fullRecord.medication_schedule || '',
                                // Vital Signs
                                blood_pressure: fullRecord.blood_pressure || '',
                                blood_pressure_systolic: fullRecord.blood_pressure_systolic || '',
                                blood_pressure_diastolic: fullRecord.blood_pressure_diastolic || '',
                                pulse_rate: fullRecord.pulse_rate || '',
                                temperature: fullRecord.temperature || '',
                                respiratory_rate: fullRecord.respiratory_rate || '',
                                heart_rate: fullRecord.heart_rate || fullRecord.pulse_rate || '',
                                // Physical Measurements
                                weight: fullRecord.weight || '',
                                height: fullRecord.height || '',
                                bmi: fullRecord.bmi || '',
                                // Procedures
                                dental_procedure: fullRecord.dental_procedure || '',
                                procedure_notes: fullRecord.procedure_notes || '',
                                follow_up_date: fullRecord.follow_up_date || '',
                                special_instructions: fullRecord.special_instructions || '',
                                notes: fullRecord.notes || '',
                                doctor_name: fullRecord.doctor_name || 'Unknown Doctor',
                                // Clinic stay information
                                will_stay_in_clinic: fullRecord.will_stay_in_clinic || false,
                                stay_reason: fullRecord.stay_reason || '',
                                stay_status: fullRecord.stay_status || 'not_staying'
                            };
                        } else {
                            // Fallback to basic record data if API fails
                            this.viewingRecord = record;
                            console.warn('Failed to fetch complete record details, using basic data');
                        }
                        
                        // Initialize Feather icons after modal content is loaded
                        this.$nextTick(() => {
                            if (typeof feather !== 'undefined') {
                                try {
                                    feather.replace();
                                    console.log('âœ… Feather icons initialized for view modal');
                                } catch (error) {
                                    console.warn('Feather icons initialization warning:', error);
                                }
                            }
                        });
                    } catch (error) {
                        console.error('Error fetching record details:', error);
                        // Fallback to basic record data
                        this.viewingRecord = record;
                        
                        // Initialize Feather icons even on error
                        this.$nextTick(() => {
                            if (typeof feather !== 'undefined') {
                                try {
                                    feather.replace();
                                } catch (error) {
                                    console.warn('Feather icons initialization warning:', error);
                                }
                            }
                        });
                    }
                },

                editRecord(record) {
                    // Always open edit modal regardless of stay status
                    // (Discharge is now handled by separate "Discharge Patient" button)
                    this.editingRecord = { ...record };
                    
                    // Initialize prescribed_medicines array if it doesn't exist
                    if (!this.editingRecord.prescribed_medicines) {
                        this.editingRecord.prescribed_medicines = [];
                    }
                    
                    // Ensure all fields have default values to prevent undefined errors
                    this.editingRecord.chief_complaint = this.editingRecord.chief_complaint || this.editingRecord.symptoms || '';
                    this.editingRecord.symptoms = this.editingRecord.symptoms || this.editingRecord.chief_complaint || '';
                    this.editingRecord.treatment = this.editingRecord.treatment || '';
                    this.editingRecord.prescribed_medicine = this.editingRecord.prescribed_medicine || '';
                    this.editingRecord.notes = this.editingRecord.notes || '';
                    this.editingRecord.medical_history = this.editingRecord.medical_history || '';
                    this.editingRecord.fever_duration = this.editingRecord.fever_duration || '';
                    this.editingRecord.current_medication = this.editingRecord.current_medication || '';
                    this.editingRecord.medication_schedule = this.editingRecord.medication_schedule || '';
                    
                    console.log('ðŸ“ Editing Record:', this.editingRecord);
                    
                    this.showEditRecordModal = true;
                    // Don't close view modal, just hide it (keep in background)
                    // this.showViewRecordModal = false; // Commented out - keep view modal in background
                    
                    // Re-initialize Feather icons after modal opens
                    this.$nextTick(() => {
                        if (typeof feather !== 'undefined') {
                            try {
                                feather.replace();
                            } catch (error) {
                                console.warn('Feather icons initialization warning:', error);
                            }
                        }
                    });
                },

                deleteRecord(record) {
                    this.deletingRecord = record;
                    this.showDeleteConfirmModal = true;
                },

                async confirmDeleteRecord() {
                    if (!this.deletingRecord) return;
                    
                    try {
                        // Determine the correct delete endpoint based on patient type/role
                        const patientRole = this.selectedPatient ? this.selectedPatient.role : '';
                        let endpoint;
                        
                        // Map patient roles to their respective delete endpoints
                        switch(patientRole) {
                            case 'Visitor':
                                endpoint = `/api/delete-visitor-medical-record/${this.deletingRecord.id}`;
                                break;
                            case 'Teaching Staff':
                                endpoint = `/api/delete-teaching-medical-record/${this.deletingRecord.id}`;
                                break;
                            case 'Non-Teaching Staff':
                                endpoint = `/api/delete-non-teaching-medical-record/${this.deletingRecord.id}`;
                                break;
                            case 'Dean':
                                endpoint = `/api/delete-dean-medical-record/${this.deletingRecord.id}`;
                                break;
                            case 'President':
                                endpoint = `/api/delete-president-medical-record/${this.deletingRecord.id}`;
                                break;
                            case 'Student':
                            default:
                                endpoint = `/api/delete-medical-record/${this.deletingRecord.id}`;
                                break;
                        }
                        
                        console.log(`ðŸ—‘ï¸ Deleting ${patientRole} medical record using: ${endpoint}`);
                        
                        const response = await fetch(endpoint, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json',
                            }
                        });

                        if (response.ok) {
                            // Remove the record from the current patient's records
                            if (this.selectedPatient && this.selectedPatient.medical_records) {
                                this.selectedPatient.medical_records = this.selectedPatient.medical_records.filter(
                                    record => record.id !== this.deletingRecord.id
                                );
                            }
                            
                            // Close modal and reset
                            this.showDeleteConfirmModal = false;
                            this.deletingRecord = null;
                            
                            // Show success message
                            this.showSuccess(`${patientRole} medical record deleted successfully!`);
                        } else {
                            const error = await response.json();
                            this.showError('Error deleting record: ' + (error.error || 'Unknown error'));
                        }
                    } catch (error) {
                        console.error('Error deleting medical record:', error);
                        this.showError('Error deleting record. Please try again.');
                    }
                },

                cancelDeleteRecord() {
                    this.showDeleteConfirmModal = false;
                    this.deletingRecord = null;
                },

                showSuccess(message) {
                    // Create and show success notification
                    const notification = document.createElement('div');
                    notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300';
                    notification.innerHTML = `
                        <div class="flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            <span>${message}</span>
                        </div>
                    `;
                    document.body.appendChild(notification);
                    
                    // Animate in
                    setTimeout(() => notification.classList.remove('translate-x-full'), 100);
                    
                    // Remove after 3 seconds
                    setTimeout(() => {
                        notification.classList.add('translate-x-full');
                        setTimeout(() => document.body.removeChild(notification), 300);
                    }, 3000);
                },

                showError(message) {
                    // Create and show error notification
                    const notification = document.createElement('div');
                    notification.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300';
                    notification.innerHTML = `
                        <div class="flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            <span>${message}</span>
                        </div>
                    `;
                    document.body.appendChild(notification);
                    
                    // Animate in
                    setTimeout(() => notification.classList.remove('translate-x-full'), 100);
                    
                    // Remove after 4 seconds
                    setTimeout(() => {
                        notification.classList.add('translate-x-full');
                        setTimeout(() => document.body.removeChild(notification), 300);
                    }, 4000);
                },

                async addVisitor() {
                    // Validate required fields
                    if (!this.newVisitor.first_name || !this.newVisitor.last_name || !this.newVisitor.age || !this.newVisitor.contact_number) {
                        this.showError('Please fill in all required fields (First Name, Last Name, Age, Contact Number)');
                        return;
                    }

                    this.addingVisitor = true;

                    try {
                        // First, check for duplicate names across all patient types
                        const checkResponse = await fetch('/api/check-duplicate-patient', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                first_name: this.newVisitor.first_name,
                                middle_name: this.newVisitor.middle_name || '',
                                last_name: this.newVisitor.last_name
                            })
                        });

                        if (checkResponse.ok) {
                            const checkResult = await checkResponse.json();
                            
                            if (checkResult.has_duplicates) {
                                // Found duplicates - show confirmation modal
                                console.log('ðŸ” Found duplicate patients:', checkResult.duplicates);
                                this.duplicatePatients = checkResult.duplicates;
                                this.pendingVisitorData = { ...this.newVisitor };
                                this.showAddVisitorModal = false;
                                this.showDuplicateConfirmModal = true;
                                this.addingVisitor = false;
                                return;
                            }
                        }

                        // No duplicates found, proceed with adding visitor
                        await this.proceedWithAddingVisitor();
                        
                    } catch (error) {
                        console.error('Error checking duplicates:', error);
                        // If duplicate check fails, proceed anyway
                        await this.proceedWithAddingVisitor();
                    }
                },

                async proceedWithAddingVisitor() {
                    try {
                        const visitorData = this.pendingVisitorData || this.newVisitor;
                        
                        const response = await fetch('/api/visitors', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                first_name: visitorData.first_name,
                                middle_name: visitorData.middle_name || '',
                                last_name: visitorData.last_name,
                                age: parseInt(visitorData.age),
                                contact_number: visitorData.contact_number
                            })
                        });

                        if (response.ok) {
                            const result = await response.json();
                            
                            // Reset form and states
                            this.newVisitor = {
                                first_name: '',
                                middle_name: '',
                                last_name: '',
                                age: '',
                                contact_number: ''
                            };
                            this.pendingVisitorData = null;
                            this.duplicatePatients = [];
                            
                            this.showAddVisitorModal = false;
                            this.showDuplicateConfirmModal = false;
                            
                            // Reload patients list to include new visitor
                            await this.loadStudentsFromDatabase();
                            this.filterPatients();
                            
                            this.showSuccess('Visitor added successfully!');
                        } else {
                            const errorData = await response.json();
                            this.showError(errorData.message || 'Failed to add visitor');
                        }
                    } catch (error) {
                        console.error('Error adding visitor:', error);
                        this.showError('Network error. Please check your connection and try again.');
                    } finally {
                        this.addingVisitor = false;
                    }
                },

                cancelAddVisitor() {
                    this.showDuplicateConfirmModal = false;
                    this.showAddVisitorModal = true;
                    this.pendingVisitorData = null;
                    this.duplicatePatients = [];
                    this.addingVisitor = false;
                },

                // Clinic Stay Management Functions
                async loadClinicStays() {
                    try {
                        const response = await fetch('/api/current-clinic-stays');
                        if (response.ok) {
                            this.currentStays = await response.json();
                            this.clinicStays = this.currentStays; // For now, show current stays
                        } else {
                            console.error('Failed to load clinic stays');
                        }
                    } catch (error) {
                        console.error('Error loading clinic stays:', error);
                    }
                },

                openClinicStayModal(record) {
                    // Pre-fill clinic stay form with medical record data
                    console.log('ðŸ¥ Opening clinic stay modal with record:', record);
                    console.log('ðŸ¥ Selected patient:', this.selectedPatient);
                    
                    // Get patient name from selectedPatient first, then fallback to record
                    let patientName = '';
                    if (this.selectedPatient && this.selectedPatient.name) {
                        patientName = this.selectedPatient.name;
                    } else if (record.patient_name) {
                        patientName = record.patient_name;
                    } else if (record.std_Firstname && record.std_Surname) {
                        patientName = `${record.std_Firstname} ${record.std_Surname}`;
                    } else if (record.first_name && record.last_name) {
                        patientName = `${record.first_name} ${record.last_name}`;
                    } else {
                        patientName = 'Unknown Patient';
                    }
                    
                    console.log('ðŸ¥ Constructed patient name:', patientName);
                    
                    this.newClinicStay = {
                        medical_record_id: record.id,
                        student_number: record.student_number || this.selectedPatient?.identifier || record.patient_id,
                        patient_name: patientName,
                        stay_reason: `Rest/observation after ${record.chief_complaint || record.symptoms || 'medical consultation'}`
                    };
                    
                    console.log('ðŸ¥ Clinic stay data prepared:', this.newClinicStay);
                    this.showClinicStayModal = true;
                },

                async createClinicStay() {
                    if (!this.newClinicStay.stay_reason || this.newClinicStay.stay_reason.trim() === '') {
                        this.showError('Please specify the reason for clinic stay');
                        return;
                    }

                    console.log('ðŸš€ Sending clinic stay data to API:', this.newClinicStay);

                    try {
                        const response = await fetch('/api/clinic-stays', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(this.newClinicStay)
                        });

                        if (response.ok) {
                            this.showClinicStayModal = false;
                            await this.loadClinicStays();
                            
                            // Update the viewing record to reflect the new stay status
                            if (this.viewingRecord && this.viewingRecord.id === this.newClinicStay.medical_record_id) {
                                this.viewingRecord.stay_status = 'staying';
                                console.log('ðŸ¥ Updated viewingRecord stay_status to: staying');
                            }
                            
                            // Reload patient data to get updated information
                            await this.loadPatients();
                            
                            // Refresh patient records to update the admission time display
                            if (this.selectedPatient) {
                                // Small delay to ensure database transaction is committed
                                await new Promise(resolve => setTimeout(resolve, 500));
                                await this.loadPatientRecords(this.selectedPatient.id);
                            }
                            
                            this.showSuccess('Patient admitted to clinic successfully!');
                        } else {
                            const error = await response.json();
                            this.showError(error.error || 'Failed to create clinic stay');
                        }
                    } catch (error) {
                        console.error('Error creating clinic stay:', error);
                        this.showError('Network error. Please try again.');
                    }
                },

                openCheckoutModal(stay) {
                    this.selectedStay = stay;
                    this.checkoutData.checkout_notes = '';
                    this.showCheckoutModal = true;
                },

                async checkoutPatient() {
                    if (!this.selectedStay) return;

                    try {
                        // Determine the correct checkout endpoint based on patient type
                        const role = this.selectedPatient?.role;
                        const isVisitor = role === 'Visitor';
                        const isTeaching = role === 'Teaching Staff';
                        const isNonTeaching = role === 'Non-Teaching Staff';
                        const isDean = role === 'Dean';
                        const isPresident = role === 'President';
                        
                        let endpoint;
                        if (isVisitor) {
                            endpoint = `/api/visitor-medical-records/${this.selectedStay.id}/checkout`;
                        } else if (isTeaching) {
                            endpoint = `/api/teaching-medical-records/${this.selectedStay.id}/checkout`;
                        } else if (isNonTeaching) {
                            endpoint = `/api/non-teaching-medical-records/${this.selectedStay.id}/checkout`;
                        } else if (isDean) {
                            endpoint = `/api/dean-medical-records/${this.selectedStay.id}/checkout`;
                        } else if (isPresident) {
                            endpoint = `/api/president-medical-records/${this.selectedStay.id}/checkout`;
                        } else {
                            endpoint = `/api/medical-records/${this.selectedStay.id}/checkout`;
                        }
                        
                        console.log(`ðŸ¥ Discharging ${this.selectedPatient.role} using endpoint: ${endpoint}`);
                        
                        const response = await fetch(endpoint, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(this.checkoutData)
                        });

                        if (response.ok) {
                            this.showCheckoutModal = false;
                            await this.loadClinicStays();
                            
                            // Update the viewing record to reflect the checkout
                            if (this.viewingRecord && this.viewingRecord.id === this.selectedStay.id) {
                                this.viewingRecord.stay_status = 'checked_out';
                                console.log('ðŸ¥ Updated viewingRecord stay_status to: checked_out');
                            }
                            
                            // Refresh patient records to update the view
                            if (this.selectedPatient) {
                                await this.loadPatientRecords(this.selectedPatient.id);
                            }
                            
                            // Reload all patient data to get updated information
                            await this.loadPatients();
                            
                            this.showSuccess('Patient discharged successfully!');
                        } else {
                            const error = await response.json();
                            this.showError(error.error || 'Failed to discharge patient');
                        }
                    } catch (error) {
                        console.error('Error discharging patient:', error);
                        this.showError('Network error. Please try again.');
                    }
                },


                formatDateTime(dateTimeString) {
                    if (!dateTimeString) return 'Not set';
                    const date = new Date(dateTimeString);
                    return date.toLocaleString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: true
                    });
                },

                // Get initials from full name
                getInitials(name) {
                    if (!name) return '??';
                    const parts = name.trim().split(' ');
                    if (parts.length === 1) {
                        return parts[0].substring(0, 2).toUpperCase();
                    }
                    return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
                },

                // Format date as "June 10, 2025"
                formatAdmissionDate(dateTimeString) {
                    if (!dateTimeString) return '';
                    const date = new Date(dateTimeString);
                    return date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                },

                // Format time as "12-1 HR" (12-hour format with AM/PM)
                formatAdmissionTime(dateTimeString) {
                    if (!dateTimeString) return '';
                    const date = new Date(dateTimeString);
                    const hours = date.getHours();
                    const minutes = date.getMinutes();
                    const ampm = hours >= 12 ? 'PM' : 'AM';
                    const displayHours = hours % 12 || 12; // Convert to 12-hour format
                    const displayMinutes = minutes.toString().padStart(2, '0');
                    return `${displayHours}-${displayMinutes} ${ampm}`;
                },

                getStayDuration(checkInTime, checkOutTime = null) {
                    const start = new Date(checkInTime);
                    const end = checkOutTime ? new Date(checkOutTime) : new Date();
                    const diffMs = end - start;
                    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                    const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                    
                    if (diffHours > 0) {
                        return `${diffHours}h ${diffMinutes}m`;
                    } else {
                        return `${diffMinutes}m`;
                    }
                },

                // Print Report Functions
                openPrintReportModal() {
                    if (!this.selectedPatient) {
                        this.showError('Please select a patient first');
                        return;
                    }
                    
                    // Ensure medical records are loaded
                    if (!this.selectedPatient.medical_records) {
                        console.log('Loading medical records for patient:', this.selectedPatient.name);
                        this.loadPatientRecords(this.selectedPatient.id).then(() => {
                            this.showPrintReportModal = true;
                        });
                    } else {
                        this.showPrintReportModal = true;
                    }
                },

                selectRecordForPrint(record) {
                    this.selectedRecordForPrint = record;
                    this.showPrintReportModal = false;
                    this.showPrintPreviewModal = true;
                },

                printRecordCertificate(record) {
                    if (!this.selectedPatient) {
                        this.showError('Please select a patient first');
                        return;
                    }
                    
                    // Store the record for printing and show reason modal
                    this.selectedRecordForPrint = record;
                    this.printReason = '';
                    this.showPrintReasonModal = true;
                },

                async confirmPrintWithReason() {
                    if (!this.printReason.trim()) {
                        this.showError('Please provide a reason for printing');
                        return;
                    }
                    
                    if (!this.selectedRecordForPrint) {
                        this.showError('No record selected for printing');
                        return;
                    }
                    
                    try {
                        this.printingCertificate = true;
                        this.generatingPdfPreview = true;
                        this.showPrintReasonModal = false;
                        
                        // Show preview modal immediately with loading state
                        this.showPdfPreviewModal = true;
                        
                        // Generate PDF and show preview
                        await this.generatePdfPreview(this.selectedRecordForPrint, this.printReason);
                        
                    } catch (error) {
                        console.error('Error generating certificate:', error);
                        this.showError('Failed to generate certificate');
                        this.showPdfPreviewModal = false;
                    } finally {
                        this.printingCertificate = false;
                        this.generatingPdfPreview = false;
                    }
                },

                async generateDocxFromTemplate(record, reason = 'Medical consultation and healthcare services') {
                    try {
                        // Debug: Check record data
                        console.log('Record data:', record);
                        console.log('Visit time:', record.visit_time);
                        console.log('Time field:', record.time);
                        
                        // Format time properly - handle different time formats
                        let formattedTime = 'N/A';
                        if (record.visit_time) {
                            // If visit_time is a time string like "14:30:00"
                            formattedTime = this.formatTime12Hour(record.visit_time);
                        } else if (record.time) {
                            // If time is already formatted
                            formattedTime = record.time;
                        } else if (record.created_at) {
                            // Fallback to created_at time
                            formattedTime = this.formatTime(record.created_at);
                        }
                        
                        // Construct patient name from available data
                        let patientName = '';
                        if (record.patient_name) {
                            patientName = record.patient_name;
                        } else if (record.std_Firstname && record.std_Surname) {
                            patientName = `${record.std_Firstname} ${record.std_Surname}`;
                        } else if (record.first_name && record.last_name) {
                            patientName = `${record.first_name} ${record.last_name}`;
                        } else if (this.selectedPatient && this.selectedPatient.name) {
                            patientName = this.selectedPatient.name;
                        } else {
                            patientName = 'Unknown Patient';
                        }
                        
                        // Prepare data for the template
                        const templateData = {
                            name: patientName,
                            visit_date: this.formatDate(record.visit_date || record.date),
                            time: formattedTime,
                            issued_date: this.getCurrentDate(),
                            purpose: reason,
                            patient_type: this.selectedPatient?.role || 'Student'
                        };
                        
                        console.log('Template data being sent:', templateData);

                        // Call Flask backend to generate DOCX
                        const response = await fetch('/generate-medical-letter', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(templateData)
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        // Get the blob from response
                        const blob = await response.blob();
                        
                        // Create download link
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `Medical_Certificate_${this.selectedPatient.name.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.docx`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                        
                        this.showSuccess('Certificate generated successfully!');
                        
                    } catch (error) {
                        console.error('Error calling Flask backend:', error);
                        this.showError('Failed to generate certificate. Make sure Flask server is running.');
                    }
                },

                async generatePdfPreview(record, reason = 'Medical consultation and healthcare services') {
                    try {
                        // Format time properly
                        let formattedTime = 'N/A';
                        if (record.visit_time) {
                            formattedTime = this.formatTime12Hour(record.visit_time);
                        } else if (record.time) {
                            formattedTime = record.time;
                        } else if (record.created_at) {
                            formattedTime = this.formatTime(record.created_at);
                        }
                        
                        // Construct patient name
                        let patientName = '';
                        if (record.patient_name) {
                            patientName = record.patient_name;
                        } else if (record.std_Firstname && record.std_Surname) {
                            patientName = `${record.std_Firstname} ${record.std_Surname}`;
                        } else if (record.first_name && record.last_name) {
                            patientName = `${record.first_name} ${record.last_name}`;
                        } else if (this.selectedPatient && this.selectedPatient.name) {
                            patientName = this.selectedPatient.name;
                        } else {
                            patientName = 'Unknown Patient';
                        }
                        
                        // Prepare data for the template
                        const templateData = {
                            name: patientName,
                            visit_date: this.formatDate(record.visit_date || record.date),
                            time: formattedTime,
                            issued_date: this.getCurrentDate(),
                            purpose: reason,
                            patient_type: this.selectedPatient?.role || 'Student'
                        };
                        
                        console.log('ðŸ” Generating PDF with data:', templateData);

                        // Call Flask backend to generate PDF
                        const response = await fetch('/generate-medical-letter-pdf', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(templateData)
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        // Get the blob from response
                        const blob = await response.blob();
                        this.currentPdfBlob = blob;
                        
                        // Create preview URL
                        if (this.pdfPreviewUrl) {
                            window.URL.revokeObjectURL(this.pdfPreviewUrl);
                        }
                        this.pdfPreviewUrl = window.URL.createObjectURL(blob);
                        
                        // Preview modal already shown, just update the URL
                        this.generatingPdfPreview = false;
                        
                    } catch (error) {
                        console.error('âŒ Error generating PDF preview:', error);
                        this.showError('Failed to generate PDF preview. Make sure Flask server is running.');
                    }
                },

                downloadPdfFromPreview() {
                    if (!this.currentPdfBlob) {
                        this.showError('No PDF available to download');
                        return;
                    }
                    
                    const url = window.URL.createObjectURL(this.currentPdfBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Medical_Certificate_${this.selectedPatient.name.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    this.showSuccess('PDF downloaded successfully!');
                },

                printPdfFromPreview() {
                    if (!this.pdfPreviewUrl) {
                        this.showError('No PDF available to print');
                        return;
                    }
                    
                    // Open print dialog for the PDF
                    const printWindow = window.open(this.pdfPreviewUrl);
                    if (printWindow) {
                        printWindow.addEventListener('load', () => {
                            printWindow.print();
                        });
                    }
                },

                closePdfPreview() {
                    this.showPdfPreviewModal = false;
                    if (this.pdfPreviewUrl) {
                        window.URL.revokeObjectURL(this.pdfPreviewUrl);
                        this.pdfPreviewUrl = null;
                    }
                    this.currentPdfBlob = null;
                    this.selectedRecordForPrint = null;
                    this.printReason = '';
                },

                async generatePdfFromTemplate(record) {
                    try {
                        // Format time properly - handle different time formats
                        let formattedTime = 'N/A';
                        if (record.visit_time) {
                            formattedTime = this.formatTime12Hour(record.visit_time);
                        } else if (record.time) {
                            formattedTime = record.time;
                        } else if (record.created_at) {
                            formattedTime = this.formatTime(record.created_at);
                        }
                        
                        // Construct patient name from available data
                        let patientName = '';
                        if (record.patient_name) {
                            patientName = record.patient_name;
                        } else if (record.std_Firstname && record.std_Surname) {
                            patientName = `${record.std_Firstname} ${record.std_Surname}`;
                        } else if (record.first_name && record.last_name) {
                            patientName = `${record.first_name} ${record.last_name}`;
                        } else if (this.selectedPatient && this.selectedPatient.name) {
                            patientName = this.selectedPatient.name;
                        } else {
                            patientName = 'Unknown Patient';
                        }
                        
                        // Prepare data for the template
                        const templateData = {
                            name: patientName,
                            visit_date: this.formatDate(record.visit_date || record.date),
                            time: formattedTime,
                            issued_date: this.getCurrentDate(),
                            purpose: 'medical consultation and healthcare services'
                        };

                        // Call Flask backend to generate PDF
                        const response = await fetch('/generate-medical-letter-pdf', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(templateData)
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        // Get the blob from response
                        const blob = await response.blob();
                        
                        // Create download link
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `Medical_Certificate_${this.selectedPatient.name.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                        
                        this.showSuccess('PDF certificate generated successfully!');
                        
                    } catch (error) {
                        console.error('Error generating PDF:', error);
                        this.showError('Failed to generate PDF certificate.');
                    }
                },

                printCertificate() {
                    window.print();
                },

                getCurrentDate() {
                    const now = new Date();
                    return now.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                },

                formatVisitDateTime(record) {
                    if (!record.visit_date) return 'N/A';
                    const date = new Date(record.visit_date);
                    const time = record.visit_time || '00:00';
                    return `${date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    })} at ${this.formatTime12Hour(time)}`;
                },

                formatTime12Hour(time24) {
                    if (!time24) return 'N/A';
                    const [hours, minutes] = time24.split(':');
                    const hour = parseInt(hours);
                    const ampm = hour >= 12 ? 'PM' : 'AM';
                    const hour12 = hour % 12 || 12;
                    return `${hour12}:${minutes} ${ampm}`;
                },

                // Insurance Management Functions
                async loadInsuranceData() {
                    this.loadingInsurance = true;
                    try {
                        // Load insurance status data
                        const response = await fetch('/api/students/insurance-status');
                        if (response.ok) {
                            this.insuranceData = await response.json();
                            console.log('Loaded insurance data:', this.insuranceData.length, 'students');
                            console.log('ðŸ“‹ Sample insurance data:', this.insuranceData.slice(0, 3));
                        } else {
                            console.error('Failed to load insurance data:', response.status, response.statusText);
                        }

                        // Load summary statistics
                        const summaryResponse = await fetch('/api/students/insurance-summary');
                        if (summaryResponse.ok) {
                            this.insuranceSummary = await summaryResponse.json();
                            console.log('Loaded insurance summary:', this.insuranceSummary);
                        }
                    } catch (error) {
                        console.error('Error loading insurance data:', error);
                        alert('Failed to load insurance data. Please try again.');
                    } finally {
                        this.loadingInsurance = false;
                    }
                },

                getFilteredInsuranceData() {
                    // Ensure insuranceData exists and is an array
                    if (!this.insuranceData || !Array.isArray(this.insuranceData) || this.insuranceData.length === 0) {
                        return [];
                    }
                    
                    let filtered = this.insuranceData;
                    
                    // Filter by payment status
                    if (this.insuranceFilter === 'paid') {
                        filtered = filtered.filter(student => student.insurance_paid === 'paid');
                    } else if (this.insuranceFilter === 'unpaid') {
                        filtered = filtered.filter(student => student.insurance_paid === 'unpaid');
                    } else if (this.insuranceFilter === 'first-year') {
                        filtered = filtered.filter(student => student.is_first_year === true);
                    }
                    
                    // Filter by department (course)
                    if (this.insuranceDepartmentFilter !== 'all') {
                        filtered = filtered.filter(student => student.course === this.insuranceDepartmentFilter);
                    }
                    
                    // Filter by section
                    if (this.insuranceSectionFilter !== 'all') {
                        filtered = filtered.filter(student => student.section === this.insuranceSectionFilter);
                    }
                    
                    console.log('âœ… Filtered result:', {
                        filteredCount: filtered.length,
                        firstFiltered: filtered[0]
                    });
                    
                    return filtered;
                },

                openPaymentModal(student) {
                    this.selectedStudent = student;
                    this.paymentForm = {
                        insurance_paid: student.insurance_paid || 'unpaid',
                        insurance_amount: student.insurance_amount || 50.00,
                        insurance_payment_date: student.insurance_payment_date || new Date().toISOString().split('T')[0],
                        insurance_notes: student.insurance_notes || ''
                    };
                    this.showPaymentModal = true;
                },

                async updateInsurancePayment() {
                    if (!this.selectedStudent) return;
                    
                    try {
                        const response = await fetch(`/api/students/${this.selectedStudent.student_number}/insurance-payment`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(this.paymentForm)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            
                            // Update the local data
                            const studentIndex = this.insuranceData.findIndex(s => s.student_number === this.selectedStudent.student_number);
                            if (studentIndex !== -1) {
                                this.insuranceData[studentIndex] = {
                                    ...this.insuranceData[studentIndex],
                                    ...this.paymentForm
                                };
                            }
                            
                            // Reload summary
                            await this.loadInsuranceSummary();
                            
                            this.showPaymentModal = false;
                            this.selectedStudent = null;
                            
                            alert(`Insurance payment status updated successfully for ${this.selectedStudent?.full_name || 'student'}!`);
                        } else {
                            const error = await response.json();
                            alert(`Failed to update payment status: ${error.error || 'Unknown error'}`);
                        }
                    } catch (error) {
                        console.error('Error updating insurance payment:', error);
                        alert('Error updating payment status. Please try again.');
                    }
                },

                async loadInsuranceSummary() {
                    try {
                        const response = await fetch('/api/students/insurance-summary');
                        if (response.ok) {
                            this.insuranceSummary = await response.json();
                        }
                    } catch (error) {
                        console.error('Error loading insurance summary:', error);
                    }
                },

                // Archive Management Functions
                async loadArchivedPatients() {
                    this.loadingArchive = true;
                    try {
                        const response = await fetch('/api/archived-patients');
                        if (response.ok) {
                            this.archivedPatients = await response.json();
                            console.log('ðŸ“¦ Loaded archived patients:', this.archivedPatients.length);
                        } else {
                            console.error('Failed to load archived patients:', response.status);
                            alert('Failed to load archived patients. Please try again.');
                        }
                    } catch (error) {
                        console.error('Error loading archived patients:', error);
                        alert('Failed to load archived patients. Please try again.');
                    } finally {
                        this.loadingArchive = false;
                    }
                },

                getFilteredArchivedPatients() {
                    if (!this.archivedPatients || this.archivedPatients.length === 0) {
                        return [];
                    }

                    let filtered = this.archivedPatients;

                    // Filter by role
                    if (this.archiveFilter !== 'all') {
                        filtered = filtered.filter(patient => {
                            switch(this.archiveFilter) {
                                case 'students': return patient.role === 'Student';
                                case 'teaching': return patient.role === 'Teaching Staff';
                                case 'non-teaching': return patient.role === 'Non-Teaching Staff';
                                case 'deans': return patient.role === 'Dean';
                                case 'visitors': return patient.role === 'Visitor';
                                default: return true;
                            }
                        });
                    }

                    // Filter by search query (ID or Name)
                    if (this.archiveSearchQuery.trim() !== '') {
                        const query = this.archiveSearchQuery.toLowerCase().trim();
                        filtered = filtered.filter(patient => {
                            const name = (patient.name || '').toLowerCase();
                            const identifier = (patient.identifier || '').toLowerCase();
                            return name.includes(query) || identifier.includes(query);
                        });
                    }

                    // Filter by year
                    if (this.archiveYearFilter !== 'all') {
                        filtered = filtered.filter(patient => {
                            if (!patient.archived_date || patient.archived_date === 'N/A') {
                                return false;
                            }
                            // Extract year from archived_date (e.g., "October 20, 2025" -> "2025")
                            const yearMatch = patient.archived_date.match(/\d{4}/);
                            if (yearMatch) {
                                return yearMatch[0] === this.archiveYearFilter;
                            }
                            return false;
                        });
                    }

                    return filtered;
                },

                getAvailableArchiveYears() {
                    if (!this.archivedPatients || this.archivedPatients.length === 0) {
                        return [];
                    }

                    const years = new Set();
                    this.archivedPatients.forEach(patient => {
                        if (patient.archived_date && patient.archived_date !== 'N/A') {
                            const yearMatch = patient.archived_date.match(/\d{4}/);
                            if (yearMatch) {
                                years.add(yearMatch[0]);
                            }
                        }
                    });

                    return Array.from(years).sort((a, b) => b - a); // Sort descending (newest first)
                },

                async archivePatient(patient) {
                    if (!confirm(`Are you sure you want to archive ${patient.name}? They will be moved to the archive.`)) {
                        return;
                    }

                    try {
                        const response = await fetch(`/api/archive-patient/${patient.id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });

                        if (response.ok) {
                            alert(`${patient.name} has been archived successfully.`);
                            // Reload patients list
                            await this.loadPatients();
                        } else {
                            alert('Failed to archive patient. Please try again.');
                        }
                    } catch (error) {
                        console.error('Error archiving patient:', error);
                        alert('Failed to archive patient. Please try again.');
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-white transition-colors duration-200" 
      x-data="{
          sidebarCollapsed: false,
          mobileMenuOpen: false,
          isMobile: false,
          userDropdown: false,
          sidebarHovered: false,
          ...patientsDirectory(),
          handleResize() {
              this.isMobile = window.innerWidth < 768;
              if (this.isMobile) {
                  this.sidebarCollapsed = true;
                  this.mobileMenuOpen = false;
              } else {
                  this.sidebarCollapsed = false;
                  this.mobileMenuOpen = false;
              }
          },
          toggleMobileMenu() {
              if (this.isMobile) {
                  this.mobileMenuOpen = !this.mobileMenuOpen;
              }
          }
      }"
      x-init="
          initPatients();
          handleResize();
          window.addEventListener('resize', () => handleResize());
      ">
    
    <div class="flex h-screen overflow-hidden">
        <!-- Mobile Overlay -->
        <div class="mobile-overlay md:hidden" 
             :class="{ 'active': mobileMenuOpen }"
             @click="mobileMenuOpen = false"></div>

        <!-- Sidebar -->
        <aside :class="[
                   sidebarCollapsed ? 'w-20' : 'w-64',
                   isMobile && mobileMenuOpen ? 'translate-x-0' : '',
                   isMobile && !mobileMenuOpen ? '-translate-x-full' : ''
               ]" 
               class="fixed left-0 top-0 h-screen gradient-bg-sidebar text-white transition-all duration-300 shadow-2xl z-40"
               @mouseenter="sidebarHovered = true"
               @mouseleave="sidebarHovered = false">
        
            <!-- Logo -->
            <div class="relative p-6">
                <div class="flex items-center gap-3" :class="sidebarCollapsed && !sidebarHovered ? 'justify-center' : ''">
                    <div class="flex items-center justify-center">
                        <img src="../assets/img/iclinic-logo.png" alt="Norzagaray College" class="w-14 h-14 object-contain">
                    </div>
                    <div x-show="!sidebarCollapsed || sidebarHovered" x-transition>
                        <h1 class="text-xl font-bold text-white">iClinic</h1>
                        <p class="text-xs text-yellow-300">Norzagaray College</p>
                    </div>
                </div>
            </div>
            
            <!-- Navigation -->
            <nav class="relative mt-8 px-4 space-y-2">
                <!-- Dashboard -->
                <a href="{{ url_for('staff_dashboard') }}"
                   class="flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all group hover:bg-white/10">
                    <div class="flex items-center justify-center" :class="sidebarCollapsed && !sidebarHovered ? 'w-full' : ''">
                        <i data-feather="home" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                    </div>
                    <span x-show="!sidebarCollapsed || sidebarHovered" x-transition class="font-medium">Dashboard</span>
                </a>
                
                <!-- Patients -->
                <a href="{{ url_for('staff_patients') }}"
                   class="sidebar-item-active flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all group">
                    <div class="flex items-center justify-center" :class="sidebarCollapsed && !sidebarHovered ? 'w-full' : ''">
                        <i data-feather="users" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                    </div>
                    <span x-show="!sidebarCollapsed || sidebarHovered" x-transition class="font-medium">Patients</span>
                </a>
                
                <!-- Appointments -->
                <a href="{{ url_for('staff_appointments') }}"
                   class="flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all group hover:bg-white/10">
                    <div class="flex items-center justify-center" :class="sidebarCollapsed && !sidebarHovered ? 'w-full' : ''">
                        <i data-feather="calendar" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                    </div>
                    <span x-show="!sidebarCollapsed || sidebarHovered" x-transition class="font-medium">Appointments</span>
                </a>
                
                <!-- Announcements -->
                <a href="{{ url_for('staff_announcements') }}"
                   class="flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all group hover:bg-white/10">
                    <div class="flex items-center justify-center" :class="sidebarCollapsed && !sidebarHovered ? 'w-full' : ''">
                        <i data-feather="volume-2" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                    </div>
                    <span x-show="!sidebarCollapsed || sidebarHovered" x-transition class="font-medium">Announcements</span>
                </a>
                
                <!-- Consultations -->
                <a href="{{ url_for('staff_consultations') }}"
                   class="flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all group hover:bg-white/10">
                    <div class="flex items-center justify-center" :class="sidebarCollapsed && !sidebarHovered ? 'w-full' : ''">
                        <i data-feather="message-circle" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                    </div>
                    <span x-show="!sidebarCollapsed || sidebarHovered" x-transition class="font-medium">Consultations</span>
                </a>
                
                <!-- Inventory -->
                <a href="{{ url_for('staff_inventory') }}"
                   class="flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all group hover:bg-white/10">
                    <div class="flex items-center justify-center" :class="sidebarCollapsed && !sidebarHovered ? 'w-full' : ''">
                        <i data-feather="package" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                    </div>
                    <span x-show="!sidebarCollapsed || sidebarHovered" x-transition class="font-medium">Inventory</span>
                </a>
                
                <!-- Reports -->
                <a href="{{ url_for('staff_reports') }}"
                   class="flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all group hover:bg-white/10">
                    <div class="flex items-center justify-center" :class="sidebarCollapsed && !sidebarHovered ? 'w-full' : ''">
                        <i data-feather="bar-chart-2" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                    </div>
                    <span x-show="!sidebarCollapsed || sidebarHovered" x-transition class="font-medium">Reports</span>
                </a>
                
                
            </nav>
        
        <!-- User Profile -->
        <div class="absolute bottom-0 w-full p-4 bg-gradient-to-t from-black/20 to-transparent">
            <div class="relative" @click.outside="userDropdown = false">
                <button @click="userDropdown = !userDropdown" 
                        class="w-full flex items-center gap-3 p-2 rounded-lg hover:bg-white/10 transition-colors" 
                        :class="sidebarCollapsed && !sidebarHovered ? 'justify-center' : ''">
                    <div class="w-10 h-10 bg-gradient-to-br from-yellow-400 to-yellow-500 rounded-full flex items-center justify-center shadow-lg">
                        <span class="text-blue-900 font-bold">{{ user.first_name[0] }}{{ user.last_name[0] }}</span>
                    </div>
                    <div x-show="!sidebarCollapsed || sidebarHovered" x-transition class="flex-1 text-left">
                        <p class="text-sm font-medium text-white">{{ user.first_name }} {{ user.last_name }}</p>
                        <p class="text-xs text-yellow-300">{{ user.position }}</p>
                    </div>
                    <i x-show="!sidebarCollapsed || sidebarHovered" data-feather="chevron-up" class="w-4 h-4 text-white/70"></i>
                </button>
                
                <!-- User Dropdown -->
                <div x-show="userDropdown" 
                     x-transition
                     class="absolute bottom-full left-4 right-4 mb-2 bg-white rounded-lg shadow-lg border border-gray-200 py-1">
                    <button @click="showLogoutConfirm = true; userDropdown = false" class="w-full flex items-center gap-2 px-3 py-2 text-sm text-red-600 hover:bg-red-50 rounded-md mx-1">
                        <i data-feather="log-out" class="w-4 h-4"></i>
                        Logout
                    </button>
                </div>
            </div>
        </div>
        </aside>
        
        <!-- Main Content Area -->
        <div :class="sidebarCollapsed ? 'md:ml-20' : 'md:ml-64'" class="flex-1 flex flex-col transition-all duration-300">
            
            <!-- ENHANCED MOBILE HEADER -->
            <header class="md:hidden bg-white shadow-sm border-b border-gray-200 px-2 sm:px-4 py-2 sm:py-3 flex items-center justify-between sticky top-0 z-20">
                <button @click="toggleMobileMenu()" class="p-2 rounded-lg hover:bg-gray-100 transition-colors touch-target">
                    <i data-feather="menu" class="w-5 h-5 sm:w-6 sm:h-6 text-gray-600"></i>
                </button>
                <div class="flex items-center gap-1 sm:gap-2 min-w-0 flex-1 justify-center">
                    <img src="../assets/img/iclinic-logo.png" alt="iClinic" class="w-6 h-6 sm:w-8 sm:h-8 flex-shrink-0">
                    <h1 class="text-base sm:text-lg font-bold text-gray-900 truncate">Patients</h1>
                </div>
                <div class="flex items-center gap-1 sm:gap-2">
                    <button @click="showPrintHistoryModal = true; loadPrintHistory()" class="p-1.5 sm:p-2 rounded-lg bg-green-500 hover:bg-green-600 text-white transition-colors touch-target">
                        <i data-feather="printer" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                    </button>
                    <button @click="showAddVisitorModal = true" class="p-1.5 sm:p-2 rounded-lg bg-blue-500 hover:bg-blue-600 text-white transition-colors touch-target">
                        <i data-feather="user-plus" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                    </button>
                </div>
            </header>
            
            <!-- Patients Directory Section -->
            <main class="flex-1 overflow-hidden bg-gray-50 p-0 sm:p-4 md:p-6">
                <!-- Enhanced Patients Header - HIDDEN ON MOBILE -->
                <div class="hidden md:block gradient-bg-sidebar text-white shadow-2xl relative overflow-hidden rounded-xl sm:rounded-2xl md:rounded-[2rem] ml-0 sm:ml-1">
                    <!-- Decorative Elements -->
                    <div class="absolute top-0 right-0 w-64 h-64 bg-white/5 rounded-full -translate-y-32 translate-x-32"></div>
                    <div class="absolute bottom-0 left-0 w-48 h-48 bg-yellow-400/10 rounded-full translate-y-24 -translate-x-24"></div>
                    
                    <!-- Header Content -->
                    <div class="relative px-3 sm:px-4 md:px-6 py-3 sm:py-4 md:py-5">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 sm:gap-4">
                            <!-- Title Section -->
                            <div class="flex items-center gap-2 sm:gap-3 md:gap-4">
                                <div class="relative">
                                    <div class="w-10 h-10 sm:w-12 sm:h-12 bg-yellow-400 rounded-lg sm:rounded-xl flex items-center justify-center shadow-lg transform rotate-2 hover:rotate-0 transition-transform duration-300">
                                        <i data-feather="users" class="w-5 h-5 sm:w-6 sm:h-6 text-blue-900"></i>
                                    </div>
                                    
                                </div>
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <h1 class="text-lg sm:text-xl md:text-2xl lg:text-3xl font-bold text-white">
                                            Patient Management
                                        </h1>
                        
                                    </div>
                                    <div class="flex items-center gap-2 text-blue-100">
                                        <i data-feather="activity" class="w-3 h-3"></i>
                                        <span class="text-xs sm:text-sm hidden sm:inline">Manage student and staff patient records</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Compact Stats and Actions -->
                            <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3">
                                <!-- Quick Stats -->
                                <div class="flex items-center gap-2">
                                </div>
                                
                                <!-- Action Buttons -->
                                <div class="flex items-center gap-1 sm:gap-2">
                                    <button @click="showAddVisitorModal = true" 
                                            class="group bg-yellow-400 hover:bg-yellow-500 text-blue-900 px-2 sm:px-3 md:px-4 py-1.5 sm:py-2 rounded-lg font-medium transition-all duration-200 flex items-center gap-1 sm:gap-2 shadow-lg hover:shadow-xl hover:scale-105 touch-target">
                                        <div class="w-5 h-5 sm:w-6 sm:h-6 bg-blue-900/20 rounded flex items-center justify-center group-hover:rotate-12 transition-transform">
                                            <i data-feather="user-plus" class="w-3 h-3"></i>
                                        </div>
                                        <span class="hidden sm:inline text-xs sm:text-sm">Add Visitors</span>
                                    </button>
                                    
                                    <button @click="showPrintHistoryModal = true; loadPrintHistory()" 
                                            class="group bg-green-500 hover:bg-green-600 text-white px-2 sm:px-3 md:px-4 py-1.5 sm:py-2 rounded-lg font-medium transition-all duration-200 flex items-center gap-1 sm:gap-2 shadow-lg hover:shadow-xl hover:scale-105 touch-target">
                                        <div class="w-5 h-5 sm:w-6 sm:h-6 bg-white/20 rounded flex items-center justify-center group-hover:rotate-12 transition-transform">
                                            <i data-feather="printer" class="w-3 h-3"></i>
                                        </div>
                                        <span class="hidden sm:inline text-xs sm:text-sm">Print History</span>
                                    </button>
                                    
                                    <button @click="showInsuranceModal = true; loadInsuranceData()" 
                                            class="group bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-2 sm:px-3 md:px-4 py-1.5 sm:py-2 rounded-lg font-medium transition-all duration-200 flex items-center gap-1 sm:gap-2 shadow-lg hover:shadow-xl hover:scale-105 touch-target">
                                        <div class="w-5 h-5 sm:w-6 sm:h-6 bg-white/20 rounded flex items-center justify-center group-hover:rotate-12 transition-transform">
                                            <i data-feather="shield" class="w-3 h-3"></i>
                                        </div>
                                        <span class="hidden sm:inline text-xs sm:text-sm">Insurance</span>
                                    </button>
                                    
                                    <button @click="showArchiveModal = true; loadArchivedPatients()" 
                                            class="group bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white px-2 sm:px-3 md:px-4 py-1.5 sm:py-2 rounded-lg font-medium transition-all duration-200 flex items-center gap-1 sm:gap-2 shadow-lg hover:shadow-xl hover:scale-105 touch-target">
                                        <div class="w-5 h-5 sm:w-6 sm:h-6 bg-white/20 rounded flex items-center justify-center group-hover:rotate-12 transition-transform">
                                            <i data-feather="archive" class="w-3 h-3"></i>
                                        </div>
                                        <span class="hidden sm:inline text-xs sm:text-sm">Archive</span>
                                    </button>
                                    
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                
                <!-- ENHANCED TWO PANEL LAYOUT -->
                <div class="flex flex-col md:flex-row overflow-hidden two-panel-layout mt-2 md:mt-0">
                    <!-- LEFT PANEL - PATIENTS LIST -->
                    <div class="w-full md:w-96 lg:w-[400px] border-r-0 md:border-r border-b md:border-b-0 border-gray-100 flex flex-col bg-gradient-to-b from-gray-50 to-white patient-list-panel rounded-t-xl md:rounded-t-none">
                        <!-- ENHANCED SEARCH HEADER -->
                        <div class="bg-white p-3 sm:p-3 md:p-4 lg:p-6 shadow-sm rounded-t-xl md:rounded-t-none">
                            <div class="relative mb-2 sm:mb-3 md:mb-4">
                                <input type="text" 
                                       placeholder="Search by name or ID..." 
                                       class="w-full pl-8 sm:pl-10 md:pl-12 pr-3 sm:pr-4 py-2 sm:py-2.5 md:py-3 bg-gray-50 border border-gray-200 rounded-xl text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent focus:bg-white transition-all text-sm sm:text-base touch-target"
                                       x-model="searchQuery"
                                       @input="filterPatients()">
                                <i data-feather="search" class="absolute left-2 sm:left-3 md:left-4 top-2 sm:top-2.5 md:top-3.5 w-4 h-4 sm:w-5 sm:h-5 text-gray-400"></i>
                            </div>
                            
                            <!-- ENHANCED FILTER PILLS -->
                            <div class="flex flex-wrap gap-1.5 sm:gap-1.5 md:gap-2">
                                <button @click="activeFilter = 'all'; filterPatients()" 
                                        :class="activeFilter === 'all' ? 'bg-blue-500 text-white shadow-md' : 'bg-white text-gray-600 border border-gray-200 hover:border-blue-300'"
                                        class="px-2.5 sm:px-2.5 md:px-4 py-1.5 sm:py-1.5 md:py-2 rounded-full text-xs sm:text-sm font-medium transition-all touch-target filter-pill">
                                    <span class="flex items-center gap-1">
                                        <span>All</span>
                                        <span class="text-xs opacity-80 hidden sm:inline" x-text="'(' + patients.length + ')'"></span>
                                    </span>
                                </button>
                                <button @click="activeFilter = 'students'; filterPatients()" 
                                        :class="activeFilter === 'students' ? 'bg-blue-500 text-white shadow-md' : 'bg-white text-gray-600 border border-gray-200 hover:border-blue-300'"
                                        class="px-2.5 sm:px-2.5 md:px-4 py-1.5 sm:py-1.5 md:py-2 rounded-full text-xs sm:text-sm font-medium transition-all touch-target filter-pill">
                                    <span>Students</span>
                                </button>
                                <button @click="activeFilter = 'teaching'; filterPatients()" 
                                        :class="activeFilter === 'teaching' ? 'bg-blue-500 text-white shadow-md' : 'bg-white text-gray-600 border border-gray-200 hover:border-blue-300'"
                                        class="px-2.5 sm:px-2.5 md:px-4 py-1.5 sm:py-1.5 md:py-2 rounded-full text-xs sm:text-sm font-medium transition-all touch-target filter-pill">
                                    <span class="hidden sm:inline">Teaching</span>
                                    <span class="sm:hidden">Teach</span>
                                </button>
                                <button @click="activeFilter = 'non-teaching'; filterPatients()" 
                                        :class="activeFilter === 'non-teaching' ? 'bg-blue-500 text-white shadow-md' : 'bg-white text-gray-600 border border-gray-200 hover:border-blue-300'"
                                        class="px-2.5 sm:px-2.5 md:px-4 py-1.5 sm:py-1.5 md:py-2 rounded-full text-xs sm:text-sm font-medium transition-all touch-target filter-pill">
                                    <span class="hidden sm:inline">Non-Teaching</span>
                                    <span class="sm:hidden">Staff</span>
                                </button>
                                <button @click="activeFilter = 'deans'; filterPatients()" 
                                        :class="activeFilter === 'deans' ? 'bg-blue-500 text-white shadow-md' : 'bg-white text-gray-600 border border-gray-200 hover:border-blue-300'"
                                        class="px-2.5 sm:px-2.5 md:px-4 py-1.5 sm:py-1.5 md:py-2 rounded-full text-xs sm:text-sm font-medium transition-all touch-target filter-pill">
                                    <span>Deans</span>
                                </button>
                                <button @click="activeFilter = 'president'; filterPatients()" 
                                        :class="activeFilter === 'president' ? 'bg-blue-500 text-white shadow-md' : 'bg-white text-gray-600 border border-gray-200 hover:border-blue-300'"
                                        class="px-2.5 sm:px-2.5 md:px-4 py-1.5 sm:py-1.5 md:py-2 rounded-full text-xs sm:text-sm font-medium transition-all touch-target filter-pill">
                                    <span>President</span>
                                </button>
                                <button @click="activeFilter = 'visitors'; filterPatients()" 
                                        :class="activeFilter === 'visitors' ? 'bg-blue-500 text-white shadow-md' : 'bg-white text-gray-600 border border-gray-200 hover:border-blue-300'"
                                        class="px-2.5 sm:px-2.5 md:px-4 py-1.5 sm:py-1.5 md:py-2 rounded-full text-xs sm:text-sm font-medium transition-all touch-target filter-pill">
                                    <span>Visitors</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Patients List -->
                        <div class="flex-1 overflow-y-auto p-2 sm:p-3 md:p-4" style="max-height: calc(50vh - 150px);">
                            <!-- Loading State -->
                            <div x-show="loading" class="flex flex-col items-center justify-center py-8 sm:py-16">
                                <div class="animate-spin rounded-full h-8 w-8 sm:h-12 sm:w-12 border-4 border-blue-200 border-t-blue-500 mb-3 sm:mb-4"></div>
                                <span class="text-gray-600 font-medium text-sm sm:text-base">Loading patients...</span>
                            </div>

                            <!-- Patient Items -->
                            <div class="space-y-2 sm:space-y-3">
                                <template x-for="patient in filteredPatients" :key="patient.id">
                                    <div @click="selectPatient(patient)" 
                                         :class="selectedPatient && selectedPatient.id === patient.id ? 
                                                'bg-gradient-to-r from-blue-50 to-blue-100 border-blue-300 shadow-md transform scale-105' : 
                                                'bg-white hover:shadow-lg hover:transform hover:scale-102 hover:border-blue-200'"
                                         class="p-3 sm:p-4 rounded-xl border border-gray-200 cursor-pointer transition-all duration-200 group card-hover patient-card"
                                         x-transition:enter="transition ease-out duration-300"
                                         x-transition:enter-start="opacity-0 transform translate-y-4"
                                         x-transition:enter-end="opacity-100 transform translate-y-0">
                                        <div class="flex items-center gap-3 sm:gap-4">
                                            <!-- Avatar -->
                                            <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-full flex items-center justify-center font-bold text-xs sm:text-sm shadow-inner flex-shrink-0"
                                                 :class="{
                                                     'bg-gradient-to-br from-blue-400 to-blue-500 text-white': patient.role === 'Student',
                                                     'bg-gradient-to-br from-amber-400 to-amber-500 text-white': patient.role === 'Teaching Staff',
                                                     'bg-gradient-to-br from-emerald-400 to-emerald-500 text-white': patient.role === 'Non-Teaching Staff',
                                                     'bg-gradient-to-br from-purple-400 to-purple-500 text-white': patient.role === 'Dean',
                                                     'bg-gradient-to-br from-red-400 to-red-500 text-white': patient.role === 'President',
                                                     'bg-gradient-to-br from-gray-400 to-gray-500 text-white': patient.role === 'Visitor'
                                                 }"
                                                 x-text="patient.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0,2)">
                                            </div>
                                            <!-- Patient Info -->
                                            <div class="flex-1 min-w-0">
                                                <h3 class="font-semibold text-gray-900 text-sm sm:text-sm group-hover:text-blue-600 transition-colors truncate" x-text="patient.name"></h3>
                                                <p class="text-xs text-gray-500 mt-0.5 truncate" x-text="patient.identifier"></p>
                                                <div class="flex items-center gap-1 sm:gap-2 mt-1.5 sm:mt-2 flex-wrap">
                                                    <span class="inline-flex items-center px-2 sm:px-2.5 py-0.5 sm:py-1 text-xs font-medium rounded-full"
                                                          :class="{
                                                              'bg-blue-100 text-blue-700': patient.role === 'Student',
                                                              'bg-amber-100 text-amber-700': patient.role === 'Teaching Staff',
                                                              'bg-emerald-100 text-emerald-700': patient.role === 'Non-Teaching Staff',
                                                              'bg-purple-100 text-purple-700': patient.role === 'Dean',
                                                              'bg-red-100 text-red-700': patient.role === 'President',
                                                              'bg-gray-100 text-gray-700': patient.role === 'Visitor'
                                                          }">
                                                        <span x-text="patient.role" class="truncate"></span>
                                                    </span>
                                                </div>
                                            </div>
                                            <!-- Arrow Icon -->
                                            <i data-feather="chevron-right" 
                                               class="w-4 h-4 sm:w-5 sm:h-5 text-gray-400 group-hover:text-blue-500 transition-colors flex-shrink-0"
                                               :class="selectedPatient && selectedPatient.id === patient.id ? 'text-blue-500' : ''"></i>
                                        </div>
                                    </div>
                                </template>
                            </div>
                            
                            <!-- Empty State -->
                            <div x-show="!loading && filteredPatients.length === 0" 
                                 class="text-center py-8 px-4"
                                 x-transition:enter="transition ease-out duration-300"
                                 x-transition:enter-start="opacity-0 scale-95"
                                 x-transition:enter-end="opacity-100 scale-100">
                                <div class="w-16 h-16 bg-gradient-to-br from-gray-100 to-gray-200 rounded-full flex items-center justify-center mx-auto mb-3 animate-pulse">
                                    <i data-feather="users" class="w-8 h-8 text-gray-400"></i>
                                </div>
                                <h3 class="text-base font-medium text-gray-900 mb-2">No patients found</h3>
                                <p class="text-gray-500 text-xs max-w-sm mx-auto">Try adjusting your search terms or filters to find the patients you're looking for.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Panel - Patient Details -->
                    <div class="flex-1 bg-gradient-to-br from-gray-50 via-white to-blue-50 flex flex-col overflow-y-auto patient-details-panel">
                        
                        <!-- No Patient Selected -->
                        <div x-show="!selectedPatient" class="flex-1 flex items-center justify-center p-4 sm:p-6 md:p-8">
                            <div class="text-center max-w-md mx-auto">
                                <div class="w-16 h-16 sm:w-20 sm:h-20 md:w-24 md:h-24 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 sm:mb-6 shadow-2xl animate-pulse">
                                    <i data-feather="users" class="w-8 h-8 sm:w-10 sm:h-10 md:w-12 md:h-12 text-white"></i>
                                </div>
                                <h3 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-900 mb-2 sm:mb-3">No Patient Selected</h3>
                                <p class="text-gray-600 text-sm sm:text-base mb-4 sm:mb-6 leading-relaxed px-2">Select a patient from the list to view their complete medical records and health information.</p>
                                <div class="grid grid-cols-2 gap-3 sm:gap-4 max-w-xs mx-auto">
                                    <div class="bg-white p-3 sm:p-4 rounded-xl border border-gray-200 hover:shadow-md transition-all">
                                        <div class="text-2xl sm:text-3xl font-bold text-blue-600" x-text="patients.length"></div>
                                        <div class="text-xs text-gray-500 mt-1">Total Patients</div>
                                    </div>
                                    <div class="bg-white p-3 sm:p-4 rounded-xl border border-gray-200 hover:shadow-md transition-all">
                                        <div class="text-2xl sm:text-3xl font-bold text-green-600" x-text="filteredPatients.length"></div>
                                        <div class="text-xs text-gray-500 mt-1">Filtered Results</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Patient Details -->
                        <div x-show="selectedPatient" class="flex-1 flex flex-col mt-2 sm:mt-4 md:mt-6" x-transition>
                            <!-- Patient Header -->
                            <div x-show="selectedPatient" class="relative overflow-hidden gradient-bg-sidebar rounded-lg sm:rounded-xl mx-2 sm:mx-0">
                                <!-- Background Pattern -->
                                <div class="absolute inset-0">
                                    <div class="absolute -top-24 -right-24 w-64 h-64 bg-white opacity-5 rounded-full"></div>
                                    <div class="absolute -bottom-12 -left-12 w-48 h-48 bg-white opacity-5 rounded-full"></div>
                                </div>
                                
                                <!-- Content -->
                                <div class="relative p-3 sm:p-4 md:p-6">
                                    <div class="flex items-center justify-between mb-2 sm:mb-3">
                                        <div class="flex items-center gap-2 sm:gap-3 md:gap-4 flex-1 min-w-0">
                                            <div class="w-10 h-10 sm:w-12 sm:h-12 md:w-14 md:h-14 lg:w-16 lg:h-16 bg-white shadow-xl rounded-xl sm:rounded-2xl flex items-center justify-center flex-shrink-0">
                                                <span class="text-sm sm:text-base md:text-lg lg:text-xl font-bold text-blue-600" x-text="selectedPatient ? selectedPatient.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0,2) : ''"></span>
                                            </div>
                                            <div class="min-w-0 flex-1">
                                                <h2 class="text-sm sm:text-base md:text-lg lg:text-xl font-bold text-white truncate" x-text="selectedPatient ? selectedPatient.name : ''"></h2>
                                                <p class="text-blue-100 text-[10px] sm:text-xs md:text-sm mt-0.5 sm:mt-1 truncate" x-text="getPatientSubtitle()"></p>
                                            </div>
                                        </div>
                                        <button @click="selectedPatient = null" class="w-7 h-7 sm:w-8 sm:h-8 md:w-10 md:h-10 bg-white bg-opacity-20 hover:bg-opacity-30 backdrop-blur rounded-lg sm:rounded-xl flex items-center justify-center transition-all hover:scale-110 flex-shrink-0 ml-1 sm:ml-2 touch-target">
                                            <i data-feather="x" class="w-3.5 h-3.5 sm:w-4 sm:h-4 md:w-5 md:h-5 text-white"></i>
                                        </button>
                                    </div>
                                    
                                    <!-- Quick Actions -->
                                    <div class="flex flex-wrap gap-1.5 sm:gap-2 md:gap-3">
                                        <button @click="resetNewRecordForm(); showAddRecordModal = true" class="bg-white shadow-lg hover:shadow-xl text-blue-600 px-2.5 sm:px-3 md:px-4 py-1.5 sm:py-2 md:py-2.5 rounded-lg sm:rounded-xl font-medium transition-all transform hover:scale-105 flex items-center gap-1.5 sm:gap-2 text-xs sm:text-sm md:text-base touch-target">
                                            <i data-feather="plus-circle" class="w-3.5 h-3.5 sm:w-4 sm:h-4"></i>
                                            <span class="hidden sm:inline">Add New Record</span>
                                            <span class="sm:hidden">Add</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ENHANCED PATIENT INFO CARDS -->
                            <div class="p-2 sm:p-3 md:p-4 lg:p-6">
                                <!-- Basic Info Cards - Dynamic layout based on patient type -->
                                <div :class="selectedPatient && selectedPatient.role === 'Visitor' ? 'grid grid-cols-2 gap-2 sm:gap-3 md:gap-4 mb-3 sm:mb-4 md:mb-6 max-w-2xl mx-auto' : 'grid grid-cols-2 md:grid-cols-4 gap-2 sm:gap-3 md:gap-4 mb-3 sm:mb-4 md:mb-6'">
                                    <!-- Age Card -->
                                    <div class="bg-white p-2 sm:p-3 md:p-4 rounded-lg sm:rounded-xl md:rounded-2xl shadow-sm hover:shadow-xl transition-all transform hover:scale-105 border border-gray-100 patient-info-card">
                                        <div class="flex flex-col items-center text-center">
                                            <div class="w-8 h-8 sm:w-10 sm:h-10 md:w-12 md:h-12 bg-gradient-to-br from-blue-400 to-blue-600 rounded-lg sm:rounded-xl flex items-center justify-center shadow-lg mb-1 sm:mb-2">
                                                <i data-feather="calendar" class="w-4 h-4 sm:w-5 sm:h-5 md:w-6 md:h-6 text-white"></i>
                                            </div>
                                            <p class="text-[10px] sm:text-xs font-medium text-gray-500 uppercase tracking-wider mb-0.5 sm:mb-1">Age</p>
                                            <p class="text-base sm:text-lg md:text-xl lg:text-2xl font-bold text-gray-900" x-text="selectedPatient ? selectedPatient.age || 'N/A' : 'N/A'"></p>
                                        </div>
                                    </div>
                                    
                                    <!-- Course/Rank/Position Card (Hidden for Visitors) -->
                                    <div x-show="selectedPatient && selectedPatient.role !== 'Visitor'" class="bg-white p-2 sm:p-3 md:p-4 rounded-lg sm:rounded-xl md:rounded-2xl shadow-sm hover:shadow-xl transition-all transform hover:scale-105 border border-gray-100 patient-info-card">
                                        <div class="flex flex-col items-center text-center">
                                            <div class="w-8 h-8 sm:w-10 sm:h-10 md:w-12 md:h-12 bg-gradient-to-br from-emerald-400 to-emerald-600 rounded-lg sm:rounded-xl flex items-center justify-center shadow-lg mb-1 sm:mb-2">
                                                <!-- Teaching Staff: Award icon -->
                                                <i x-show="selectedPatient && selectedPatient.role === 'Teaching Staff'" data-feather="award" class="w-4 h-4 sm:w-5 sm:h-5 md:w-6 md:h-6 text-white"></i>
                                                <!-- Non-Teaching Staff: Briefcase icon -->
                                                <i x-show="selectedPatient && selectedPatient.role === 'Non-Teaching Staff'" data-feather="briefcase" class="w-4 h-4 sm:w-5 sm:h-5 md:w-6 md:h-6 text-white"></i>
                                                <!-- Dean: Shield icon -->
                                                <i x-show="selectedPatient && selectedPatient.role === 'Dean'" data-feather="shield" class="w-4 h-4 sm:w-5 sm:h-5 md:w-6 md:h-6 text-white"></i>
                                                <!-- President: Star icon -->
                                                <i x-show="selectedPatient && selectedPatient.role === 'President'" data-feather="star" class="w-4 h-4 sm:w-5 sm:h-5 md:w-6 md:h-6 text-white"></i>
                                                <!-- Students: Book icon -->
                                                <i x-show="selectedPatient && selectedPatient.role === 'Student'" data-feather="book" class="w-4 h-4 sm:w-5 sm:h-5 md:w-6 md:h-6 text-white"></i>
                                            </div>
                                            <p class="text-[10px] sm:text-xs font-medium text-gray-500 uppercase tracking-wider mb-0.5 sm:mb-1" 
                                               x-text="selectedPatient && selectedPatient.role === 'Teaching Staff' ? 'Rank' : (selectedPatient && selectedPatient.role === 'Non-Teaching Staff' ? 'Position' : (selectedPatient && selectedPatient.role === 'Dean' ? 'Department' : (selectedPatient && selectedPatient.role === 'President' ? 'Office' : 'Course')))"></p>
                                            <p class="text-[11px] sm:text-xs md:text-sm font-bold text-gray-900 leading-tight text-center" 
                                               x-text="getRankOrCourse()"></p>
                                        </div>
                                    </div>
                                    
                                    <!-- Contact Card -->
                                    <div class="bg-white p-2 sm:p-3 md:p-4 rounded-lg sm:rounded-xl md:rounded-2xl shadow-sm hover:shadow-xl transition-all transform hover:scale-105 border border-gray-100 patient-info-card">
                                        <div class="flex flex-col items-center text-center">
                                            <div class="w-8 h-8 sm:w-10 sm:h-10 md:w-12 md:h-12 bg-gradient-to-br from-purple-400 to-purple-600 rounded-lg sm:rounded-xl flex items-center justify-center shadow-lg mb-1 sm:mb-2">
                                                <i data-feather="phone" class="w-4 h-4 sm:w-5 sm:h-5 md:w-6 md:h-6 text-white"></i>
                                            </div>
                                            <p class="text-[10px] sm:text-xs font-medium text-gray-500 uppercase tracking-wider mb-0.5 sm:mb-1">Contact</p>
                                            <p class="text-[11px] sm:text-xs md:text-sm font-bold text-gray-900 truncate w-full px-1" x-text="selectedPatient ? selectedPatient.contact || 'N/A' : 'N/A'"></p>
                                        </div>
                                    </div>
                                    
                                    <!-- Gender Card (Hidden for Visitors) -->
                                    <div x-show="selectedPatient && selectedPatient.role !== 'Visitor'" class="bg-white p-2 sm:p-3 md:p-4 rounded-lg sm:rounded-xl md:rounded-2xl shadow-sm hover:shadow-xl transition-all transform hover:scale-105 border border-gray-100 patient-info-card">
                                        <div class="flex flex-col items-center text-center">
                                            <div class="w-8 h-8 sm:w-10 sm:h-10 md:w-12 md:h-12 bg-gradient-to-br from-rose-400 to-rose-600 rounded-lg sm:rounded-xl flex items-center justify-center shadow-lg mb-1 sm:mb-2">
                                                <i data-feather="user" class="w-4 h-4 sm:w-5 sm:h-5 md:w-6 md:h-6 text-white"></i>
                                            </div>
                                            <p class="text-[10px] sm:text-xs font-medium text-gray-500 uppercase tracking-wider mb-0.5 sm:mb-1">Gender</p>
                                            <p class="text-xs sm:text-sm md:text-base lg:text-lg font-bold text-gray-900" x-text="selectedPatient ? selectedPatient.gender || 'N/A' : 'N/A'"></p>
                                        </div>
                                    </div>
                                </div>

                                <!-- EMERGENCY CONTACT CARDS (Students Only - 3 cards) -->
                                <div x-show="selectedPatient && selectedPatient.role === 'Student'" class="grid grid-cols-1 md:grid-cols-3 gap-2 sm:gap-3 md:gap-4 mb-3 sm:mb-4 md:mb-6">
                                    <!-- Emergency Contact Name Card -->
                                    <div class="bg-white p-2 sm:p-3 md:p-4 rounded-lg sm:rounded-xl md:rounded-2xl shadow-sm hover:shadow-xl transition-all transform hover:scale-105 border border-gray-100 patient-info-card">
                                        <div class="flex flex-col items-center text-center">
                                            <div class="w-8 h-8 sm:w-10 sm:h-10 md:w-12 md:h-12 bg-gradient-to-br from-red-400 to-red-600 rounded-lg sm:rounded-xl flex items-center justify-center shadow-lg mb-1 sm:mb-2">
                                                <i data-feather="user-check" class="w-4 h-4 sm:w-5 sm:h-5 md:w-6 md:h-6 text-white"></i>
                                            </div>
                                            <p class="text-[10px] sm:text-xs font-medium text-gray-500 uppercase tracking-wider mb-0.5 sm:mb-1">Emergency Contact</p>
                                            <p class="text-[11px] sm:text-xs md:text-sm font-bold text-gray-900 leading-tight text-center" x-text="selectedPatient && selectedPatient.emergency_contact_name ? selectedPatient.emergency_contact_name : 'N/A'"></p>
                                        </div>
                                    </div>
                                    
                                    <!-- Emergency Contact Relationship Card -->
                                    <div class="bg-white p-2 sm:p-3 md:p-4 rounded-lg sm:rounded-xl md:rounded-2xl shadow-sm hover:shadow-xl transition-all transform hover:scale-105 border border-gray-100 patient-info-card">
                                        <div class="flex flex-col items-center text-center">
                                            <div class="w-8 h-8 sm:w-10 sm:h-10 md:w-12 md:h-12 bg-gradient-to-br from-orange-400 to-orange-600 rounded-lg sm:rounded-xl flex items-center justify-center shadow-lg mb-1 sm:mb-2">
                                                <i data-feather="heart" class="w-4 h-4 sm:w-5 sm:h-5 md:w-6 md:h-6 text-white"></i>
                                            </div>
                                            <p class="text-[10px] sm:text-xs font-medium text-gray-500 uppercase tracking-wider mb-0.5 sm:mb-1">Relationship</p>
                                            <p class="text-[11px] sm:text-xs md:text-sm font-bold text-gray-900 leading-tight text-center" x-text="selectedPatient && selectedPatient.emergency_contact_relationship ? selectedPatient.emergency_contact_relationship : 'N/A'"></p>
                                        </div>
                                    </div>
                                    
                                    <!-- Emergency Contact Number Card -->
                                    <div class="bg-white p-2 sm:p-3 md:p-4 rounded-lg sm:rounded-xl md:rounded-2xl shadow-sm hover:shadow-xl transition-all transform hover:scale-105 border border-gray-100 patient-info-card">
                                        <div class="flex flex-col items-center text-center">
                                            <div class="w-8 h-8 sm:w-10 sm:h-10 md:w-12 md:h-12 bg-gradient-to-br from-amber-400 to-amber-600 rounded-lg sm:rounded-xl flex items-center justify-center shadow-lg mb-1 sm:mb-2">
                                                <i data-feather="phone-call" class="w-4 h-4 sm:w-5 sm:h-5 md:w-6 md:h-6 text-white"></i>
                                            </div>
                                            <p class="text-[10px] sm:text-xs font-medium text-gray-500 uppercase tracking-wider mb-0.5 sm:mb-1">Emergency Phone</p>
                                            <p class="text-[11px] sm:text-xs md:text-sm font-bold text-gray-900 truncate w-full px-1" x-text="selectedPatient && selectedPatient.emergency_contact_number ? selectedPatient.emergency_contact_number : 'N/A'"></p>
                                        </div>
                                    </div>
                                </div>

                            </div>
                            
                            <!-- ENHANCED MEDICAL RECORDS HEADER -->
                            <div class="mx-2 sm:mx-3 md:mx-4 lg:mx-6 mb-2 sm:mb-3 md:mb-4">
                                <div class="bg-white rounded-lg sm:rounded-xl md:rounded-2xl shadow-sm border border-gray-100 p-2 sm:p-2.5 md:p-3 lg:p-4">
                                    <div class="flex items-center justify-between gap-2">
                                        <div class="flex items-center gap-1.5 sm:gap-2 md:gap-3 flex-1 min-w-0">
                                            <div class="w-6 h-6 sm:w-7 sm:h-7 md:w-8 md:h-8 lg:w-10 lg:h-10 bg-gradient-to-br from-indigo-500 to-blue-600 rounded-md sm:rounded-lg md:rounded-xl flex items-center justify-center shadow-lg flex-shrink-0">
                                                <i data-feather="file-text" class="w-3 h-3 sm:w-3.5 sm:h-3.5 md:w-4 md:h-4 lg:w-5 lg:h-5 text-white"></i>
                                            </div>
                                            <div class="min-w-0 flex-1">
                                                <h3 class="text-xs sm:text-sm md:text-base lg:text-lg font-bold text-gray-900 truncate">Medical Records</h3>
                                                <p class="text-[9px] sm:text-[10px] md:text-xs text-gray-500 mt-0 sm:mt-0.5 hidden sm:block truncate">Complete health history and treatments</p>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-1.5 sm:gap-2 flex-shrink-0">
                                            <span class="px-1.5 sm:px-2 md:px-3 lg:px-4 py-0.5 sm:py-1 md:py-1.5 lg:py-2 bg-gradient-to-r from-blue-50 to-indigo-50 text-blue-700 rounded-md sm:rounded-lg md:rounded-xl text-[9px] sm:text-[10px] md:text-xs lg:text-sm font-semibold border border-blue-200 whitespace-nowrap" x-text="(selectedPatient && selectedPatient.medical_records ? selectedPatient.medical_records.length : 0) + ' records'"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ENHANCED MEDICAL RECORDS TABLE -->
                            <div class="px-2 sm:px-3 md:px-4 lg:px-6 pb-3 sm:pb-4 md:pb-6 lg:pb-8">
                                <!-- Loading State for Patient Records -->
                                <div x-show="loadingPatientRecords" class="flex flex-col items-center justify-center py-8 sm:py-16">
                                    <div class="animate-spin rounded-full h-8 w-8 sm:h-12 sm:w-12 border-4 border-blue-200 border-t-blue-500 mb-3 sm:mb-4"></div>
                                    <span class="text-gray-600 font-medium text-sm sm:text-base">Loading medical records...</span>
                                </div>

                                <!-- Medical Records Table -->
                                <div x-show="!loadingPatientRecords">
                                    <template x-if="selectedPatient && selectedPatient.medical_records && selectedPatient.medical_records.length > 0">
                                        <div class="bg-white rounded-lg sm:rounded-xl md:rounded-2xl shadow-lg border border-gray-100">
                                            <div class="max-h-[calc(100vh-350px)] sm:max-h-[calc(100vh-400px)] md:max-h-[calc(100vh-400px)] overflow-y-auto">
                                                <div class="overflow-x-auto">
                                                    <table class="w-full medical-records-table">
                                                    <thead class="bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200 sticky top-0 z-10">
                                                        <tr>
                                                            <th class="px-2 sm:px-3 md:px-4 lg:px-6 py-2 sm:py-3 md:py-4 text-left text-[10px] sm:text-xs font-bold text-gray-700 uppercase tracking-wider">Date & Time</th>
                                                            <th class="px-2 sm:px-3 md:px-4 lg:px-6 py-2 sm:py-3 md:py-4 text-left text-[10px] sm:text-xs font-bold text-gray-700 uppercase tracking-wider">Reason for Visit</th>
                                                            <th class="px-2 sm:px-3 md:px-4 lg:px-6 py-2 sm:py-3 md:py-4 text-left text-[10px] sm:text-xs font-bold text-gray-700 uppercase tracking-wider hidden sm:table-cell">Treatment</th>
                                                            <th class="px-2 sm:px-3 md:px-4 lg:px-6 py-2 sm:py-3 md:py-4 text-left text-[10px] sm:text-xs font-bold text-gray-700 uppercase tracking-wider hidden md:table-cell">Status</th>
                                                            <th class="px-2 sm:px-3 md:px-4 lg:px-6 py-2 sm:py-3 md:py-4 text-left text-[10px] sm:text-xs font-bold text-gray-700 uppercase tracking-wider hidden lg:table-cell">Admission</th>
                                                            <th class="px-2 sm:px-3 md:px-4 lg:px-6 py-2 sm:py-3 md:py-4 text-left text-[10px] sm:text-xs font-bold text-gray-700 uppercase tracking-wider hidden lg:table-cell">Discharge</th>
                                                            <th class="px-2 sm:px-3 md:px-4 lg:px-6 py-2 sm:py-3 md:py-4 text-left text-[10px] sm:text-xs font-bold text-gray-700 uppercase tracking-wider hidden xl:table-cell">Prescription</th>
                                                            <th class="px-2 sm:px-3 md:px-4 lg:px-6 py-2 sm:py-3 md:py-4 text-center text-[10px] sm:text-xs font-bold text-gray-700 uppercase tracking-wider">Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody class="divide-y divide-gray-100">
                                                        <template x-for="record in selectedPatient.medical_records" :key="record.id">
                                                            <tr class="hover:bg-blue-50 transition-all duration-200 group">
                                                                <td class="px-2 sm:px-3 md:px-4 lg:px-6 py-2 sm:py-3 md:py-4 whitespace-nowrap">
                                                                    <div class="flex flex-col">
                                                                        <div class="text-[10px] sm:text-xs md:text-sm font-semibold text-gray-900" x-text="record.date"></div>
                                                                        <div class="text-[10px] sm:text-xs text-gray-500 flex items-center gap-1 mt-0.5 sm:mt-1">
                                                                            <i data-feather="clock" class="w-2.5 h-2.5 sm:w-3 sm:h-3"></i>
                                                                            <span x-text="record.time"></span>
                                                                        </div>
                                                                        <!-- Mobile-only treatment info -->
                                                                        <div class="sm:hidden mt-1.5 text-[10px] text-blue-600 font-medium" x-show="record.treatment" x-text="record.treatment"></div>
                                                                    </div>
                                                                </td>
                                                                <td class="px-2 sm:px-3 md:px-4 lg:px-6 py-2 sm:py-3 md:py-4">
                                                                    <div class="max-w-xs">
                                                                        <div class="text-[10px] sm:text-xs md:text-sm text-gray-900 font-medium truncate" x-text="record.chief_complaint || record.symptoms"></div>
                                                                        <div x-show="record.dental_procedure" class="text-[10px] sm:text-xs text-blue-600 mt-0.5 sm:mt-1 flex items-center gap-1">
                                                                            <i data-feather="tool" class="w-2.5 h-2.5 sm:w-3 sm:h-3"></i>
                                                                            <span x-text="record.dental_procedure"></span>
                                                                        </div>
                                                                        <!-- Mobile-only prescription info -->
                                                                        <div class="xl:hidden mt-1.5" x-show="record.prescribed_medicine">
                                                                            <div class="inline-flex items-center gap-1 bg-green-50 border border-green-200 px-1.5 py-0.5 sm:px-2 sm:py-1 rounded-lg">
                                                                                <svg class="w-2.5 h-2.5 sm:w-3 sm:h-3 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                                                                                </svg>
                                                                                <span class="text-[10px] sm:text-xs font-medium text-green-700 truncate" x-text="record.prescribed_medicine"></span>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </td>
                                                                <td class="px-2 sm:px-3 md:px-4 lg:px-6 py-2 sm:py-3 md:py-4 hidden sm:table-cell">
                                                                    <div class="max-w-xs">
                                                                        <div class="text-[10px] sm:text-xs md:text-sm text-gray-900 font-semibold truncate" x-text="record.treatment"></div>
                                                                        <div class="text-[10px] sm:text-xs text-gray-600 mt-0.5 sm:mt-1 truncate" x-text="record.notes || 'No additional notes'"></div>
                                                                    </div>
                                                                </td>
                                                                <td class="px-3 sm:px-6 py-4 hidden md:table-cell">
                                                                    <div x-show="record.stay_status === 'staying'" class="inline-flex items-center gap-1 bg-green-50 border border-green-200 px-3 py-1.5 rounded-full">
                                                                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                                                        <span class="text-xs font-semibold text-green-700">Admitted</span>
                                                                    </div>
                                                                    <div x-show="record.stay_status === 'checked_out'" class="inline-flex items-center gap-1 bg-red-50 border border-red-200 px-3 py-1.5 rounded-full">
                                                                        <div class="w-2 h-2 bg-red-500 rounded-full"></div>
                                                                        <span class="text-xs font-semibold text-red-700">Discharged</span>
                                                                    </div>
                                                                    <div x-show="!record.stay_status || record.stay_status === 'not_staying'" class="inline-flex items-center gap-1 bg-blue-50 border border-blue-200 px-3 py-1.5 rounded-full">
                                                                        <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                                                                        <span class="text-xs font-semibold text-blue-700">Outpatient</span>
                                                                    </div>
                                                                </td>
                                                                <td class="px-3 sm:px-6 py-4 hidden lg:table-cell">
                                                                    <div x-show="record.admission_time" class="flex flex-col">
                                                                        <div class="text-sm font-semibold text-green-700" x-text="formatAdmissionDate(record.admission_time)"></div>
                                                                        <div class="text-xs text-green-600 flex items-center gap-1 mt-1">
                                                                            <i data-feather="log-in" class="w-3 h-3"></i>
                                                                            <span x-text="formatAdmissionTime(record.admission_time)"></span>
                                                                        </div>
                                                                    </div>
                                                                    <div x-show="!record.admission_time" class="text-xs text-gray-400 italic">Not admitted</div>
                                                                </td>
                                                                <td class="px-3 sm:px-6 py-4 hidden lg:table-cell">
                                                                    <div x-show="record.discharge_time" class="flex flex-col">
                                                                        <div class="text-sm font-semibold text-red-700" x-text="formatAdmissionDate(record.discharge_time)"></div>
                                                                        <div class="text-xs text-red-600 flex items-center gap-1 mt-1">
                                                                            <i data-feather="log-out" class="w-3 h-3"></i>
                                                                            <span x-text="formatAdmissionTime(record.discharge_time)"></span>
                                                                        </div>
                                                                    </div>
                                                                    <div x-show="!record.discharge_time && record.admission_time" class="text-xs text-orange-500 italic font-medium">Still admitted</div>
                                                                    <div x-show="!record.discharge_time && !record.admission_time" class="text-xs text-gray-400 italic">Not discharged</div>
                                                                </td>
                                                                <td class="px-3 sm:px-6 py-4 hidden xl:table-cell">
                                                                    <div x-show="record.prescribed_medicine" 
                                                                         class="inline-flex items-center gap-1 bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 px-3 py-1.5 rounded-lg">
                                                                        <svg class="w-3 h-3 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                                                                        </svg>
                                                                        <span class="text-xs font-medium text-green-700 truncate" x-text="record.prescribed_medicine"></span>
                                                                    </div>
                                                                    <div x-show="!record.prescribed_medicine" class="text-xs text-gray-400 italic">No prescription</div>
                                                                </td>
                                                                <td class="px-1 sm:px-2 md:px-3 lg:px-6 py-2 sm:py-3 md:py-4">
                                                                    <div class="flex items-center justify-center gap-0.5 sm:gap-1 md:gap-2">
                                                                        <button @click="viewRecord(record)" 
                                                                                class="inline-flex items-center gap-1 px-1.5 sm:px-2 md:px-3 py-1.5 bg-blue-500 hover:bg-blue-600 text-white text-xs font-medium rounded-lg transition-all duration-200 shadow-sm hover:shadow-md touch-target action-button" 
                                                                                title="View Record">
                                                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                                                            </svg>
                                                                            <span class="hidden md:inline">View</span>
                                                                        </button>
                                                                        <button @click="printRecordCertificate(record)" 
                                                                                class="inline-flex items-center gap-1 px-1.5 sm:px-2 md:px-3 py-1.5 bg-green-500 hover:bg-green-600 text-white text-xs font-medium rounded-lg transition-all duration-200 shadow-sm hover:shadow-md touch-target action-button" 
                                                                                title="Print Certificate">
                                                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
                                                                            </svg>
                                                                            <span class="hidden md:inline">Print</span>
                                                                        </button>
                                                                        <button @click="deleteRecord(record)" 
                                                                                class="inline-flex items-center gap-1 px-1.5 sm:px-2 md:px-3 py-1.5 bg-red-500 hover:bg-red-600 text-white text-xs font-medium rounded-lg transition-all duration-200 shadow-sm hover:shadow-md touch-target action-button" 
                                                                                title="Delete Record">
                                                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                                            </svg>
                                                                            <span class="hidden md:inline">Delete</span>
                                                                        </button>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        </template>
                                                    </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                    
                                    <!-- ENHANCED EMPTY MEDICAL RECORDS -->
                                    <div x-show="selectedPatient && (!selectedPatient.medical_records || selectedPatient.medical_records.length === 0)" 
                                         class="flex items-center justify-center h-full">
                                        <div class="text-center max-w-sm mx-auto py-8 sm:py-12 md:py-16 px-4">
                                            <div class="w-16 h-16 sm:w-20 sm:h-20 md:w-24 md:h-24 bg-gradient-to-br from-gray-100 to-gray-200 rounded-full flex items-center justify-center mx-auto mb-4 sm:mb-6">
                                                <i data-feather="clipboard" class="w-8 h-8 sm:w-10 sm:h-10 md:w-12 md:h-12 text-gray-400"></i>
                                            </div>
                                            <h3 class="text-lg sm:text-xl font-bold text-gray-900 mb-2">No Medical Records Yet</h3>
                                            <p class="text-gray-500 text-sm mb-4 sm:mb-6 leading-relaxed">Start building this patient's medical history by adding their first consultation record.</p>
                                            <button @click="resetNewRecordForm(); showAddRecordModal = true" 
                                                    class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-4 sm:px-6 py-2.5 sm:py-3 rounded-xl font-medium transition-all transform hover:scale-105 shadow-lg hover:shadow-xl touch-target">
                                                <span class="flex items-center gap-2">
                                                    <i data-feather="plus" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                                                    <span class="text-sm sm:text-base">Add First Record</span>
                                                </span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Add Visitor Modal -->
                <div x-show="showAddVisitorModal" 
                     x-cloak
                     class="fixed inset-0 z-50 flex items-center justify-center p-2 sm:p-4" 
                     style="display: none;"
                     x-transition:enter="transition ease-out duration-300"
                     x-transition:enter-start="opacity-0"
                     x-transition:enter-end="opacity-100"
                     x-transition:leave="transition ease-in duration-200"
                     x-transition:leave-start="opacity-100"
                     x-transition:leave-end="opacity-0">
                    <div class="fixed inset-0 bg-gray-900 bg-opacity-50 backdrop-blur-sm" @click="showAddVisitorModal = false"></div>
                    <div class="relative bg-white rounded-2xl shadow-2xl max-w-md w-full p-4 sm:p-6 md:p-8 z-10 max-h-[90vh] overflow-y-auto" 
                         @click.stop
                         x-transition:enter="transition ease-out duration-300"
                         x-transition:enter-start="opacity-0 transform scale-95"
                         x-transition:enter-end="opacity-100 transform scale-100"
                         x-transition:leave="transition ease-in duration-200"
                         x-transition:leave-start="opacity-100 transform scale-100"
                         x-transition:leave-end="opacity-0 transform scale-95">
                        <div class="flex items-center gap-3 sm:gap-4 mb-4 sm:mb-6">
                            <div class="w-10 h-10 sm:w-12 sm:h-12 bg-gradient-to-br from-blue-400 to-blue-600 rounded-xl flex items-center justify-center shadow-lg flex-shrink-0">
                                <i data-feather="user-plus" class="w-5 h-5 sm:w-6 sm:h-6 text-white"></i>
                            </div>
                            <div class="min-w-0">
                                <h3 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-900">Add New Visitor</h3>
                                <p class="text-xs sm:text-sm text-gray-500">Register a new visitor patient</p>
                            </div>
                        </div>
                        <form @submit.prevent="addVisitor()">
                            <div class="space-y-4 sm:space-y-5">
                                <!-- Name Fields -->
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4">
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">First Name *</label>
                                        <input type="text" required 
                                               x-model="newVisitor.first_name"
                                               class="w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent focus:bg-white transition-all text-base"
                                               placeholder="First name">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">Middle Name</label>
                                        <input type="text" 
                                               x-model="newVisitor.middle_name"
                                               class="w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent focus:bg-white transition-all text-base"
                                               placeholder="Middle name">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">Last Name *</label>
                                        <input type="text" required 
                                               x-model="newVisitor.last_name"
                                               class="w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent focus:bg-white transition-all text-base"
                                               placeholder="Last name">
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Age *</label>
                                    <input type="number" required 
                                           x-model="newVisitor.age"
                                           class="w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent focus:bg-white transition-all text-base"
                                           placeholder="Age">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Contact Number *</label>
                                    <input type="tel" required 
                                           x-model="newVisitor.contact_number"
                                           class="w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent focus:bg-white transition-all text-base"
                                           placeholder="09XX XXX XXXX">
                                </div>
                            </div>
                            <div class="flex flex-col sm:flex-row gap-3 mt-6 sm:mt-8">
                                <button type="button" @click="showAddVisitorModal = false" 
                                        class="w-full sm:flex-1 px-4 sm:px-6 py-2.5 sm:py-3 border-2 border-gray-200 text-gray-700 rounded-xl hover:bg-gray-50 hover:border-gray-300 font-semibold transition-all text-base">
                                    Cancel
                                </button>
                                <button type="submit" 
                                        :disabled="addingVisitor"
                                        class="w-full sm:flex-1 px-4 sm:px-6 py-2.5 sm:py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl hover:from-blue-600 hover:to-blue-700 font-semibold transition-all transform hover:scale-105 shadow-lg hover:shadow-xl text-base disabled:opacity-50 disabled:cursor-not-allowed">
                                    <span x-show="!addingVisitor">Add Visitor</span>
                                    <span x-show="addingVisitor" class="flex items-center gap-2">
                                        <svg class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        Adding...
                                    </span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                <!-- Duplicate Patient Confirmation Modal -->
                <div x-show="showDuplicateConfirmModal" 
                     x-cloak
                     class="fixed inset-0 z-50 flex items-center justify-center p-2 sm:p-4" 
                     style="display: none;"
                     x-transition:enter="transition ease-out duration-300"
                     x-transition:enter-start="opacity-0"
                     x-transition:enter-end="opacity-100"
                     x-transition:leave="transition ease-in duration-200"
                     x-transition:leave-start="opacity-100"
                     x-transition:leave-end="opacity-0">
                    <div class="fixed inset-0 bg-gray-900 bg-opacity-50 backdrop-blur-sm" @click="cancelAddVisitor()"></div>
                    <div class="relative bg-white rounded-2xl shadow-2xl max-w-2xl w-full p-4 sm:p-6 md:p-8 z-10 max-h-[90vh] overflow-y-auto" 
                         @click.stop
                         x-transition:enter="transition ease-out duration-300"
                         x-transition:enter-start="opacity-0 scale-90"
                         x-transition:enter-end="opacity-100 scale-100"
                         x-transition:leave="transition ease-in duration-200"
                         x-transition:leave-start="opacity-100 scale-100"
                         x-transition:leave-end="opacity-0 scale-90">
                        
                        <!-- Modal Header -->
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-yellow-100 rounded-xl flex items-center justify-center">
                                    <i data-feather="alert-triangle" class="w-6 h-6 text-yellow-600"></i>
                                </div>
                                <div>
                                    <h3 class="text-xl sm:text-2xl font-bold text-gray-800">Duplicate Patient Detected</h3>
                                    <p class="text-sm text-gray-500">Found existing patient(s) with the same name</p>
                                </div>
                            </div>
                            <button @click="cancelAddVisitor()" 
                                    class="text-gray-400 hover:text-gray-600 transition-colors p-2 hover:bg-gray-100 rounded-lg">
                                <i data-feather="x" class="w-5 h-5"></i>
                            </button>
                        </div>

                        <!-- Warning Message -->
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded-lg">
                            <div class="flex items-start gap-3">
                                <i data-feather="info" class="w-5 h-5 text-yellow-600 mt-0.5 flex-shrink-0"></i>
                                <div>
                                    <p class="text-sm font-semibold text-yellow-800 mb-1">Potential Duplicate Entry</p>
                                    <p class="text-sm text-yellow-700">
                                        We found <strong><span x-text="duplicatePatients.length"></span> existing patient(s)</strong> with the same name. 
                                        Please confirm if you want to add this person as a new visitor or if this is one of the existing patients below.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- New Visitor Info -->
                        <div class="mb-6">
                            <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                                <i data-feather="user-plus" class="w-4 h-4"></i>
                                New Visitor Information
                            </h4>
                            <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-lg">
                                        <span x-text="(pendingVisitorData?.first_name || '?')[0] + (pendingVisitorData?.last_name || '?')[0]"></span>
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-semibold text-gray-800">
                                            <span x-text="pendingVisitorData?.first_name"></span>
                                            <span x-text="pendingVisitorData?.middle_name ? ' ' + pendingVisitorData.middle_name : ''"></span>
                                            <span x-text="' ' + pendingVisitorData?.last_name"></span>
                                        </p>
                                        <div class="flex flex-wrap gap-3 mt-1 text-sm text-gray-600">
                                            <span class="flex items-center gap-1">
                                                <i data-feather="calendar" class="w-3 h-3"></i>
                                                Age: <span x-text="pendingVisitorData?.age"></span>
                                            </span>
                                            <span class="flex items-center gap-1">
                                                <i data-feather="phone" class="w-3 h-3"></i>
                                                <span x-text="pendingVisitorData?.contact_number"></span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Existing Patients List -->
                        <div class="mb-6">
                            <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                                <i data-feather="users" class="w-4 h-4"></i>
                                Existing Patients with Same Name
                            </h4>
                            <div class="space-y-3 max-h-64 overflow-y-auto">
                                <template x-for="(patient, index) in duplicatePatients" :key="index">
                                    <div class="bg-gray-50 border border-gray-200 rounded-xl p-4 hover:border-blue-300 transition-colors">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center text-white font-bold text-sm">
                                                <span x-text="patient.name.split(' ').map(n => n[0]).join('').substring(0, 2)"></span>
                                            </div>
                                            <div class="flex-1">
                                                <p class="font-semibold text-gray-800" x-text="patient.name"></p>
                                                <div class="flex flex-wrap gap-3 mt-1 text-xs text-gray-600">
                                                    <span class="px-2 py-0.5 bg-blue-100 text-blue-700 rounded-full font-medium" x-text="patient.type"></span>
                                                    <span class="flex items-center gap-1">
                                                        <i data-feather="info" class="w-3 h-3"></i>
                                                        <span x-text="patient.additional_info"></span>
                                                    </span>
                                                    <span class="flex items-center gap-1">
                                                        <i data-feather="hash" class="w-3 h-3"></i>
                                                        ID: <span x-text="patient.id"></span>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Confirmation Question -->
                        <div class="bg-gray-50 border border-gray-200 rounded-xl p-4 mb-6">
                            <p class="text-center text-gray-700 font-medium">
                                Is this person different from the existing patient(s) above?
                            </p>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex flex-col sm:flex-row gap-3">
                            <button type="button" 
                                    @click="cancelAddVisitor()" 
                                    class="w-full sm:flex-1 px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 hover:border-gray-400 font-semibold transition-all text-base flex items-center justify-center gap-2">
                                <i data-feather="x" class="w-4 h-4"></i>
                                No, Cancel
                            </button>
                            <button type="button" 
                                    @click="proceedWithAddingVisitor()" 
                                    :disabled="addingVisitor"
                                    class="w-full sm:flex-1 px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl hover:from-blue-600 hover:to-blue-700 font-semibold transition-all transform hover:scale-105 shadow-lg hover:shadow-xl text-base disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                                <i data-feather="check" class="w-4 h-4" x-show="!addingVisitor"></i>
                                <span x-show="!addingVisitor">Yes, Add as New Visitor</span>
                                <span x-show="addingVisitor" class="flex items-center gap-2">
                                    <svg class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    Adding...
                                </span>
                            </button>
                        </div>
                    </div>
                </div>


                <!-- Add Medical Record Modal -->
                <div x-show="showAddRecordModal" x-cloak class="fixed inset-0 z-50 flex items-center justify-center p-2 sm:p-4" style="display: none;" x-transition>
                    <div class="fixed inset-0 bg-gray-900 bg-opacity-50 backdrop-blur-sm" @click="showAddRecordModal = false" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"></div>
                    <div class="relative bg-white rounded-2xl shadow-2xl max-w-[64vw] w-full max-h-[95vh] overflow-y-auto z-10" @click.stop x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100">
                        <!-- Modal Header -->
                        <div class="sticky top-0 bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 sm:px-6 md:px-8 py-4 sm:py-6 rounded-t-2xl">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2 sm:gap-3 flex-1 min-w-0">
                                    <div class="w-8 h-8 sm:w-10 sm:h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center flex-shrink-0">
                                        <i data-feather="plus" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                                    </div>
                                    <div class="min-w-0">
                                        <h3 class="text-lg sm:text-xl font-semibold truncate">Add Medical Record</h3>
                                        <p class="text-blue-100 text-xs sm:text-sm truncate" x-text="selectedPatient ? 'for ' + selectedPatient.name : ''"></p>
                                    </div>
                                </div>
                                <button @click="showAddRecordModal = false" class="w-8 h-8 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-full flex items-center justify-center transition-colors flex-shrink-0 ml-2">
                                    <i data-feather="x" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Form Content -->
                        <div class="p-4 sm:p-6 md:p-8">
                            <form @submit.prevent="addMedicalRecord()">
                                <div class="space-y-6">
                                    <!-- Top Section: Patient Info & Visit Details (Side by Side) -->
                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                        <!-- Patient Info (Read-only) -->
                                        <div class="bg-gray-50 p-4 rounded-xl border-l-4 border-blue-500">
                                            <label class="block text-sm font-semibold text-gray-700 mb-2">Patient Information</label>
                                            <div class="flex items-center gap-3">
                                                <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                                                    <i data-feather="user" class="w-5 h-5 text-blue-600"></i>
                                                </div>
                                                <div class="min-w-0">
                                                    <p class="font-medium text-gray-900 text-base truncate" x-text="selectedPatient ? selectedPatient.name : ''"></p>
                                                    <p class="text-sm text-gray-600 truncate" x-text="selectedPatient ? selectedPatient.student_number + ' â€¢ ' + selectedPatient.course : ''"></p>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Visit Details (Auto-filled) -->
                                        <div class="bg-green-50 p-4 rounded-xl border-l-4 border-green-500">
                                            <label class="block text-sm font-semibold text-gray-700 mb-2">Visit Date & Time (Automatic)</label>
                                            <div class="flex items-center gap-3">
                                                <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0">
                                                    <i data-feather="clock" class="w-5 h-5 text-green-600"></i>
                                                </div>
                                                <div class="min-w-0">
                                                    <p class="font-medium text-gray-900 text-base" x-text="getCurrentDateTime()"></p>
                                                    <p class="text-sm text-gray-600">Automatically set to current date and time</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Reason for Visit (Full Width) -->
                                    <div class="space-y-3">
                                        <label class="block text-sm font-semibold text-gray-700">Reason for Visit *</label>
                                        
                                        <!-- Quick Select Dropdown -->
                                        <div class="space-y-2">
                                            <label class="block text-xs font-medium text-gray-600">Quick Select (Optional)</label>
                                            <select x-ref="complaintDropdown" @change="if($event.target.value !== 'Other (specify)') { newRecord.chief_complaint = $event.target.value; } else { newRecord.chief_complaint = ''; }" 
                                                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors text-base">
                                                <option value="">-- Select common complaint --</option>
                                                <template x-for="complaint in commonComplaints" :key="complaint">
                                                    <option :value="complaint" x-text="complaint"></option>
                                                </template>
                                            </select>
                                        </div>
                                        
                                        <!-- Manual Input -->
                                        <div class="space-y-2">
                                            <label class="block text-xs font-medium text-gray-600">Or type manually:</label>
                                            <textarea x-model="newRecord.chief_complaint" rows="2" required placeholder="Main reason for visit (e.g., Bunot ng ngipin, headache, fever)..."
                                                      class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors resize-none text-base"></textarea>
                                        </div>
                                    </div>

                                    <!-- Three Column Layout: Medical History | Vital Signs | Physical Measurements -->
                                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                                        <!-- Column 1: Medical History -->
                                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-200">
                                            <h4 class="text-base font-semibold text-blue-900 mb-3">Medical History</h4>
                                            <div class="space-y-3">
                                                <div class="space-y-1.5">
                                                    <label class="block text-xs font-semibold text-gray-700">Medical History</label>
                                                    <textarea x-model="newRecord.medical_history" rows="2" placeholder="Previous conditions..."
                                                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors resize-none text-sm"></textarea>
                                                </div>
                                                <div class="space-y-1.5">
                                                    <label class="block text-xs font-semibold text-gray-700">Fever Duration</label>
                                                    <input type="text" x-model="newRecord.fever_duration" placeholder="Ilang araw"
                                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors text-sm">
                                                </div>
                                                <div class="space-y-1.5">
                                                    <label class="block text-xs font-semibold text-gray-700">Current Medication</label>
                                                    <input type="text" x-model="newRecord.current_medication" placeholder="Gamot"
                                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors text-sm">
                                                </div>
                                                <div class="space-y-1.5">
                                                    <label class="block text-xs font-semibold text-gray-700">Medication Schedule</label>
                                                    <input type="text" x-model="newRecord.medication_schedule" placeholder="Oras"
                                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors text-sm">
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Column 2: Vital Signs -->
                                        <div class="bg-green-50 p-4 rounded-xl border border-green-200">
                                            <h4 class="text-base font-semibold text-green-900 mb-3">Vital Signs</h4>
                                            <div class="space-y-3">
                                                <div class="grid grid-cols-2 gap-2">
                                                    <div class="space-y-1.5">
                                                        <label class="block text-xs font-semibold text-gray-700">BP Systolic</label>
                                                        <input type="number" x-model="newRecord.blood_pressure_systolic" placeholder="120"
                                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors text-sm">
                                                    </div>
                                                    <div class="space-y-1.5">
                                                        <label class="block text-xs font-semibold text-gray-700">BP Diastolic</label>
                                                        <input type="number" x-model="newRecord.blood_pressure_diastolic" placeholder="80"
                                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors text-sm">
                                                    </div>
                                                </div>
                                                <div class="space-y-1.5">
                                                    <label class="block text-xs font-semibold text-gray-700">Pulse Rate</label>
                                                    <input type="number" x-model="newRecord.pulse_rate" placeholder="72"
                                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors text-sm">
                                                </div>
                                                <div class="space-y-1.5">
                                                    <label class="block text-xs font-semibold text-gray-700">Temperature (Â°C)</label>
                                                    <input type="number" step="0.1" x-model="newRecord.temperature" placeholder="36.5"
                                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors text-sm">
                                                </div>
                                                <div class="space-y-1.5">
                                                    <label class="block text-xs font-semibold text-gray-700">Respiratory Rate</label>
                                                    <input type="number" x-model="newRecord.respiratory_rate" placeholder="16"
                                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors text-sm">
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Column 3: Physical Measurements -->
                                        <div class="bg-purple-50 p-4 rounded-xl border border-purple-200">
                                            <h4 class="text-base font-semibold text-purple-900 mb-3">Physical Measurements</h4>
                                            <div class="space-y-3">
                                                <div class="space-y-1.5">
                                                    <label class="block text-xs font-semibold text-gray-700">Weight (kg)</label>
                                                    <input type="number" step="0.1" x-model="newRecord.weight" placeholder="70.0"
                                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors text-sm">
                                                </div>
                                                <div class="space-y-1.5">
                                                    <label class="block text-xs font-semibold text-gray-700">Height (cm)</label>
                                                    <input type="number" x-model="newRecord.height" placeholder="170"
                                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors text-sm">
                                                </div>
                                                <div class="space-y-1.5">
                                                    <label class="block text-xs font-semibold text-gray-700">BMI</label>
                                                    <input type="text" readonly x-model="calculateBMI()" placeholder="Calculated"
                                                           class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg text-gray-600 text-sm">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Clinical Assessment -->
                                    <div class="space-y-4 sm:space-y-6">
                                        <div class="space-y-3">
                                            <label class="block text-sm font-semibold text-gray-700">Symptoms *</label>
                                            
                                            <!-- Quick Select Dropdown -->
                                            <div class="space-y-2">
                                                <label class="block text-xs font-medium text-gray-600">Quick Select (Optional)</label>
                                                <select x-ref="symptomsDropdown" @change="if($event.target.value !== 'Other (specify)') { newRecord.symptoms = $event.target.value; } else { newRecord.symptoms = ''; }" 
                                                        class="w-full px-3 sm:px-4 py-2.5 sm:py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors text-base">
                                                    <option value="">-- Select common symptoms --</option>
                                                    <template x-for="symptom in commonSymptoms" :key="symptom">
                                                        <option :value="symptom" x-text="symptom"></option>
                                                    </template>
                                                </select>
                                            </div>
                                            
                                            <!-- Manual Input -->
                                            <div class="space-y-2">
                                                <label class="block text-xs font-medium text-gray-600">Or describe manually:</label>
                                                <textarea x-model="newRecord.symptoms" rows="3" required placeholder="Describe the patient's symptoms..."
                                                          class="w-full px-3 sm:px-4 py-2.5 sm:py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors resize-none text-base"></textarea>
                                            </div>
                                        </div>
                                        
        
                                        
                                        <div class="space-y-3">
                                            <label class="block text-sm font-semibold text-gray-700">Treatment *</label>
                                            
                                            <!-- Quick Select Dropdown -->
                                            <div class="space-y-2">
                                                <label class="block text-xs font-medium text-gray-600">Quick Select (Optional)</label>
                                                <select x-ref="treatmentDropdown" @change="if($event.target.value !== 'Other (specify)') { newRecord.treatment = $event.target.value; } else { newRecord.treatment = ''; }" 
                                                        class="w-full px-3 sm:px-4 py-2.5 sm:py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors text-base">
                                                    <option value="">-- Select common treatment --</option>
                                                    <template x-for="treatment in commonTreatments" :key="treatment">
                                                        <option :value="treatment" x-text="treatment"></option>
                                                    </template>
                                                </select>
                                            </div>
                                            
                                            <!-- Manual Input -->
                                            <div class="space-y-2">
                                                <label class="block text-xs font-medium text-gray-600">Or describe manually:</label>
                                                <textarea x-model="newRecord.treatment" rows="2" required placeholder="Treatment provided..."
                                                          class="w-full px-3 sm:px-4 py-2.5 sm:py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors resize-none text-base"></textarea>
                                            </div>
                                        </div>
                                        
                                        <!-- Prescribed Medicine Section -->
                                        <div class="space-y-4">
                                            <div class="flex items-center justify-between">
                                                <label class="block text-sm font-semibold text-gray-700">Prescribed Medicine</label>
                                                <button type="button" @click="addPrescribedMedicine()" 
                                                        class="px-3 py-1.5 bg-purple-500 hover:bg-purple-600 text-white text-xs rounded-lg font-medium transition-colors flex items-center gap-1">
                                                    <i data-feather="plus" class="w-3 h-3"></i>
                                                    Add Medicine
                                                </button>
                                            </div>

                                            <!-- Info Note -->
                                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 flex items-start gap-2">
                                                <svg class="w-4 h-4 text-blue-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                </svg>
                                                <p class="text-xs text-blue-700">Only <strong>non-expired medicines with available stock</strong> are shown in the dropdown. Expired medicines are automatically filtered out.</p>
                                            </div>

                                            <!-- Medicine List -->
                                            <div class="space-y-3" x-show="newRecord.prescribed_medicines.length > 0">
                                                <template x-for="(medicine, index) in newRecord.prescribed_medicines" :key="index">
                                                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                                                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                                            <!-- Medicine Selection -->
                                                            <div class="space-y-2">
                                                                <label class="block text-xs font-medium text-gray-600">Medicine</label>
                                                                <select x-model="medicine.medicine_id" 
                                                                        @change="updateMedicineName(index, $event.target.value)"
                                                                        class="w-full px-3 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 text-sm">
                                                                    <option value="">Select medicine...</option>
                                                                    <template x-for="med in availableMedicines" :key="med.id">
                                                                        <option :value="med.id" 
                                                                                x-text="`${med.medicine_name}${med.strength ? ' ' + med.strength : ''}${med.dosage_form ? ' (' + med.dosage_form + ')' : ''} - Stock: ${med.quantity}${med.expiry_date ? ' | Exp: ' + med.expiry_date : ''}`"></option>
                                                                    </template>
                                                                </select>
                                                            </div>

                                                            <!-- Quantity -->
                                                            <div class="space-y-2">
                                                                <label class="block text-xs font-medium text-gray-600">Quantity</label>
                                                                <div class="flex items-center gap-2">
                                                                    <input type="number" x-model="medicine.quantity" min="1" 
                                                                           :max="getMedicineStock(medicine.medicine_id)"
                                                                           class="flex-1 px-3 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 text-sm">
                                                                    <span class="text-xs text-gray-500" x-show="medicine.medicine_id" 
                                                                          x-text="`/ ${getMedicineStock(medicine.medicine_id)}`"></span>
                                                                </div>
                                                            </div>

                                                            <!-- Dosage -->
                                                            <div class="space-y-2">
                                                                <label class="block text-xs font-medium text-gray-600">Dosage</label>
                                                                <input type="text" x-model="medicine.dosage" placeholder="e.g., 500mg"
                                                                       class="w-full px-3 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 text-sm">
                                                            </div>

                                                            <!-- Instructions -->
                                                            <div class="space-y-2">
                                                                <label class="block text-xs font-medium text-gray-600">Instructions</label>
                                                                <input type="text" x-model="medicine.instructions" placeholder="e.g., Take after meals"
                                                                       class="w-full px-3 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 text-sm">
                                                            </div>
                                                        </div>

                                                        <!-- Remove Button -->
                                                        <div class="mt-3 flex justify-end">
                                                            <button type="button" @click="removePrescribedMedicine(index)"
                                                                    class="px-3 py-1.5 bg-red-500 hover:bg-red-600 text-white text-xs rounded-lg font-medium transition-colors flex items-center gap-1">
                                                                <i data-feather="trash-2" class="w-3 h-3"></i>
                                                                Remove
                                                            </button>
                                                        </div>
                                                    </div>
                                                </template>
                                            </div>

                                            <!-- Fallback textarea for manual entry -->
                                            <div class="space-y-2" x-show="newRecord.prescribed_medicines.length === 0">
                                                <label class="block text-xs font-medium text-gray-600">Or enter manually:</label>
                                                <textarea x-model="newRecord.prescribed_medicine" rows="2" placeholder="Medicine prescribed (if any)..."
                                                          class="w-full px-3 sm:px-4 py-2.5 sm:py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors resize-none text-base"></textarea>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Procedures Section -->
                                    <div class="bg-yellow-50 p-4 sm:p-6 rounded-xl border border-yellow-200">
                                        <h4 class="text-base sm:text-lg font-semibold text-yellow-900 mb-3 sm:mb-4">Procedures & Special Instructions</h4>
                                        <div class="space-y-3 sm:space-y-4">
                                            <div class="space-y-3">
                                                <label class="block text-sm font-semibold text-gray-700">Dental/Medical Procedure</label>
                                                
                                                <!-- Quick Select Dropdown -->
                                                <div class="space-y-2">
                                                    <label class="block text-xs font-medium text-gray-600">Quick Select (Optional)</label>
                                                    <select x-ref="dentalProcedureDropdown" @change="if($event.target.value !== 'Other (specify)') { newRecord.dental_procedure = $event.target.value; } else { newRecord.dental_procedure = ''; }" 
                                                            class="w-full px-3 sm:px-4 py-2.5 sm:py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-colors text-base">
                                                        <option value="">-- Select common procedure --</option>
                                                        <template x-for="procedure in commonProcedures" :key="procedure">
                                                            <option :value="procedure" x-text="procedure"></option>
                                                        </template>
                                                    </select>
                                                </div>
                                                
                                                <!-- Manual Input -->
                                                <div class="space-y-2">
                                                    <label class="block text-xs font-medium text-gray-600">Or type manually:</label>
                                                    <input type="text" x-model="newRecord.dental_procedure" placeholder="Bunot ng ngipin, injection, etc."
                                                           class="w-full px-3 sm:px-4 py-2.5 sm:py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-colors text-base">
                                                </div>
                                            </div>
                                            <div class="space-y-2">
                                                <label class="block text-sm font-semibold text-gray-700">Procedure Notes</label>
                                                <textarea x-model="newRecord.procedure_notes" rows="2" placeholder="Details about the procedure performed..."
                                                          class="w-full px-3 sm:px-4 py-2.5 sm:py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-colors resize-none text-base"></textarea>
                                            </div>
                                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                                                <div class="space-y-2">
                                                    <label class="block text-sm font-semibold text-gray-700">Follow-up Date</label>
                                                    <input type="date" x-model="newRecord.follow_up_date"
                                                           class="w-full px-3 sm:px-4 py-2.5 sm:py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-colors text-base">
                                                </div>
                                                <div class="space-y-3">
                                                    <label class="block text-sm font-semibold text-gray-700">Special Instructions</label>
                                                    
                                                    <!-- Quick Select Dropdown -->
                                                    <div class="space-y-2">
                                                        <label class="block text-xs font-medium text-gray-600">Quick Select (Optional)</label>
                                                        <select x-ref="instructionsDropdown" @change="if($event.target.value !== 'Other (specify)') { newRecord.special_instructions = $event.target.value; } else { newRecord.special_instructions = ''; }" 
                                                                class="w-full px-3 sm:px-4 py-2.5 sm:py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-colors text-base">
                                                            <option value="">-- Select common instructions --</option>
                                                            <template x-for="instruction in commonInstructions" :key="instruction">
                                                                <option :value="instruction" x-text="instruction"></option>
                                                            </template>
                                                        </select>
                                                    </div>
                                                    
                                                    <!-- Manual Input -->
                                                    <div class="space-y-2">
                                                        <label class="block text-xs font-medium text-gray-600">Or type manually:</label>
                                                        <textarea x-model="newRecord.special_instructions" rows="2" placeholder="Special care instructions..."
                                                                  class="w-full px-3 sm:px-4 py-2.5 sm:py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-colors resize-none text-base"></textarea>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Clinic Stay Section -->
                                    <div class="bg-green-50 border border-green-200 rounded-xl p-4 space-y-4">
                                        <div class="flex items-center gap-2">
                                            <i data-feather="home" class="w-5 h-5 text-green-600"></i>
                                            <h4 class="text-lg font-semibold text-green-800">Clinic Stay Monitoring</h4>
                                        </div>
                                        
                                        <div class="flex items-center gap-3">
                                            <input type="checkbox" x-model="newRecord.will_stay_in_clinic" id="will_stay_checkbox"
                                                   class="w-4 h-4 text-green-600 bg-gray-100 border-gray-300 rounded focus:ring-green-500 focus:ring-2">
                                            <label for="will_stay_checkbox" class="text-sm font-medium text-gray-700">
                                                Patient will stay in clinic for rest/observation
                                            </label>
                                        </div>
                                        
                                        <div x-show="newRecord.will_stay_in_clinic" x-transition class="space-y-4">
                                            <div>
                                                <label class="block text-sm font-semibold text-gray-700 mb-2">Reason for Stay *</label>
                                                <textarea x-model="newRecord.stay_reason" rows="2" 
                                                          placeholder="e.g., Rest after medication, observation for symptoms, recovery from procedure..."
                                                          class="w-full px-3 sm:px-4 py-2.5 sm:py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors resize-none text-base"></textarea>
                                            </div>
                                            
                                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                                <div class="flex items-center gap-2">
                                                    <i data-feather="info" class="w-4 h-4 text-blue-600"></i>
                                                    <span class="text-sm text-blue-800 font-medium">Note:</span>
                                                </div>
                                                <p class="text-sm text-blue-700 mt-1">Patient will be admitted to clinic for monitoring. You can discharge the patient later when they are ready to leave.</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Additional Notes -->
                                    <div class="space-y-2">
                                        <label class="block text-sm font-semibold text-gray-700">Additional Notes</label>
                                        <textarea x-model="newRecord.notes" rows="3" placeholder="Any additional notes or observations..."
                                                  class="w-full px-3 sm:px-4 py-2.5 sm:py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors resize-none text-base"></textarea>
                                    </div>
                                </div>
                                
                                <!-- Modal Footer -->
                                <div class="bg-gray-50 px-4 sm:px-6 md:px-8 py-4 sm:py-6 rounded-b-2xl">
                                    <div class="flex flex-col sm:flex-row justify-end gap-3 sm:gap-4">
                                        <button type="button" @click="showAddRecordModal = false" 
                                                class="w-full sm:w-auto px-4 sm:px-6 py-2.5 sm:py-3 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-xl transition-colors text-base">
                                            Cancel
                                        </button>
                                        <button type="submit" 
                                                class="w-full sm:w-auto px-4 sm:px-6 py-2.5 sm:py-3 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-semibold rounded-xl transition-all transform hover:scale-105 shadow-lg hover:shadow-xl text-base">
                                            Save Medical Record
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Edit Medical Record Modal -->
                <div x-show="showEditRecordModal && editingRecord" x-cloak class="fixed inset-0 z-[60] flex items-center justify-center p-2 sm:p-4" style="display: none;" x-transition>
                    <div class="fixed inset-0 bg-gray-900 bg-opacity-50 backdrop-blur-sm" @click="showEditRecordModal = false" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"></div>
                    <div class="relative bg-white rounded-2xl shadow-2xl max-w-[64vw] w-full max-h-[95vh] overflow-y-auto z-10" @click.stop x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100">
                        <!-- Modal Header -->
                        <div class="sticky top-0 bg-gradient-to-r from-amber-500 to-amber-600 text-white px-4 sm:px-6 md:px-8 py-4 sm:py-6 rounded-t-2xl z-10">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2 sm:gap-3 flex-1 min-w-0">
                                    <div class="w-8 h-8 sm:w-10 sm:h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center flex-shrink-0">
                                        <i data-feather="edit-2" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                                    </div>
                                    <div class="min-w-0">
                                        <h3 class="text-lg sm:text-xl font-semibold truncate">Edit Medical Record</h3>
                                        <p class="text-amber-100 text-xs sm:text-sm truncate" x-text="selectedPatient ? 'for ' + selectedPatient.name : ''"></p>
                                    </div>
                                </div>
                                <button @click="showEditRecordModal = false; editingRecord = null; showViewRecordModal = true" class="w-8 h-8 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-full flex items-center justify-center transition-colors flex-shrink-0 ml-2">
                                    <i data-feather="x" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Form Content -->
                        <template x-if="editingRecord">
                            <div class="p-4 sm:p-6 md:p-8">
                                <form @submit.prevent="updateMedicalRecord()">
                                <div class="space-y-6">
                                    <!-- Record ID Info (Full Width) -->
                                    <div class="bg-amber-50 p-4 rounded-xl border-l-4 border-amber-500">
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">Record Information</label>
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 bg-amber-100 rounded-full flex items-center justify-center flex-shrink-0">
                                                <i data-feather="file-text" class="w-5 h-5 text-amber-600"></i>
                                            </div>
                                            <div class="min-w-0">
                                                <p class="font-medium text-gray-900 text-base" x-text="editingRecord ? 'Record #' + editingRecord.id : ''"></p>
                                                <p class="text-sm text-gray-600" x-text="editingRecord ? editingRecord.date + ' at ' + editingRecord.time : ''"></p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Reason for Visit (Full Width) -->
                                    <div class="space-y-3">
                                        <label class="block text-sm font-semibold text-gray-700">Reason for Visit *</label>
                                        
                                        <!-- Quick Select Dropdown -->
                                        <div class="space-y-2">
                                            <label class="block text-xs font-medium text-gray-600">Quick Select (Optional)</label>
                                            <select @change="if($event.target.value !== 'Other (specify)') { editingRecord.chief_complaint = $event.target.value; }" 
                                                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors text-base">
                                                <option value="">-- Select common complaint --</option>
                                                <template x-for="complaint in commonComplaints" :key="complaint">
                                                    <option :value="complaint" x-text="complaint"></option>
                                                </template>
                                            </select>
                                        </div>
                                        
                                        <!-- Manual Input -->
                                        <div class="space-y-2">
                                            <label class="block text-xs font-medium text-gray-600">Or type manually:</label>
                                            <textarea x-model="editingRecord.chief_complaint" rows="2" required placeholder="Main reason for visit (e.g., Bunot ng ngipin, headache, fever)..."
                                                      class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors resize-none text-base"></textarea>
                                        </div>
                                    </div>

                                    <!-- Three Column Layout: Medical History | Vital Signs | Physical Measurements -->
                                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                                        <!-- Column 1: Medical History -->
                                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-200">
                                            <h4 class="text-base font-semibold text-blue-900 mb-3">Medical History</h4>
                                            <div class="space-y-3">
                                                <div class="space-y-1.5">
                                                    <label class="block text-xs font-semibold text-gray-700">Medical History</label>
                                                    <textarea x-model="editingRecord.medical_history" rows="2" placeholder="Previous conditions..."
                                                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors resize-none text-sm"></textarea>
                                                </div>
                                                <div class="space-y-1.5">
                                                    <label class="block text-xs font-semibold text-gray-700">Fever Duration</label>
                                                    <input type="text" x-model="editingRecord.fever_duration" placeholder="Ilang araw"
                                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors text-sm">
                                                </div>
                                                <div class="space-y-1.5">
                                                    <label class="block text-xs font-semibold text-gray-700">Current Medication</label>
                                                    <input type="text" x-model="editingRecord.current_medication" placeholder="Gamot"
                                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors text-sm">
                                                </div>
                                                <div class="space-y-1.5">
                                                    <label class="block text-xs font-semibold text-gray-700">Medication Schedule</label>
                                                    <input type="text" x-model="editingRecord.medication_schedule" placeholder="Oras"
                                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors text-sm">
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Column 2: Vital Signs -->
                                        <div class="bg-green-50 p-4 rounded-xl border border-green-200">
                                            <h4 class="text-base font-semibold text-green-900 mb-3">Vital Signs</h4>
                                            <div class="space-y-3">
                                                <div class="grid grid-cols-2 gap-2">
                                                    <div class="space-y-1.5">
                                                        <label class="block text-xs font-semibold text-gray-700">BP Systolic</label>
                                                        <input type="number" x-model="editingRecord.blood_pressure_systolic" placeholder="120"
                                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors text-sm">
                                                    </div>
                                                    <div class="space-y-1.5">
                                                        <label class="block text-xs font-semibold text-gray-700">BP Diastolic</label>
                                                        <input type="number" x-model="editingRecord.blood_pressure_diastolic" placeholder="80"
                                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors text-sm">
                                                    </div>
                                                </div>
                                                <div class="space-y-1.5">
                                                    <label class="block text-xs font-semibold text-gray-700">Pulse Rate</label>
                                                    <input type="number" x-model="editingRecord.pulse_rate" placeholder="72"
                                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors text-sm">
                                                </div>
                                                <div class="space-y-1.5">
                                                    <label class="block text-xs font-semibold text-gray-700">Temperature (Â°C)</label>
                                                    <input type="number" step="0.1" x-model="editingRecord.temperature" placeholder="36.5"
                                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors text-sm">
                                                </div>
                                                <div class="space-y-1.5">
                                                    <label class="block text-xs font-semibold text-gray-700">Respiratory Rate</label>
                                                    <input type="number" x-model="editingRecord.respiratory_rate" placeholder="16"
                                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors text-sm">
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Column 3: Physical Measurements -->
                                        <div class="bg-purple-50 p-4 rounded-xl border border-purple-200">
                                            <h4 class="text-base font-semibold text-purple-900 mb-3">Physical Measurements</h4>
                                            <div class="space-y-3">
                                                <div class="space-y-1.5">
                                                    <label class="block text-xs font-semibold text-gray-700">Weight (kg)</label>
                                                    <input type="number" step="0.1" x-model="editingRecord.weight" placeholder="70.0"
                                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors text-sm">
                                                </div>
                                                <div class="space-y-1.5">
                                                    <label class="block text-xs font-semibold text-gray-700">Height (cm)</label>
                                                    <input type="number" x-model="editingRecord.height" placeholder="170"
                                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors text-sm">
                                                </div>
                                                <div class="space-y-1.5">
                                                    <label class="block text-xs font-semibold text-gray-700">BMI</label>
                                                    <input type="text" readonly :value="editingRecord && editingRecord.weight && editingRecord.height ? (editingRecord.weight / ((editingRecord.height / 100) ** 2)).toFixed(2) : ''" placeholder="Calculated"
                                                           class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg text-gray-600 text-sm">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Clinical Assessment -->
                                    <div class="space-y-4 sm:space-y-6">
                                        <div class="space-y-3">
                                            <label class="block text-sm font-semibold text-gray-700">Symptoms *</label>
                                            
                                            <!-- Quick Select Dropdown -->
                                            <div class="space-y-2">
                                                <label class="block text-xs font-medium text-gray-600">Quick Select (Optional)</label>
                                                <select @change="if($event.target.value !== 'Other (specify)') { editingRecord.symptoms = $event.target.value; }" 
                                                        class="w-full px-3 sm:px-4 py-2.5 sm:py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors text-base">
                                                    <option value="">-- Select common symptoms --</option>
                                                    <template x-for="symptom in commonSymptoms" :key="symptom">
                                                        <option :value="symptom" x-text="symptom"></option>
                                                    </template>
                                                </select>
                                            </div>
                                            
                                            <!-- Manual Input -->
                                            <div class="space-y-2">
                                                <label class="block text-xs font-medium text-gray-600">Or describe manually:</label>
                                                <textarea x-model="editingRecord.symptoms" rows="3" required placeholder="Describe the patient's symptoms..."
                                                          class="w-full px-3 sm:px-4 py-2.5 sm:py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors resize-none text-base"></textarea>
                                            </div>
                                        </div>
                                        
                                        <div class="space-y-3">
                                            <label class="block text-sm font-semibold text-gray-700">Treatment *</label>
                                            
                                            <!-- Quick Select Dropdown -->
                                            <div class="space-y-2">
                                                <label class="block text-xs font-medium text-gray-600">Quick Select (Optional)</label>
                                                <select @change="if($event.target.value !== 'Other (specify)') { editingRecord.treatment = $event.target.value; }" 
                                                        class="w-full px-3 sm:px-4 py-2.5 sm:py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors text-base">
                                                    <option value="">-- Select common treatment --</option>
                                                    <template x-for="treatment in commonTreatments" :key="treatment">
                                                        <option :value="treatment" x-text="treatment"></option>
                                                    </template>
                                                </select>
                                            </div>
                                            
                                            <!-- Manual Input -->
                                            <div class="space-y-2">
                                                <label class="block text-xs font-medium text-gray-600">Or describe manually:</label>
                                                <textarea x-model="editingRecord.treatment" rows="2" required placeholder="Treatment provided..."
                                                          class="w-full px-3 sm:px-4 py-2.5 sm:py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors resize-none text-base"></textarea>
                                            </div>
                                        </div>
                                        
                                        <!-- Prescribed Medicine Section -->
                                        <div class="space-y-4">
                                            <div class="flex items-center justify-between">
                                                <label class="block text-sm font-semibold text-gray-700">Prescribed Medicine</label>
                                                <button type="button" @click="editingRecord.prescribed_medicines = editingRecord.prescribed_medicines || []; editingRecord.prescribed_medicines.push({ medicine_id: '', medicine_name: '', quantity: 1, dosage: '', instructions: '' }); $nextTick(() => { try { feather.replace(); } catch(e) {} })" 
                                                        class="px-3 py-1.5 bg-purple-500 hover:bg-purple-600 text-white text-xs rounded-lg font-medium transition-colors flex items-center gap-1">
                                                    <i data-feather="plus" class="w-3 h-3"></i>
                                                    Add Medicine
                                                </button>
                                            </div>

                                            <!-- Info Note -->
                                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 flex items-start gap-2">
                                                <svg class="w-4 h-4 text-blue-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                </svg>
                                                <p class="text-xs text-blue-700">Only <strong>non-expired medicines with available stock</strong> are shown in the dropdown. Expired medicines are automatically filtered out.</p>
                                            </div>

                                            <!-- Medicine List -->
                                            <div class="space-y-3" x-show="editingRecord.prescribed_medicines && editingRecord.prescribed_medicines.length > 0">
                                                <template x-for="(medicine, index) in editingRecord.prescribed_medicines" :key="index">
                                                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                                                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                                            <!-- Medicine Selection -->
                                                            <div class="space-y-2">
                                                                <label class="block text-xs font-medium text-gray-600">Medicine</label>
                                                                <select x-model="medicine.medicine_id" 
                                                                        @change="medicine.medicine_name = availableMedicines.find(m => m.id == medicine.medicine_id)?.medicine_name || ''"
                                                                        class="w-full px-3 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 text-sm">
                                                                    <option value="">Select medicine...</option>
                                                                    <template x-for="med in availableMedicines" :key="med.id">
                                                                        <option :value="med.id" 
                                                                                x-text="`${med.medicine_name}${med.strength ? ' ' + med.strength : ''}${med.dosage_form ? ' (' + med.dosage_form + ')' : ''} - Stock: ${med.quantity}${med.expiry_date ? ' | Exp: ' + med.expiry_date : ''}`"></option>
                                                                    </template>
                                                                </select>
                                                            </div>

                                                            <!-- Quantity -->
                                                            <div class="space-y-2">
                                                                <label class="block text-xs font-medium text-gray-600">Quantity</label>
                                                                <div class="flex items-center gap-2">
                                                                    <input type="number" x-model="medicine.quantity" min="1" 
                                                                           :max="getMedicineStock(medicine.medicine_id)"
                                                                           class="flex-1 px-3 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 text-sm">
                                                                    <span class="text-xs text-gray-500" x-show="medicine.medicine_id" 
                                                                          x-text="`/ ${getMedicineStock(medicine.medicine_id)}`"></span>
                                                                </div>
                                                            </div>

                                                            <!-- Dosage -->
                                                            <div class="space-y-2">
                                                                <label class="block text-xs font-medium text-gray-600">Dosage</label>
                                                                <input type="text" x-model="medicine.dosage" placeholder="e.g., 500mg"
                                                                       class="w-full px-3 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 text-sm">
                                                            </div>

                                                            <!-- Instructions -->
                                                            <div class="space-y-2">
                                                                <label class="block text-xs font-medium text-gray-600">Instructions</label>
                                                                <input type="text" x-model="medicine.instructions" placeholder="e.g., Take after meals"
                                                                       class="w-full px-3 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 text-sm">
                                                            </div>
                                                        </div>

                                                        <!-- Remove Button -->
                                                        <div class="mt-3 flex justify-end">
                                                            <button type="button" @click="editingRecord.prescribed_medicines.splice(index, 1); $nextTick(() => { try { feather.replace(); } catch(e) {} })"
                                                                    class="px-3 py-1.5 bg-red-500 hover:bg-red-600 text-white text-xs rounded-lg font-medium transition-colors flex items-center gap-1">
                                                                <i data-feather="trash-2" class="w-3 h-3"></i>
                                                                Remove
                                                            </button>
                                                        </div>
                                                    </div>
                                                </template>
                                            </div>

                                            <!-- Fallback textarea for manual entry -->
                                            <div class="space-y-2" x-show="!editingRecord.prescribed_medicines || editingRecord.prescribed_medicines.length === 0">
                                                <label class="block text-xs font-medium text-gray-600">Or enter manually:</label>
                                                <textarea x-model="editingRecord.prescribed_medicine" rows="2" placeholder="Medicine prescribed (if any)..."
                                                          class="w-full px-3 sm:px-4 py-2.5 sm:py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors resize-none text-base"></textarea>
                                            </div>
                                        </div>
                                        
                                        <!-- Additional Notes -->
                                        <div class="space-y-2">
                                            <label class="block text-sm font-semibold text-gray-700">Additional Notes</label>
                                            <textarea x-model="editingRecord.notes" rows="3" placeholder="Any additional notes or observations..."
                                                      class="w-full px-3 sm:px-4 py-2.5 sm:py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors resize-none text-base"></textarea>
                                        </div>
                                    </div>
                                </div>

                                <!-- Modal Footer -->
                                <div class="bg-gray-50 px-4 sm:px-6 md:px-8 py-4 sm:py-6 rounded-b-2xl mt-6">
                                    <div class="flex flex-col sm:flex-row justify-end gap-3 sm:gap-4">
                                        <button type="button" @click="showEditRecordModal = false; editingRecord = null; showViewRecordModal = true" 
                                                class="w-full sm:w-auto px-4 sm:px-6 py-2.5 sm:py-3 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-xl transition-colors text-base">
                                            Cancel
                                        </button>
                                        <button type="submit" 
                                                :disabled="addingRecord"
                                                class="w-full sm:w-auto px-4 sm:px-6 py-2.5 sm:py-3 bg-amber-600 hover:bg-amber-700 text-white font-semibold rounded-xl transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-base flex items-center justify-center gap-2">
                                            <span x-show="!addingRecord">Update Record</span>
                                            <span x-show="addingRecord" class="flex items-center gap-2">
                                                <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                </svg>
                                                Updating...
                                            </span>
                                        </button>
                                    </div>
                                </div>
                            </form>
                            </div>
                        </template>
                    </div>
                </div>
            </main>
        </div>
    </div>


    <!-- Settings Modal -->
    <div x-show="showSettingsModal" 
         x-cloak
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-2 sm:p-4"
         @click.self="showSettingsModal = false">
        <div class="bg-white rounded-lg sm:rounded-xl shadow-xl w-full max-w-2xl mx-2 sm:mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-4 sm:p-6">
                <div class="flex justify-between items-center mb-4 sm:mb-6">
                    <h3 class="text-lg sm:text-xl font-semibold text-gray-900">Settings</h3>
                    <button @click="showSettingsModal = false" class="text-gray-400 hover:text-gray-600 touch-target">
                        <i data-feather="x" class="w-5 h-5 sm:w-6 sm:h-6"></i>
                    </button>
                </div>
                
                <form class="space-y-4 sm:space-y-6">
                    <!-- Profile Settings -->
                    <div>
                        <h4 class="text-base sm:text-lg font-medium text-gray-900 mb-3 sm:mb-4">Profile Information</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4">
                            <div>
                                <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1.5 sm:mb-2">Full Name</label>
                                <input type="text" value="{{ user.first_name }} {{ user.last_name }}" 
                                       class="w-full px-3 py-2 sm:py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base touch-target">
                            </div>
                            <div>
                                <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1.5 sm:mb-2">Email</label>
                                <input type="email" value="{{ user.username }}" 
                                       class="w-full px-3 py-2 sm:py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base touch-target">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Security Settings -->
                    <div>
                        <h4 class="text-base sm:text-lg font-medium text-gray-900 mb-3 sm:mb-4">Security</h4>
                        <div class="space-y-3 sm:space-y-4">
                            <div>
                                <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1.5 sm:mb-2">Current Password</label>
                                <input type="password" placeholder="Enter current password" 
                                       class="w-full px-3 py-2 sm:py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base touch-target">
                            </div>
                            <div>
                                <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1.5 sm:mb-2">New Password</label>
                                <input type="password" placeholder="Enter new password" 
                                       class="w-full px-3 py-2 sm:py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base touch-target">
                            </div>
                            <div>
                                <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1.5 sm:mb-2">Confirm New Password</label>
                                <input type="password" placeholder="Confirm new password" 
                                       class="w-full px-3 py-2 sm:py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base touch-target">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notification Settings -->
                    <div>
                        <h4 class="text-base sm:text-lg font-medium text-gray-900 mb-3 sm:mb-4">Notifications</h4>
                        <div class="space-y-2 sm:space-y-3">
                            <label class="flex items-center touch-target">
                                <input type="checkbox" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 w-4 h-4">
                                <span class="ml-2 text-xs sm:text-sm text-gray-700">Email notifications for new appointments</span>
                            </label>
                            <label class="flex items-center touch-target">
                                <input type="checkbox" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 w-4 h-4">
                                <span class="ml-2 text-xs sm:text-sm text-gray-700">SMS notifications for urgent matters</span>
                            </label>
                            <label class="flex items-center touch-target">
                                <input type="checkbox" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 w-4 h-4">
                                <span class="ml-2 text-xs sm:text-sm text-gray-700">Weekly summary reports</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row justify-end gap-2 sm:gap-3 pt-3 sm:pt-4">
                        <button type="button" @click="showSettingsModal = false"
                                class="w-full sm:w-auto px-4 py-2.5 sm:py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 text-sm sm:text-base font-medium touch-target">
                            Cancel
                        </button>
                        <button type="submit"
                                class="w-full sm:w-auto px-4 py-2.5 sm:py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm sm:text-base font-medium touch-target">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div x-show="showLogoutConfirm" 
         x-cloak
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-2 sm:p-4"
         @click.self="showLogoutConfirm = false">
        <div class="bg-white rounded-lg sm:rounded-xl shadow-xl w-full max-w-md mx-2 sm:mx-4">
            <div class="p-4 sm:p-6">
                <div class="flex items-center mb-3 sm:mb-4">
                    <div class="w-9 h-9 sm:w-10 sm:h-10 bg-red-100 rounded-full flex items-center justify-center mr-2 sm:mr-3">
                        <i data-feather="log-out" class="w-4 h-4 sm:w-5 sm:h-5 text-red-600"></i>
                    </div>
                    <h3 class="text-base sm:text-lg font-semibold text-gray-900">Confirm Logout</h3>
                </div>
                
                <p class="text-sm sm:text-base text-gray-600 mb-4 sm:mb-6">Are you sure you want to logout? You will need to login again to access the system.</p>
                
                <div class="flex flex-col sm:flex-row justify-end gap-2 sm:gap-3">
                    <button @click="showLogoutConfirm = false"
                            class="w-full sm:w-auto px-4 py-2.5 sm:py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 text-sm sm:text-base font-medium touch-target">
                        Cancel
                    </button>
                    <button @click="window.location.href = '{{ url_for('logout') }}'"
                            class="w-full sm:w-auto px-4 py-2.5 sm:py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm sm:text-base font-medium touch-target">
                        Yes, Logout
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Medical Record Modal -->
    <div x-show="showViewRecordModal && viewingRecord && !showEditRecordModal" 
         x-transition:enter="transition ease-out duration-300" 
         x-transition:enter-start="opacity-0" 
         x-transition:enter-end="opacity-100" 
         x-transition:leave="transition ease-in duration-200" 
         x-transition:leave-start="opacity-100" 
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-2 sm:p-4" 
         style="display: none;">
        <div x-show="showViewRecordModal && viewingRecord" 
             x-transition:enter="transition ease-out duration-300" 
             x-transition:enter-start="opacity-0 transform scale-95" 
             x-transition:enter-end="opacity-100 transform scale-100" 
             x-transition:leave="transition ease-in duration-200" 
             x-transition:leave-start="opacity-100 transform scale-100" 
             x-transition:leave-end="opacity-0 transform scale-95"
             class="bg-white rounded-lg sm:rounded-xl shadow-2xl max-w-2xl w-full mx-2 sm:mx-4 max-h-[90vh] overflow-y-auto">
            
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-4 sm:p-6 rounded-t-lg sm:rounded-t-xl">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2 sm:gap-3">
                        <div class="w-9 h-9 sm:w-10 sm:h-10 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                            <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-base sm:text-xl font-bold">Medical Record Details</h3>
                            <p class="text-blue-100 text-xs sm:text-sm" x-text="viewingRecord ? formatDateTime(viewingRecord.visit_date) : ''"></p>
                        </div>
                    </div>
                    <button @click="showViewRecordModal = false; viewingRecord = null;" 
                            class="text-white hover:text-blue-200 transition-colors touch-target">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Modal Content -->
            <template x-if="viewingRecord">
                <div class="p-4 sm:p-6 space-y-4 sm:space-y-6">
                <!-- Medical Information Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                    <!-- Reason for Visit - Only show if filled -->
                    <div x-show="viewingRecord && viewingRecord.symptoms && viewingRecord.symptoms.trim() !== ''" class="bg-white border border-gray-200 rounded-lg sm:rounded-xl p-3 sm:p-4">
                        <div class="flex items-center gap-2 sm:gap-3 mb-2 sm:mb-3">
                            <div class="w-7 h-7 sm:w-8 sm:h-8 bg-red-100 rounded-lg flex items-center justify-center">
                                <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                            </div>
                            <h4 class="text-sm sm:text-base font-semibold text-gray-800">Reason for Visit</h4>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-2.5 sm:p-3">
                            <p class="text-xs sm:text-sm text-gray-800" x-text="viewingRecord.symptoms"></p>
                        </div>
                    </div>

                    <!-- Chief Complaint - Only show if filled -->
                    <div x-show="viewingRecord && viewingRecord.chief_complaint && viewingRecord.chief_complaint.trim() !== ''" class="bg-white border border-gray-200 rounded-lg sm:rounded-xl p-3 sm:p-4">
                        <div class="flex items-center gap-2 sm:gap-3 mb-2 sm:mb-3">
                            <div class="w-7 h-7 sm:w-8 sm:h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                                <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <h4 class="text-sm sm:text-base font-semibold text-gray-800">Chief Complaint</h4>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-2.5 sm:p-3">
                            <p class="text-xs sm:text-sm text-gray-800" x-text="viewingRecord.chief_complaint"></p>
                        </div>
                    </div>

                    <!-- Treatment - Only show if filled -->
                    <div x-show="viewingRecord && viewingRecord.treatment && viewingRecord.treatment.trim() !== ''" class="bg-white border border-gray-200 rounded-lg sm:rounded-xl p-3 sm:p-4">
                        <div class="flex items-center gap-2 sm:gap-3 mb-2 sm:mb-3">
                            <div class="w-7 h-7 sm:w-8 sm:h-8 bg-green-100 rounded-lg flex items-center justify-center">
                                <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                                </svg>
                            </div>
                            <h4 class="text-sm sm:text-base font-semibold text-gray-800">Treatment</h4>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-2.5 sm:p-3">
                            <p class="text-xs sm:text-sm text-gray-800" x-text="viewingRecord.treatment"></p>
                        </div>
                    </div>

                    <!-- Diagnosis - Only show if filled -->
                    <div x-show="viewingRecord && viewingRecord.diagnosis && viewingRecord.diagnosis.trim() !== ''" class="bg-white border border-gray-200 rounded-lg sm:rounded-xl p-3 sm:p-4">
                        <div class="flex items-center gap-2 sm:gap-3 mb-2 sm:mb-3">
                            <div class="w-7 h-7 sm:w-8 sm:h-8 bg-indigo-100 rounded-lg flex items-center justify-center">
                                <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                                </svg>
                            </div>
                            <h4 class="text-sm sm:text-base font-semibold text-gray-800">Diagnosis</h4>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-2.5 sm:p-3">
                            <p class="text-xs sm:text-sm text-gray-800" x-text="viewingRecord.diagnosis"></p>
                        </div>
                    </div>

                    <!-- Prescribed Medicine - Only show if filled -->
                    <div x-show="viewingRecord && viewingRecord.prescribed_medicine && viewingRecord.prescribed_medicine.trim() !== ''" class="bg-white border border-gray-200 rounded-lg sm:rounded-xl p-3 sm:p-4">
                        <div class="flex items-center gap-2 sm:gap-3 mb-2 sm:mb-3">
                            <div class="w-7 h-7 sm:w-8 sm:h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                                <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                                </svg>
                            </div>
                            <h4 class="text-sm sm:text-base font-semibold text-gray-800">Prescribed Medicine</h4>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-2.5 sm:p-3">
                            <p class="text-xs sm:text-sm text-gray-800" x-text="viewingRecord.prescribed_medicine"></p>
                        </div>
                    </div>

                    <!-- Vital Signs - Only show if at least one vital sign is filled -->
                    <div class="bg-white border border-gray-200 rounded-lg sm:rounded-xl p-3 sm:p-4 md:col-span-2" x-show="viewingRecord && ((viewingRecord.blood_pressure && viewingRecord.blood_pressure.trim() !== '') || (viewingRecord.temperature && viewingRecord.temperature != 0 && viewingRecord.temperature != '0.00') || (viewingRecord.heart_rate && viewingRecord.heart_rate != 0) || (viewingRecord.pulse_rate && viewingRecord.pulse_rate != 0) || (viewingRecord.respiratory_rate && viewingRecord.respiratory_rate != 0) || (viewingRecord.weight && viewingRecord.weight != 0 && viewingRecord.weight != '0.00') || (viewingRecord.height && viewingRecord.height != 0))">
                        <div class="flex items-center gap-2 sm:gap-3 mb-2 sm:mb-3">
                            <div class="w-7 h-7 sm:w-8 sm:h-8 bg-orange-100 rounded-lg flex items-center justify-center">
                                <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                                </svg>
                            </div>
                            <h4 class="text-sm sm:text-base font-semibold text-gray-800">Vital Signs</h4>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 sm:gap-4">
                            <div x-show="viewingRecord && viewingRecord.blood_pressure && viewingRecord.blood_pressure.trim() !== ''" class="text-center p-2 sm:p-3 bg-gray-50 rounded-lg">
                                <p class="text-xs text-gray-600 mb-0.5 sm:mb-1">Blood Pressure</p>
                                <p class="text-xs sm:text-sm font-semibold text-gray-800" x-text="viewingRecord.blood_pressure"></p>
                            </div>
                            <div x-show="viewingRecord && viewingRecord.temperature && viewingRecord.temperature != 0 && viewingRecord.temperature != '0.00'" class="text-center p-2 sm:p-3 bg-gray-50 rounded-lg">
                                <p class="text-xs text-gray-600 mb-0.5 sm:mb-1">Temperature</p>
                                <p class="text-xs sm:text-sm font-semibold text-gray-800" x-text="viewingRecord.temperature + 'Â°C'"></p>
                            </div>
                            <div x-show="viewingRecord && viewingRecord.pulse_rate && viewingRecord.pulse_rate != 0" class="text-center p-2 sm:p-3 bg-gray-50 rounded-lg">
                                <p class="text-xs text-gray-600 mb-0.5 sm:mb-1">Pulse Rate</p>
                                <p class="text-xs sm:text-sm font-semibold text-gray-800" x-text="viewingRecord.pulse_rate + ' bpm'"></p>
                            </div>
                            <div x-show="viewingRecord && viewingRecord.heart_rate && viewingRecord.heart_rate != 0" class="text-center p-2 sm:p-3 bg-gray-50 rounded-lg">
                                <p class="text-xs text-gray-600 mb-0.5 sm:mb-1">Heart Rate</p>
                                <p class="text-xs sm:text-sm font-semibold text-gray-800" x-text="viewingRecord.heart_rate + ' bpm'"></p>
                            </div>
                            <div x-show="viewingRecord && viewingRecord.respiratory_rate && viewingRecord.respiratory_rate != 0" class="text-center p-2 sm:p-3 bg-gray-50 rounded-lg">
                                <p class="text-xs text-gray-600 mb-0.5 sm:mb-1">Respiratory Rate</p>
                                <p class="text-xs sm:text-sm font-semibold text-gray-800" x-text="viewingRecord.respiratory_rate + ' /min'"></p>
                            </div>
                            <div x-show="viewingRecord && viewingRecord.weight && viewingRecord.weight != 0 && viewingRecord.weight != '0.00'" class="text-center p-2 sm:p-3 bg-gray-50 rounded-lg">
                                <p class="text-xs text-gray-600 mb-0.5 sm:mb-1">Weight</p>
                                <p class="text-xs sm:text-sm font-semibold text-gray-800" x-text="viewingRecord.weight + ' kg'"></p>
                            </div>
                            <div x-show="viewingRecord && viewingRecord.height && viewingRecord.height != 0" class="text-center p-2 sm:p-3 bg-gray-50 rounded-lg">
                                <p class="text-xs text-gray-600 mb-0.5 sm:mb-1">Height</p>
                                <p class="text-xs sm:text-sm font-semibold text-gray-800" x-text="viewingRecord.height + ' cm'"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Medical History - Only show if filled -->
                    <div x-show="viewingRecord && viewingRecord.medical_history && viewingRecord.medical_history.trim() !== ''" class="bg-white border border-gray-200 rounded-xl p-4 md:col-span-2">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-8 h-8 bg-teal-100 rounded-lg flex items-center justify-center">
                                <svg class="w-4 h-4 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <h4 class="font-semibold text-gray-800">Medical History</h4>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <p class="text-gray-900" x-text="viewingRecord.medical_history"></p>
                        </div>
                    </div>

                    <!-- Fever Duration - Only show if filled -->
                    <div x-show="viewingRecord && viewingRecord.fever_duration && viewingRecord.fever_duration.trim() !== ''" class="bg-white border border-gray-200 rounded-xl p-4">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center">
                                <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <h4 class="font-semibold text-gray-800">Fever Duration</h4>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-3">
                            <p class="text-gray-800" x-text="viewingRecord.fever_duration"></p>
                        </div>
                    </div>

                    <!-- Current Medication - Only show if filled -->
                    <div x-show="viewingRecord && viewingRecord.current_medication && viewingRecord.current_medication.trim() !== ''" class="bg-white border border-gray-200 rounded-xl p-4">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-8 h-8 bg-pink-100 rounded-lg flex items-center justify-center">
                                <svg class="w-4 h-4 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                                </svg>
                            </div>
                            <h4 class="font-semibold text-gray-800">Current Medication</h4>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-3">
                            <p class="text-gray-800" x-text="viewingRecord.current_medication"></p>
                        </div>
                    </div>

                    <!-- Medication Schedule - Only show if filled -->
                    <div x-show="viewingRecord && viewingRecord.medication_schedule && viewingRecord.medication_schedule.trim() !== ''" class="bg-white border border-gray-200 rounded-xl p-4">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-8 h-8 bg-cyan-100 rounded-lg flex items-center justify-center">
                                <svg class="w-4 h-4 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <h4 class="font-semibold text-gray-800">Medication Schedule</h4>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-3">
                            <p class="text-gray-800" x-text="viewingRecord.medication_schedule"></p>
                        </div>
                    </div>
                </div>

                <!-- Additional Notes - Only show if filled -->
                <div x-show="viewingRecord && viewingRecord.notes && viewingRecord.notes.trim() !== ''" class="bg-white border border-gray-200 rounded-xl p-6">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-8 h-8 bg-yellow-100 rounded-lg flex items-center justify-center">
                            <svg class="w-4 h-4 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                        </div>
                        <h4 class="font-semibold text-gray-800">Additional Notes</h4>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4 min-h-[80px]">
                        <p class="text-gray-900" x-text="viewingRecord.notes"></p>
                    </div>
                </div>

                <!-- Clinic Stay Status Indicator -->
                <div x-show="viewingRecord && viewingRecord.stay_status === 'staying'" 
                     class="bg-green-50 border border-green-200 rounded-lg p-4 mt-6">
                    <div class="flex items-center gap-3">
                        <i data-feather="home" class="w-5 h-5 text-green-600"></i>
                        <div>
                            <h4 class="text-sm font-semibold text-green-800">Patient Currently Staying in Clinic</h4>
                            <p class="text-xs text-green-700 mt-1" x-text="viewingRecord ? 'Reason: ' + (viewingRecord.stay_reason || 'Not specified') : ''"></p>
                            <p class="text-xs text-green-600 mt-1">Use "Discharge Patient" button below to record when patient leaves</p>
                        </div>
                    </div>
                </div>

                <!-- Modal Actions -->
                <div class="flex flex-col sm:flex-row justify-end gap-3 sm:gap-4 mt-8 pt-6 border-t border-gray-200">
                    <!-- Only show Admit button if patient is NOT currently staying -->
                    <!-- Admit to Clinic button - only show if not staying -->
                    <button x-show="!viewingRecord || !viewingRecord.stay_status || viewingRecord.stay_status === 'not_staying' || viewingRecord.stay_status === 'checked_out'" 
                            @click="openClinicStayModal(viewingRecord)" 
                            class="px-6 py-3 bg-green-500 hover:bg-green-600 text-white rounded-xl font-semibold transition-all duration-200 flex items-center justify-center gap-2">
                        <i data-feather="home" class="w-4 h-4"></i>
                        Admit to Clinic
                    </button>
                    
                    <!-- Discharge Patient button - only show if staying -->
                    <button x-show="viewingRecord && viewingRecord.stay_status === 'staying'" 
                            @click="selectedStay = viewingRecord; showCheckoutModal = true; showViewRecordModal = false;" 
                            class="px-6 py-3 bg-red-500 hover:bg-red-600 text-white rounded-xl font-semibold transition-all duration-200 flex items-center justify-center gap-2">
                        <i data-feather="log-out" class="w-4 h-4"></i>
                        Discharge Patient
                    </button>
                    
                    <!-- Edit Record button - always show -->
                    <button @click="editRecord(viewingRecord)" 
                            class="px-6 py-3 bg-amber-500 hover:bg-amber-600 text-white rounded-xl font-semibold transition-all duration-200 flex items-center justify-center gap-2">
                        <i data-feather="edit-2" class="w-4 h-4"></i>
                        Edit Record
                    </button>
                    
                    <button @click="showViewRecordModal = false; viewingRecord = null" 
                            class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-xl font-semibold transition-all duration-200 flex items-center justify-center gap-2">
                        <i data-feather="x" class="w-4 h-4"></i>
                        Close
                    </button>
                </div>
            </div>
            </div>
            </template>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div x-show="showDeleteConfirmModal" 
         x-transition:enter="transition ease-out duration-300" 
         x-transition:enter-start="opacity-0" 
         x-transition:enter-end="opacity-100" 
         x-transition:leave="transition ease-in duration-200" 
         x-transition:leave-start="opacity-100" 
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" 
         style="display: none;">
        <div x-show="showDeleteConfirmModal" 
             x-transition:enter="transition ease-out duration-300" 
             x-transition:enter-start="opacity-0 transform scale-95" 
             x-transition:enter-end="opacity-100 transform scale-100" 
             x-transition:leave="transition ease-in duration-200" 
             x-transition:leave-start="opacity-100 transform scale-100" 
             x-transition:leave-end="opacity-0 transform scale-95"
             class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4">
            
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-red-600 to-red-700 text-white p-6 rounded-t-xl">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold">Confirm Delete</h3>
                        <p class="text-red-100 text-sm">This action cannot be undone</p>
                    </div>
                </div>
            </div>

            <!-- Modal Content -->
            <div class="p-6" x-show="deletingRecord">
                <div class="mb-6">
                    <p class="text-gray-800 mb-4">Are you sure you want to delete this medical record?</p>
                    
                    <!-- Record Preview -->
                    <div class="bg-gray-50 rounded-lg p-4 space-y-2">
                        <div class="flex justify-between">
                            <span class="font-medium text-gray-700">Date:</span>
                            <span class="text-gray-600" x-text="deletingRecord ? formatDateTime(deletingRecord.visit_date) : ''"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium text-gray-700">Reason for Visit:</span>
                            <span class="text-gray-600" x-text="deletingRecord ? (deletingRecord.symptoms || 'Not specified') : ''"></span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                    <div class="flex items-start gap-3">
                        <svg class="w-5 h-5 text-red-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                        <div>
                            <h4 class="font-medium text-red-800">Warning</h4>
                            <p class="text-red-700 text-sm">This medical record will be permanently deleted and cannot be recovered.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="bg-gray-50 px-6 py-4 rounded-b-xl">
                <div class="flex justify-end gap-3">
                    <button @click="cancelDeleteRecord()" 
                            class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-lg transition-colors">
                        No, Cancel
                    </button>
                    <button @click="confirmDeleteRecord()" 
                            class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition-colors">
                        Yes, Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div x-show="showCheckoutModal" 
         x-cloak
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        
        <div x-show="showCheckoutModal"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95"
             class="bg-white rounded-2xl shadow-2xl w-full max-w-lg">
            
            <!-- Header -->
            <div class="bg-gradient-to-r from-red-500 to-red-600 p-6 text-white rounded-t-2xl">
                <h2 class="text-xl font-bold">Discharge Patient</h2>
                <p class="text-red-100 mt-1" x-text="selectedStay ? `Update medical record - Discharge ${selectedStay.patient_name} from clinic` : ''"></p>
            </div>

            <!-- Form -->
            <div class="p-6">
                <div x-show="selectedStay" class="mb-4 p-4 bg-gray-50 rounded-lg">
                    <div class="text-sm text-gray-600">
                        <div><strong>Patient:</strong> <span x-text="selectedStay ? selectedStay.patient_name : ''"></span></div>
                        <div><strong>Admission:</strong> <span x-text="selectedStay ? formatDateTime(selectedStay.admission_time || selectedStay.check_in_time) : ''"></span></div>
                        <div><strong>Duration:</strong> <span x-text="selectedStay ? getStayDuration(selectedStay.admission_time || selectedStay.check_in_time) : ''"></span></div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Discharge Notes</label>
                    <textarea x-model="checkoutData.checkout_notes" rows="3"
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                              placeholder="Patient condition upon discharge, any follow-up instructions, etc."></textarea>
                </div>

                <div class="flex justify-end gap-3 mt-6">
                    <button @click="showCheckoutModal = false" 
                            class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-lg transition-colors">
                        Cancel
                    </button>
                    <button @click="checkoutPatient()" 
                            class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition-colors">
                        Discharge Patient
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Clinic Stay Modal -->
    <div x-show="showClinicStayModal" 
         x-cloak
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95"
             class="bg-white rounded-2xl shadow-2xl w-full max-w-lg">
            
            <!-- Header -->
            <div class="bg-gradient-to-r from-green-500 to-green-600 p-6 text-white rounded-t-2xl">
                <h2 class="text-xl font-bold">Admit Patient to Clinic</h2>
                <p class="text-green-100 mt-1">Monitor patient staying in clinic for rest/observation</p>
            </div>

            <!-- Form -->
            <div class="p-6">
                <div class="space-y-6">
                    <!-- Patient Name Display -->
                    <div class="bg-gray-50 p-4 rounded-lg border">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center">
                                <i data-feather="user" class="w-5 h-5 text-white"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-600">Patient</p>
                                <p class="text-lg font-bold text-gray-900" x-text="newClinicStay.patient_name"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Reason for Stay - Main Focus -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                            <i data-feather="clipboard" class="w-4 h-4 text-green-600"></i>
                            Reason for Clinic Stay *
                        </label>
                        <textarea x-model="newClinicStay.stay_reason" rows="4" required
                                  class="w-full px-4 py-4 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200"
                                  placeholder="Please specify why the patient needs to stay in the clinic (e.g., Rest after medication, observation for symptoms, recovery from procedure, monitoring vital signs, etc.)"></textarea>
                        <p class="text-xs text-gray-500 mt-2 flex items-center gap-1">
                            <i data-feather="info" class="w-3 h-3"></i>
                            Be specific about the medical reason for the clinic stay
                        </p>
                    </div>
                </div>

                <div class="flex justify-end gap-3 mt-6">
                    <button @click="showClinicStayModal = false" 
                            class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-lg transition-colors">
                        Cancel
                    </button>
                    <button @click="createClinicStay()" 
                            class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors">
                        Check-in Patient
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div x-show="showCheckoutModal" 
         x-cloak
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95"
             class="bg-white rounded-2xl shadow-2xl w-full max-w-lg">
            
            <!-- Header -->
            <div class="bg-gradient-to-r from-red-500 to-red-600 p-6 text-white rounded-t-2xl">
                <h2 class="text-xl font-bold">Discharge Patient</h2>
                <p class="text-red-100 mt-1" x-text="selectedStay ? `Update medical record - Discharge ${selectedStay.patient_name} from clinic` : ''"></p>
            </div>

            <!-- Form -->
            <div class="p-6">
                <div x-show="selectedStay" class="mb-4 p-4 bg-gray-50 rounded-lg">
                    <div class="text-sm text-gray-600">
                        <div><strong>Patient:</strong> <span x-text="selectedStay ? selectedStay.patient_name : ''"></span></div>
                        <div><strong>Admission:</strong> <span x-text="selectedStay ? formatDateTime(selectedStay.admission_time || selectedStay.check_in_time) : ''"></span></div>
                        <div><strong>Duration:</strong> <span x-text="selectedStay ? getStayDuration(selectedStay.admission_time || selectedStay.check_in_time) : ''"></span></div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Discharge Notes</label>
                    <textarea x-model="checkoutData.checkout_notes" rows="3"
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                              placeholder="Patient condition upon discharge, any follow-up instructions, etc."></textarea>
                </div>

                <div class="flex justify-end gap-3 mt-6">
                    <button @click="showCheckoutModal = false" 
                            class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-lg transition-colors">
                        Cancel
                    </button>
                    <button @click="checkoutPatient()" 
                            class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition-colors">
                        Discharge Patient
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Print History Modal -->
    <div x-show="showPrintHistoryModal" 
         x-cloak
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95"
             class="bg-white rounded-2xl shadow-2xl w-full max-w-[95vw] max-h-[70vh] overflow-hidden"
             @click.stop>
            
            <!-- Header -->
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 p-4 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold flex items-center gap-3">
                            <i data-feather="printer" class="w-6 h-6"></i>
                            Print History
                        </h2>
                        <p class="text-blue-100 mt-1">All printed acknowledgment letters</p>
                    </div>
                    <button @click="showPrintHistoryModal = false" 
                            class="text-white hover:text-blue-200 transition-colors">
                        <i data-feather="x" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>

            <!-- Content -->
            <div class="flex flex-col h-[calc(70vh-160px)]">
                <div class="p-4 flex-1 overflow-y-auto">
                <!-- Loading State -->
                <div x-show="loadingPrintHistory" class="text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                    <p class="text-gray-600 mt-2">Loading print history...</p>
                </div>

                <!-- Empty State -->
                <div x-show="!loadingPrintHistory && printHistory.length === 0" class="text-center py-12">
                    <i data-feather="file-text" class="w-16 h-16 text-gray-300 mx-auto mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">No Print History</h3>
                    <p class="text-gray-600">No acknowledgment letters have been printed yet.</p>
                </div>

                <!-- Print History Table -->
                <div x-show="!loadingPrintHistory && printHistory.length > 0" class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full min-w-[1000px]">
                            <thead>
                                <tr class="bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200">
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider w-1/6">Patient</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider w-1/8">Type</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider w-1/8">Visit Date</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider w-1/8">Visit Time</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider w-1/4">Purpose</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider w-1/8">Format</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider w-1/6">Printed By</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider w-1/6">Printed At</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-100">
                                <template x-for="record in printHistory" :key="record.id">
                                    <tr class="hover:bg-gray-50 transition-all duration-200">
                                        <td class="px-4 py-3 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <div class="flex-shrink-0 h-10 w-10">
                                                    <div class="h-10 w-10 rounded-full flex items-center justify-center font-bold text-sm text-white shadow-sm"
                                                         :class="{
                                                             'bg-blue-500': record.patient_type === 'Student',
                                                             'bg-amber-500': record.patient_type === 'Teaching Staff',
                                                             'bg-emerald-500': record.patient_type === 'Non-Teaching Staff',
                                                             'bg-purple-500': record.patient_type === 'Dean',
                                                             'bg-pink-500': record.patient_type === 'Visitor'
                                                         }"
                                                         x-text="getInitials(record.patient_name)">
                                                    </div>
                                                </div>
                                                <div class="ml-3">
                                                    <div class="text-sm font-semibold text-gray-900" x-text="record.patient_name"></div>
                                                    <div class="text-xs text-gray-500" x-text="record.patient_type"></div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap">
                                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full border"
                                                  :class="{
                                                      'bg-blue-100 text-blue-800 border-blue-200': record.letter_type === 'Medical',
                                                      'bg-purple-100 text-purple-800 border-purple-200': record.letter_type === 'Acknowledgment',
                                                      'bg-green-100 text-green-800 border-green-200': record.letter_type === 'Clearance'
                                                  }"
                                                  x-text="record.letter_type"></span>
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900" x-text="record.visit_date"></td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700" x-text="record.visit_time"></td>
                                        <td class="px-4 py-3 text-sm text-gray-900 max-w-xs">
                                            <div class="truncate" x-text="record.purpose" :title="record.purpose"></div>
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap">
                                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full border" 
                                                  :class="record.file_format === 'PDF' ? 'bg-red-100 text-red-800 border-red-200' : 'bg-blue-100 text-blue-800 border-blue-200'"
                                                  x-text="record.file_format"></span>
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap">
                                            <div class="text-sm font-medium text-gray-900" x-text="record.printed_by_name"></div>
                                            <div class="text-xs text-gray-500" x-text="record.staff_position"></div>
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap">
                                            <div class="text-sm text-gray-900" x-text="formatDateTime(record.printed_at)"></div>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="bg-gray-50 px-4 py-3 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div class="text-sm text-gray-600">
                        <span x-text="printHistory.length"></span> record(s) found
                    </div>
                </div>
                <button @click="showPrintHistoryModal = false" 
                        class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-lg transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Print Reason Modal -->
    <div x-show="showPrintReasonModal" 
         x-cloak
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95"
             class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
            
            <!-- Header -->
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 p-6 text-white rounded-t-2xl">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-xl font-bold flex items-center gap-3">
                            <i data-feather="printer" class="w-5 h-5"></i>
                            Print Acknowledgment Letter
                        </h2>
                        <p class="text-blue-100 mt-1">Please provide a reason for printing</p>
                    </div>
                    <button @click="showPrintReasonModal = false; selectedRecordForPrint = null; printReason = ''" 
                            class="text-white hover:text-blue-200 transition-colors">
                        <i data-feather="x" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>

            <!-- Content -->
            <div class="p-6">
                <!-- Patient Info -->
                <div x-show="selectedRecordForPrint" class="mb-6 p-4 bg-gray-50 rounded-lg">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                            <i data-feather="user" class="w-5 h-5 text-blue-600"></i>
                        </div>
                        <div>
                            <h3 class="font-medium text-gray-900" x-text="selectedPatient?.name || 'Unknown Patient'"></h3>
                            <p class="text-sm text-gray-600">
                                Visit Date: <span x-text="selectedRecordForPrint ? formatDate(selectedRecordForPrint.visit_date) : 'N/A'"></span>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Reason Input -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Reason for Printing <span class="text-red-500">*</span>
                    </label>
                    <textarea x-model="printReason" 
                              rows="4"
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                              placeholder="e.g., Student request for school requirements, Medical clearance for employment, Insurance claim documentation, etc."
                              required></textarea>
                    <p class="text-xs text-gray-500 mt-2">
                        Please be specific about why this acknowledgment letter is being printed for audit purposes.
                    </p>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-3">
                    <button @click="showPrintReasonModal = false; selectedRecordForPrint = null; printReason = ''" 
                            class="flex-1 px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-lg transition-colors">
                        Cancel
                    </button>
                    <button @click="confirmPrintWithReason()" 
                            :disabled="!printReason.trim() || printingCertificate"
                            :class="printReason.trim() && !printingCertificate ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-400 cursor-not-allowed'"
                            class="flex-1 px-6 py-3 text-white font-medium rounded-lg transition-colors flex items-center justify-center gap-2">
                        <span x-show="printingCertificate" class="animate-spin">
                            <i data-feather="loader" class="w-4 h-4"></i>
                        </span>
                        <span x-text="printingCertificate ? 'Printing...' : 'Print Letter'"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

</div>
    <!-- Initialize Feather Icons -->
    <script>
        // Safe Feather icons initialization - prevents replaceChild errors
        document.addEventListener('DOMContentLoaded', function() {
            function initializeFeatherIcons() {
                if (typeof feather === 'undefined') {
                    return;
                }
                
                try {
                    // Get all feather icons
                    const icons = document.querySelectorAll('[data-feather]');
                    
                    icons.forEach(function(icon) {
                        // Skip if already processed or invalid
                        if (icon.classList.contains('feather-processed') || !icon.parentNode) {
                            return;
                        }
                        
                        const iconName = icon.getAttribute('data-feather');
                        
                        // Check if icon exists in feather library
                        if (!feather.icons[iconName]) {
                            return;
                        }
                        
                        try {
                            // Create SVG element safely
                            const svgString = feather.icons[iconName].toSvg({
                                class: icon.className,
                                width: icon.getAttribute('width') || '24',
                                height: icon.getAttribute('height') || '24'
                            });
                            
                            // Replace innerHTML instead of replaceChild
                            icon.innerHTML = svgString;
                            icon.classList.add('feather-processed');
                            
                        } catch (iconError) {
                            // Skip individual icon errors silently
                        }
                    });
                    
                } catch (error) {
                    // Silently handle any initialization errors
                }
            }
            
            // Initialize immediately
            initializeFeatherIcons();
            
            // Also initialize after a delay for dynamic content
            setTimeout(initializeFeatherIcons, 100);
            setTimeout(initializeFeatherIcons, 500);
        });
    </script>


    <!-- Print Preview Modal -->
    <div x-show="showPrintPreviewModal" 
         x-cloak
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-2 sm:p-4">
        <div x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95"
             class="bg-white rounded-lg sm:rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden">
            
            <!-- Header -->
            <div class="bg-gradient-to-r from-green-500 to-green-600 p-4 sm:p-6 text-white print:hidden">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
                    <div>
                        <h2 class="text-base sm:text-xl font-bold">Print Preview - Medical Acknowledgement Letter</h2>
                        <p class="text-green-100 text-xs sm:text-sm mt-1">Review the letter before printing</p>
                    </div>
                    <div class="flex items-center gap-2 sm:gap-3">
                        <button @click="printCertificate()" 
                                class="bg-white text-green-600 px-3 sm:px-4 py-2 rounded-lg font-medium hover:bg-green-50 transition-colors flex items-center gap-1.5 sm:gap-2 text-sm sm:text-base touch-target">
                            <i data-feather="printer" class="w-3.5 h-3.5 sm:w-4 sm:h-4"></i>
                            <span class="hidden sm:inline">Print Letter</span>
                            <span class="sm:hidden">Print</span>
                        </button>
                        <button @click="showPrintPreviewModal = false" class="text-white hover:text-green-200 transition-colors touch-target">
                            <i data-feather="x" class="w-5 h-5 sm:w-6 sm:h-6"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Certificate Content -->
            <div class="p-4 sm:p-8 overflow-y-auto max-h-[calc(90vh-120px)] bg-white" id="certificate-content">
                <div class="max-w-3xl mx-auto">
                    <!-- Letterhead -->
                    <div class="text-center mb-8">
                        <div class="flex items-center justify-center gap-8 mb-4">
                            <img src="../assets/img/iclinic-logo.png" alt="Norzagaray College" class="w-16 h-16">
                            <div class="text-center">
                                <h1 class="text-lg font-bold text-black mb-1">NORZAGARAY COLLEGE</h1>
                                <p class="text-sm text-black mb-1">Municipal Compound</p>
                                <p class="text-sm text-black mb-1">Brgy. Poblacion, Norzagaray, Bulacan</p>
                                <p class="text-sm text-black">Email: norzagaraycollege2007@gmail.com</p>
                            </div>
                            <img src="../assets/img/iclinic-logo.png" alt="System Logo" class="w-16 h-16">
                        </div>
                    </div>

                    <!-- Document Title -->
                    <div class="text-center mb-6">
                        <p class="text-lg font-bold text-black">MEDICAL ACKNOWLEDGEMENT LETTER</p>
                    </div>

                    <!-- Letter Content -->
                    <div class="space-y-4 text-black">
                        <p class="text-sm text-justify">
                            This is to certify that <strong x-text="selectedPatient ? selectedPatient.name : '[Name patient]'"></strong> was present at the Norzagaray College Medical Clinic on <strong x-text="selectedRecordForPrint ? formatVisitDateTime(selectedRecordForPrint) : '[Visit Date] at [TIME]'"></strong> for medical consultation and healthcare services.
                        </p>

                        <p class="text-sm text-justify">
                            During the aforementioned visit, the individual received proper medical attention from our licensed healthcare professionals in accordance with established medical protocols and institutional standards. The consultation was conducted within the official operating hours of the clinic facility.
                        </p>

                        <p class="text-sm text-justify">
                            This certification is issued upon official request and may be used for academic, administrative, or other legitimate purposes as deemed necessary by the concerned parties. The information contained herein is true and accurate to the best of our knowledge and records.
                        </p>

                        <p class="text-sm text-justify mb-8">
                            Issued this <strong x-text="getCurrentDate()"></strong> at the Norzagaray College Medical Clinic, Norzagaray, Bulacan, Philippines, for whatever legal purpose this certification may serve.
                        </p>
                    </div>

                    <!-- Signature Section -->
                    <div class="mt-16">
                        <div class="mb-12"></div>
                        <div class="w-64 border-b border-black mb-2"></div>
                        <p class="text-sm font-bold text-black">{{ user.first_name }} {{ user.last_name }}</p>
                        <p class="text-sm text-black">{{ user.position }}</p>
                        <p class="text-sm text-black">Norzagaray College Medical Clinic</p>
                    </div>

                    <!-- Footer Note -->
                    <div class="mt-8 text-center">
                        <p class="text-xs text-black">
                            This is an official document issued by Norzagaray College Medical Clinic
                        </p>
                        <p class="text-xs text-black mt-2">
                            Generated on <span x-text="getCurrentDate()"></span> | Document ID: NC-<span x-text="selectedRecordForPrint ? selectedRecordForPrint.id : '000'"></span>-<span x-text="new Date().getFullYear()"></span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Print Footer -->
            <div class="bg-gray-50 px-4 sm:px-6 py-3 sm:py-4 rounded-b-lg sm:rounded-b-2xl print:hidden">
                <div class="flex flex-col sm:flex-row justify-between items-stretch sm:items-center gap-3">
                    <button @click="showPrintPreviewModal = false" 
                            class="px-4 py-2.5 sm:py-2 text-gray-600 hover:text-gray-800 font-medium transition-colors flex items-center justify-center gap-2 text-sm sm:text-base touch-target">
                        <i data-feather="arrow-left" class="w-3.5 h-3.5 sm:w-4 sm:h-4"></i>
                        Back to Records
                    </button>
                    <div class="flex flex-col sm:flex-row gap-2 sm:gap-3">
                        <button @click="showPrintPreviewModal = false" 
                                class="w-full sm:w-auto px-6 py-2.5 sm:py-2 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-lg transition-colors text-sm sm:text-base touch-target">
                            Cancel
                        </button>
                        <button @click="printCertificate()" 
                                class="w-full sm:w-auto px-6 py-2.5 sm:py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors flex items-center justify-center gap-2 text-sm sm:text-base touch-target">
                            <i data-feather="printer" class="w-3.5 h-3.5 sm:w-4 sm:h-4"></i>
                            Print Letter
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Insurance Management Modal -->
    <div x-show="showInsuranceModal" 
         x-cloak
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-2 sm:p-4"
         @click.self="showInsuranceModal = false">
        
        <div x-show="showInsuranceModal"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform scale-95"
             x-transition:enter-end="opacity-100 transform scale-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 transform scale-100"
             x-transition:leave-end="opacity-0 transform scale-95"
             class="bg-white rounded-lg sm:rounded-2xl shadow-2xl w-[98vw] max-w-[1800px] max-h-[90vh] overflow-hidden">
            
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 px-4 sm:px-8 py-4 sm:py-6">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
                    <div class="flex items-center space-x-3 sm:space-x-4">
                        <div class="w-10 h-10 sm:w-12 sm:h-12 bg-white bg-opacity-20 rounded-lg sm:rounded-xl flex items-center justify-center">
                            <i data-feather="shield" class="w-5 h-5 sm:w-6 sm:h-6 text-white"></i>
                        </div>
                        <div>
                            <h3 class="text-lg sm:text-2xl font-bold text-white">Insurance Payment Management</h3>
                            <p class="text-blue-100 text-xs sm:text-sm">Monitor and manage student insurance payments (â‚±50.00 per student)</p>
                        </div>
                    </div>
                    <button @click="showInsuranceModal = false" 
                            class="text-white hover:text-blue-200 transition-colors p-2 hover:bg-white hover:bg-opacity-10 rounded-lg touch-target">
                        <i data-feather="x" class="w-5 h-5 sm:w-6 sm:h-6"></i>
                    </button>
                </div>
            </div>

            <!-- Modal Content -->
            <div class="p-4 sm:p-8 overflow-y-auto max-h-[calc(90vh-120px)]">
                
                <!-- Summary Statistics -->
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3 sm:gap-6 mb-6 sm:mb-8">
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 sm:p-6 rounded-lg sm:rounded-xl border border-blue-200 shadow-sm">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-600 text-xs sm:text-sm font-medium">Total Students</p>
                                <p class="text-2xl sm:text-3xl font-bold text-blue-900" x-text="insuranceSummary.total_students || 0"></p>
                            </div>
                            <i data-feather="users" class="w-6 h-6 sm:w-8 sm:h-8 text-blue-500"></i>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 sm:p-6 rounded-lg sm:rounded-xl border border-green-200 shadow-sm">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-600 text-xs sm:text-sm font-medium">Paid</p>
                                <p class="text-2xl sm:text-3xl font-bold text-green-900" x-text="insuranceSummary.paid_count || 0"></p>
                                <p class="text-xs text-green-600" x-text="`${insuranceSummary.payment_rate || 0}% payment rate`"></p>
                            </div>
                            <i data-feather="check-circle" class="w-6 h-6 sm:w-8 sm:h-8 text-green-500"></i>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-red-50 to-red-100 p-4 sm:p-6 rounded-lg sm:rounded-xl border border-red-200 shadow-sm">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-red-600 text-xs sm:text-sm font-medium">Unpaid</p>
                                <p class="text-2xl sm:text-3xl font-bold text-red-900" x-text="insuranceSummary.unpaid_count || 0"></p>
                                <p class="text-xs text-red-600">Need to pay â‚±50</p>
                            </div>
                            <i data-feather="alert-circle" class="w-6 h-6 sm:w-8 sm:h-8 text-red-500"></i>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 p-4 sm:p-6 rounded-lg sm:rounded-xl border border-indigo-200 shadow-sm">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-indigo-600 text-xs sm:text-sm font-medium">Total Collected</p>
                                <p class="text-xl sm:text-2xl font-bold text-indigo-900">â‚±<span x-text="(insuranceSummary.total_collected || 0).toLocaleString()"></span></p>
                                <p class="text-xs text-indigo-600" x-text="`${insuranceSummary.first_year_paid || 0} of ${insuranceSummary.first_year_total || 0} 1st years`"></p>
                            </div>
                            <svg class="w-6 h-6 sm:w-8 sm:h-8 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Filters - Compact Dropdown Design -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg sm:rounded-xl p-4 sm:p-6 mb-4 sm:mb-6 border border-blue-200">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 sm:gap-4">
                        <!-- Payment Status Filter -->
                        <div>
                            <label class="text-xs sm:text-sm font-semibold text-gray-700 mb-1.5 sm:mb-2 block flex items-center gap-2">
                                <i data-feather="filter" class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-blue-600"></i>
                                Payment Status
                            </label>
                            <select x-model="insuranceFilter" 
                                    class="w-full px-3 sm:px-4 py-2 sm:py-2.5 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs sm:text-sm font-medium transition-all touch-target">
                                <option value="all">All Students</option>
                                <option value="first-year">1st Year Only</option>
                                <option value="unpaid">Unpaid Only</option>
                                <option value="paid">Paid Only</option>
                            </select>
                        </div>
                        
                        <!-- Department Filter -->
                        <div>
                            <label class="text-xs sm:text-sm font-semibold text-gray-700 mb-1.5 sm:mb-2 block flex items-center gap-2">
                                <i data-feather="book" class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-blue-600"></i>
                                Department / Course
                            </label>
                            <select x-model="insuranceDepartmentFilter" 
                                    class="w-full px-3 sm:px-4 py-2 sm:py-2.5 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs sm:text-sm font-medium transition-all touch-target">
                                <option value="all">All Departments</option>
                                <option value="Computer Science">Computer Science</option>
                                <option value="BSED">BSED</option>
                                <option value="BEED">BEED</option>
                                <option value="HM">HM</option>
                            </select>
                        </div>
                        
                        <!-- Section Filter -->
                        <div>
                            <label class="text-xs sm:text-sm font-semibold text-gray-700 mb-1.5 sm:mb-2 block flex items-center gap-2">
                                <i data-feather="users" class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-indigo-600"></i>
                                Section
                            </label>
                            <select x-model="insuranceSectionFilter" 
                                    class="w-full px-3 sm:px-4 py-2 sm:py-2.5 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-xs sm:text-sm font-medium transition-all touch-target">
                                <option value="all">All Sections</option>
                                <option value="1A">1A</option>
                                <option value="1B">1B</option>
                                <option value="2A">2A</option>
                                <option value="2B">2B</option>
                                <option value="3A">3A</option>
                                <option value="3B">3B</option>
                                <option value="4A">4A</option>
                                <option value="4B">4B</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Active Filters Display -->
                    <div x-show="insuranceFilter !== 'all' || insuranceDepartmentFilter !== 'all' || insuranceSectionFilter !== 'all'" 
                         class="mt-4 pt-4 border-t border-blue-200">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2 flex-wrap">
                                <span class="text-xs font-semibold text-gray-600">Active Filters:</span>
                                <span x-show="insuranceFilter !== 'all'" class="inline-flex items-center gap-1 px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-medium">
                                    <span x-text="insuranceFilter === 'first-year' ? '1st Year Only' : insuranceFilter === 'unpaid' ? 'Unpaid' : 'Paid'"></span>
                                    <button @click="insuranceFilter = 'all'" class="hover:bg-blue-200 rounded-full p-0.5">
                                        <i data-feather="x" class="w-3 h-3"></i>
                                    </button>
                                </span>
                                <span x-show="insuranceDepartmentFilter !== 'all'" class="inline-flex items-center gap-1 px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-medium">
                                    <span x-text="insuranceDepartmentFilter"></span>
                                    <button @click="insuranceDepartmentFilter = 'all'" class="hover:bg-indigo-200 rounded-full p-0.5">
                                        <i data-feather="x" class="w-3 h-3"></i>
                                    </button>
                                </span>
                                <span x-show="insuranceSectionFilter !== 'all'" class="inline-flex items-center gap-1 px-3 py-1 bg-cyan-100 text-cyan-700 rounded-full text-xs font-medium">
                                    <span>Section <span x-text="insuranceSectionFilter"></span></span>
                                    <button @click="insuranceSectionFilter = 'all'" class="hover:bg-cyan-200 rounded-full p-0.5">
                                        <i data-feather="x" class="w-3 h-3"></i>
                                    </button>
                                </span>
                            </div>
                            <button @click="insuranceFilter = 'all'; insuranceDepartmentFilter = 'all'; insuranceSectionFilter = 'all'" 
                                    class="text-xs font-medium text-gray-600 hover:text-gray-900 underline">
                                Clear All
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Students Table -->
                <div class="bg-white rounded-lg sm:rounded-xl border border-gray-200 overflow-hidden">
                    <div class="overflow-x-auto -mx-4 sm:mx-0">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No.</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student Number</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Birthday</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Age</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gender</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name of Beneficiary</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Relationship to Student</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact Number</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Address</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Course</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Section</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Insurance Status</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Payment Date</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <template x-for="(student, index) in getFilteredInsuranceData()" :key="student.student_number">
                                    <tr class="hover:bg-gray-50">
                                        <!-- No. -->
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 font-medium" x-text="index + 1"></td>
                                        
                                        <!-- Student Number -->
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900" x-text="student.student_number"></td>
                                        
                                        <!-- Name -->
                                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900" x-text="student.full_name"></td>
                                        
                                        <!-- Birthday -->
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900" x-text="student.birthday"></td>
                                        
                                        <!-- Age -->
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900" x-text="student.age"></td>
                                        
                                        <!-- Gender -->
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900" x-text="student.gender"></td>
                                        
                                        <!-- Name of Beneficiary -->
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900" x-text="student.beneficiary_name"></td>
                                        
                                        <!-- Relationship to Student -->
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900" x-text="student.beneficiary_relationship"></td>
                                        
                                        <!-- Contact Number -->
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900" x-text="student.beneficiary_contact"></td>
                                        
                                        <!-- Address -->
                                        <td class="px-4 py-3 text-sm text-gray-900" style="max-width: 200px;">
                                            <div class="truncate" :title="student.address" x-text="student.address"></div>
                                        </td>
                                        
                                        <!-- Course -->
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900" x-text="student.course"></td>
                                        
                                        <!-- Section -->
                                        <td class="px-4 py-3 whitespace-nowrap">
                                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800"
                                                  x-text="student.section || 'N/A'">
                                            </span>
                                        </td>
                                        
                                        <!-- Insurance Status -->
                                        <td class="px-4 py-3 whitespace-nowrap">
                                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full"
                                                  :class="student.insurance_paid === 'paid' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
                                                <i :data-feather="student.insurance_paid === 'paid' ? 'check-circle' : 'x-circle'" class="w-3 h-3 mr-1"></i>
                                                <span x-text="student.insurance_paid === 'paid' ? 'PAID' : 'UNPAID'"></span>
                                            </span>
                                        </td>
                                        
                                        <!-- Payment Date -->
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900" x-text="student.insurance_payment_date || 'Not paid'"></td>
                                        
                                        <!-- Amount -->
                                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">â‚±<span x-text="student.insurance_amount.toFixed(2)"></span></td>
                                        
                                        <!-- Actions -->
                                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                                            <button @click="openPaymentModal(student)" 
                                                    class="text-blue-600 hover:text-blue-900 hover:bg-blue-50 px-3 py-1 rounded-lg transition-colors">
                                                <i data-feather="edit-3" class="w-4 h-4 inline mr-1"></i>
                                                Update
                                            </button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Loading State -->
                    <div x-show="loadingInsurance" class="flex justify-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-4 border-purple-200 border-t-purple-500"></div>
                    </div>
                    
                    
                    <!-- Empty State -->
                    <div x-show="!loadingInsurance && getFilteredInsuranceData().length === 0" class="text-center py-8">
                        <i data-feather="users" class="w-12 h-12 text-gray-400 mx-auto mb-4"></i>
                        <p class="text-gray-500">No students found with the selected filter.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Update Modal -->
    <div x-show="showPaymentModal" 
         x-cloak
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70] p-4"
         @click.self="showPaymentModal = false">
        
        <div x-show="showPaymentModal"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform scale-95"
             x-transition:enter-end="opacity-100 transform scale-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 transform scale-100"
             x-transition:leave-end="opacity-0 transform scale-95"
             class="bg-white rounded-2xl shadow-2xl max-w-md w-full">
            
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-purple-600 to-purple-700 px-6 py-4 rounded-t-2xl">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-bold text-white">Update Insurance Payment</h3>
                    <button @click="showPaymentModal = false" 
                            class="text-white hover:text-purple-200 transition-colors">
                        <i data-feather="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <p class="text-purple-100 text-sm mt-1" x-text="selectedStudent?.full_name"></p>
            </div>

            <!-- Modal Content -->
            <div class="p-6">
                <form @submit.prevent="updateInsurancePayment()" class="space-y-4">
                    <!-- Payment Status -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Payment Status</label>
                        <select x-model="paymentForm.insurance_paid" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="unpaid">Unpaid</option>
                            <option value="paid">Paid</option>
                        </select>
                    </div>

                    <!-- Amount -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Amount (â‚±)</label>
                        <input type="number" 
                               x-model="paymentForm.insurance_amount" 
                               step="0.01" 
                               min="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>

                    <!-- Payment Date -->
                    <div x-show="paymentForm.insurance_paid === 'paid'">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Payment Date</label>
                        <input type="date" 
                               x-model="paymentForm.insurance_payment_date"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>

                    <!-- Notes -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Notes (Optional)</label>
                        <textarea x-model="paymentForm.insurance_notes" 
                                  rows="3"
                                  placeholder="Add any notes about the payment..."
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none"></textarea>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" 
                                @click="showPaymentModal = false"
                                class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors">
                            Cancel
                        </button>
                        <button type="submit"
                                class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                            Update Payment
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Archive Management Modal -->
    <div x-show="showArchiveModal" 
         x-cloak
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
         @click.self="showArchiveModal = false">
        
        <div x-show="showArchiveModal"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform scale-95"
             x-transition:enter-end="opacity-100 transform scale-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 transform scale-100"
             x-transition:leave-end="opacity-0 transform scale-95"
             class="bg-white rounded-2xl shadow-2xl w-[98vw] max-w-[1600px] max-h-[90vh] overflow-hidden">
            
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-gray-600 to-gray-700 px-8 py-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
                            <i data-feather="archive" class="w-6 h-6 text-white"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-white">Patient Archive</h3>
                            <p class="text-gray-200 text-sm">View and manage archived patients (Graduated students, Resigned staff, etc.)</p>
                        </div>
                    </div>
                    <button @click="showArchiveModal = false" 
                            class="text-white hover:text-gray-200 transition-colors p-2 hover:bg-white hover:bg-opacity-10 rounded-lg">
                        <i data-feather="x" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>

            <!-- Modal Content -->
            <div class="p-8 overflow-y-auto max-h-[calc(90vh-120px)]">
                
                <!-- Search and Year Filter -->
                <div class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl p-6 mb-6 border border-gray-200">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Search Bar -->
                        <div>
                            <label class="text-sm font-semibold text-gray-700 mb-2 block flex items-center gap-2">
                                <i data-feather="search" class="w-4 h-4 text-gray-600"></i>
                                Search by ID or Name
                            </label>
                            <input type="text" 
                                   x-model="archiveSearchQuery"
                                   placeholder="Search student number, name..."
                                   class="w-full px-4 py-2.5 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500 focus:border-transparent text-sm transition-all">
                        </div>
                        
                        <!-- Year Filter -->
                        <div>
                            <label class="text-sm font-semibold text-gray-700 mb-2 block flex items-center gap-2">
                                <i data-feather="calendar" class="w-4 h-4 text-gray-600"></i>
                                Filter by Year Archived
                            </label>
                            <select x-model="archiveYearFilter" 
                                    class="w-full px-4 py-2.5 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500 focus:border-transparent text-sm font-medium transition-all">
                                <option value="all">All Years</option>
                                <template x-for="year in getAvailableArchiveYears()" :key="year">
                                    <option :value="year" x-text="year"></option>
                                </template>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Active Filters Display -->
                    <div x-show="archiveSearchQuery !== '' || archiveYearFilter !== 'all'" 
                         class="mt-4 pt-4 border-t border-gray-200">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2 flex-wrap">
                                <span class="text-xs font-semibold text-gray-600">Active Filters:</span>
                                <span x-show="archiveSearchQuery !== ''" class="inline-flex items-center gap-1 px-3 py-1 bg-gray-600 text-white rounded-full text-xs font-medium">
                                    <span>Search: "<span x-text="archiveSearchQuery"></span>"</span>
                                    <button @click="archiveSearchQuery = ''" class="hover:bg-gray-700 rounded-full p-0.5">
                                        <i data-feather="x" class="w-3 h-3"></i>
                                    </button>
                                </span>
                                <span x-show="archiveYearFilter !== 'all'" class="inline-flex items-center gap-1 px-3 py-1 bg-blue-600 text-white rounded-full text-xs font-medium">
                                    <span>Year: <span x-text="archiveYearFilter"></span></span>
                                    <button @click="archiveYearFilter = 'all'" class="hover:bg-blue-700 rounded-full p-0.5">
                                        <i data-feather="x" class="w-3 h-3"></i>
                                    </button>
                                </span>
                            </div>
                            <button @click="archiveSearchQuery = ''; archiveYearFilter = 'all'" 
                                    class="text-xs font-medium text-gray-600 hover:text-gray-900 underline">
                                Clear All
                            </button>
                        </div>
                    </div>
                    
                    <!-- Results Count -->
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <p class="text-sm text-gray-600">
                            <span class="font-semibold text-gray-900" x-text="getFilteredArchivedPatients().length"></span> 
                            <span x-text="getFilteredArchivedPatients().length === 1 ? 'patient' : 'patients'"></span> found
                        </p>
                    </div>
                </div>
                
                <!-- Filter Tabs -->
                <div class="flex flex-wrap gap-2 mb-6">
                    <button @click="archiveFilter = 'all'" 
                            :class="archiveFilter === 'all' ? 'bg-gray-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                            class="px-4 py-2 rounded-lg font-medium transition-colors">
                        All (<span x-text="archivedPatients.length"></span>)
                    </button>
                    <button @click="archiveFilter = 'students'" 
                            :class="archiveFilter === 'students' ? 'bg-blue-600 text-white' : 'bg-blue-100 text-blue-700 hover:bg-blue-200'"
                            class="px-4 py-2 rounded-lg font-medium transition-colors">
                        Students
                    </button>
                    <button @click="archiveFilter = 'teaching'" 
                            :class="archiveFilter === 'teaching' ? 'bg-amber-600 text-white' : 'bg-amber-100 text-amber-700 hover:bg-amber-200'"
                            class="px-4 py-2 rounded-lg font-medium transition-colors">
                        Teaching Staff
                    </button>
                    <button @click="archiveFilter = 'non-teaching'" 
                            :class="archiveFilter === 'non-teaching' ? 'bg-emerald-600 text-white' : 'bg-emerald-100 text-emerald-700 hover:bg-emerald-200'"
                            class="px-4 py-2 rounded-lg font-medium transition-colors">
                        Non-Teaching Staff
                    </button>
                    <button @click="archiveFilter = 'deans'" 
                            :class="archiveFilter === 'deans' ? 'bg-purple-600 text-white' : 'bg-purple-100 text-purple-700 hover:bg-purple-200'"
                            class="px-4 py-2 rounded-lg font-medium transition-colors">
                        Deans
                    </button>
                    <button @click="archiveFilter = 'visitors'" 
                            :class="archiveFilter === 'visitors' ? 'bg-gray-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                            class="px-4 py-2 rounded-lg font-medium transition-colors">
                        Visitors
                    </button>
                </div>

                <!-- Loading State -->
                <div x-show="loadingArchive" class="flex flex-col items-center justify-center py-16">
                    <div class="animate-spin rounded-full h-12 w-12 border-4 border-gray-200 border-t-gray-600 mb-4"></div>
                    <span class="text-gray-600 font-medium">Loading archived patients...</span>
                </div>

                <!-- Empty State -->
                <div x-show="!loadingArchive && getFilteredArchivedPatients().length === 0" 
                     class="text-center py-16">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-feather="archive" class="w-8 h-8 text-gray-400"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">No Archived Patients</h3>
                    <p class="text-gray-500">There are no archived patients in this category.</p>
                </div>

                <!-- Archived Patients Table -->
                <div x-show="!loadingArchive && getFilteredArchivedPatients().length > 0" 
                     class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department/Course</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Archived Date</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <template x-for="(patient, index) in getFilteredArchivedPatients()" :key="patient.id">
                                    <tr class="hover:bg-gray-50 transition-colors">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="patient.identifier"></td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center mr-3">
                                                    <span class="text-sm font-bold text-gray-600" x-text="patient.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0,2)"></span>
                                                </div>
                                                <div>
                                                    <div class="text-sm font-medium text-gray-900" x-text="patient.name"></div>
                                                    <div class="text-xs text-gray-500">Age: <span x-text="patient.age || 'N/A'"></span></div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full"
                                                  :class="{
                                                      'bg-blue-100 text-blue-800': patient.role === 'Student',
                                                      'bg-amber-100 text-amber-800': patient.role === 'Teaching Staff',
                                                      'bg-emerald-100 text-emerald-800': patient.role === 'Non-Teaching Staff',
                                                      'bg-purple-100 text-purple-800': patient.role === 'Dean',
                                                      'bg-gray-100 text-gray-800': patient.role === 'Visitor'
                                                  }"
                                                  x-text="patient.role"></span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="patient.department || patient.course || 'N/A'"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="patient.contact || 'N/A'"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="patient.email || 'N/A'"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            <div class="flex flex-col">
                                                <span class="font-medium text-gray-900" x-text="patient.archived_date || 'N/A'"></span>
                                                <span class="text-xs text-gray-400" x-text="patient.archived_time || ''"></span>
                                            </div>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF Preview Modal -->
    <div x-show="showPdfPreviewModal" 
         x-cloak
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
         @click.self="closePdfPreview()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-6xl h-[90vh] flex flex-col"
             @click.stop>
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-gradient-to-br from-red-500 to-red-600 rounded-xl flex items-center justify-center shadow-lg">
                        <i data-feather="file-text" class="w-6 h-6 text-white"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Medical Certificate Preview</h2>
                        <p class="text-sm text-gray-500">Review before downloading or printing</p>
                    </div>
                </div>
                <button @click="closePdfPreview()" 
                        class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                    <i data-feather="x" class="w-6 h-6 text-gray-500"></i>
                </button>
            </div>

            <!-- PDF Preview Area -->
            <div class="flex-1 overflow-hidden bg-gray-100 p-4 relative">
                <!-- Loading State -->
                <div x-show="generatingPdfPreview" 
                     class="absolute inset-0 flex flex-col items-center justify-center bg-white bg-opacity-95 z-10">
                    <div class="relative">
                        <!-- Animated spinner -->
                        <div class="animate-spin rounded-full h-20 w-20 border-4 border-gray-200 border-t-red-500 mb-4"></div>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <i data-feather="file-text" class="w-8 h-8 text-red-500 animate-pulse"></i>
                        </div>
                    </div>
                    <h3 class="text-xl font-bold text-gray-900 mb-2">Generating PDF...</h3>
                    <p class="text-sm text-gray-500 mb-4">Converting your Word template to PDF</p>
                    <div class="flex items-center gap-2 text-xs text-gray-400">
                        <div class="w-2 h-2 bg-red-500 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                        <div class="w-2 h-2 bg-red-500 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                        <div class="w-2 h-2 bg-red-500 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                    </div>
                </div>
                
                <!-- PDF Iframe -->
                <iframe x-show="!generatingPdfPreview && pdfPreviewUrl"
                        :src="pdfPreviewUrl" 
                        class="w-full h-full rounded-lg border-2 border-gray-300 bg-white shadow-inner"
                        frameborder="0"></iframe>
            </div>

            <!-- Modal Footer with Actions -->
            <div class="flex items-center justify-between p-6 border-t border-gray-200 bg-gray-50">
                <div class="flex items-center gap-2 text-sm text-gray-600">
                    <i data-feather="info" class="w-4 h-4"></i>
                    <span x-text="generatingPdfPreview ? 'Please wait...' : 'PDF generated from your Word template'"></span>
                </div>
                <div class="flex gap-3">
                    <button @click="closePdfPreview()" 
                            :disabled="generatingPdfPreview"
                            :class="generatingPdfPreview ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-300'"
                            class="px-6 py-2.5 bg-gray-200 text-gray-700 font-medium rounded-lg transition-colors flex items-center gap-2">
                        <i data-feather="x" class="w-4 h-4"></i>
                        <span>Cancel</span>
                    </button>
                    <button @click="downloadPdfFromPreview()" 
                            :disabled="generatingPdfPreview"
                            :class="generatingPdfPreview ? 'opacity-50 cursor-not-allowed' : 'hover:bg-blue-600 shadow-lg hover:shadow-xl'"
                            class="px-6 py-2.5 bg-blue-500 text-white font-medium rounded-lg transition-colors flex items-center gap-2">
                        <i data-feather="download" class="w-4 h-4"></i>
                        <span>Download PDF</span>
                    </button>
                    <button @click="printPdfFromPreview()" 
                            :disabled="generatingPdfPreview"
                            :class="generatingPdfPreview ? 'opacity-50 cursor-not-allowed' : 'hover:bg-green-600 shadow-lg hover:shadow-xl'"
                            class="px-6 py-2.5 bg-green-500 text-white font-medium rounded-lg transition-colors flex items-center gap-2">
                        <i data-feather="printer" class="w-4 h-4"></i>
                        <span>Print</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Table Optimization Styles -->
    <style>
        /* Ultra-compact table for mobile devices */
        @media (max-width: 640px) {
            /* Force table to fit mobile screen */
            .medical-records-table {
                font-size: 8px !important;
                width: 100% !important;
                max-width: 100% !important;
                table-layout: fixed !important;
            }
            
            .medical-records-table th,
            .medical-records-table td {
                padding: 0.2rem 0.1rem !important;
                white-space: normal !important;
                word-break: break-word !important;
                overflow: hidden !important;
            }
            
            /* First column (Date) - 25% width */
            .medical-records-table th:first-child,
            .medical-records-table td:first-child {
                width: 25% !important;
            }
            
            /* Second column (Reason) - 45% width */
            .medical-records-table th:nth-child(2),
            .medical-records-table td:nth-child(2) {
                width: 45% !important;
            }
            
            /* Actions column - 30% width */
            .medical-records-table th:last-child,
            .medical-records-table td:last-child {
                width: 30% !important;
                padding: 0.2rem 0.05rem !important;
            }
            
            /* Ultra-compact action buttons */
            .medical-records-table .action-button {
                padding: 0.2rem 0.1rem !important;
                min-width: 26px !important;
                min-height: 26px !important;
                font-size: 0 !important;
            }
            
            .medical-records-table .action-button svg {
                width: 10px !important;
                height: 10px !important;
            }
            
            /* Hide button text on mobile */
            .medical-records-table .action-button span {
                display: none !important;
            }
            
            /* Reduce gap between action buttons */
            .medical-records-table td:last-child > div {
                gap: 0.1rem !important;
                flex-wrap: nowrap !important;
            }
            
            /* Make table container fit screen */
            .overflow-x-auto {
                -webkit-overflow-scrolling: touch;
                overflow-x: auto !important;
                max-width: 100vw !important;
            }
            
            /* Ensure parent containers don't overflow */
            .patient-details-panel {
                overflow-x: hidden !important;
                max-width: 100vw !important;
                width: 100% !important;
            }
            
            /* Force all children to respect parent width */
            .patient-details-panel > * {
                max-width: 100% !important;
            }
            
            /* Patient info cards container */
            .patient-info-card {
                max-width: 100% !important;
            }
            
            /* Emergency contact cards */
            .patient-details-panel .grid {
                max-width: 100% !important;
            }
            
            /* Compact table wrapper */
            .medical-records-table tbody tr {
                display: table-row !important;
            }
            
            /* Reduce line height for compactness */
            .medical-records-table td > div {
                line-height: 1.2 !important;
            }
        }
        
        /* Touch target minimum size */
        .touch-target {
            min-height: 44px;
            min-width: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Additional mobile overflow fixes */
        @media (max-width: 640px) {
            /* FORCE EVERYTHING TO FIT VIEWPORT */
            * {
                max-width: 100vw !important;
            }
            
            /* Ensure no element can exceed viewport */
            body, html {
                overflow-x: hidden !important;
                max-width: 100vw !important;
                width: 100vw !important;
            }
            
            /* Main container */
            body > div {
                max-width: 100vw !important;
                overflow-x: hidden !important;
            }
            
            /* Two-panel container */
            .flex.flex-col.md\\:flex-row,
            .flex-col.md\\:flex-row {
                max-width: 100vw !important;
                overflow-x: hidden !important;
            }
            
            /* Patient details panel - CRITICAL */
            .patient-details-panel,
            .patient-details-panel > div,
            .patient-details-panel > * {
                max-width: 100% !important;
                overflow-x: hidden !important;
                box-sizing: border-box !important;
            }
            
            /* Patient header section */
            .gradient-bg-sidebar {
                max-width: calc(100vw - 1rem) !important;
                margin-left: 0.5rem !important;
                margin-right: 0.5rem !important;
            }
            
            /* All grid containers */
            .grid {
                max-width: 100% !important;
                width: 100% !important;
            }
            
            /* Force grid to 2 columns on mobile */
            .grid-cols-2 {
                grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
            }
            
            /* Override md:grid-cols-4 on mobile */
            .md\\:grid-cols-4 {
                grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
            }
            
            /* Patient info cards */
            .patient-info-card {
                max-width: 100% !important;
                box-sizing: border-box !important;
            }
            
            /* Medical records section */
            .medical-records-table,
            .medical-records-table tbody,
            .medical-records-table thead {
                max-width: 100% !important;
                box-sizing: border-box !important;
            }
            
            /* Table wrapper */
            .overflow-x-auto {
                max-width: calc(100vw - 1rem) !important;
            }
        }
    </style>

    <!-- Print Styles -->
    <style>
        @media print {
            @page {
                size: A4;
                margin: 0.5in;
            }
            
            body * {
                visibility: hidden;
            }
            
            #certificate-content, #certificate-content * {
                visibility: visible;
            }
            
            #certificate-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100vh;
                padding: 20px;
                margin: 0;
                font-size: 13px;
                line-height: 1.5;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
            }
            
            #certificate-content .max-w-3xl {
                max-width: 100%;
                margin: 0;
                padding: 0;
                flex: 1;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
            }
            
            /* Letterhead Section */
            #certificate-content .text-center.mb-8.border-b-2 {
                margin-bottom: 30px;
                padding-bottom: 20px;
            }
            
            #certificate-content h1 {
                font-size: 20px;
                margin-bottom: 8px;
            }
            
            #certificate-content h2 {
                font-size: 18px;
                margin-bottom: 25px;
            }
            
            /* Body Content */
            #certificate-content .space-y-6 {
                flex: 1;
                display: flex;
                flex-direction: column;
                justify-content: center;
                margin: 30px 0;
            }
            
            #certificate-content .space-y-6 > * + * {
                margin-top: 20px;
            }
            
            #certificate-content p {
                font-size: 12px;
                margin-bottom: 15px;
            }
            
            #certificate-content .text-lg {
                font-size: 14px;
                margin-bottom: 20px;
            }
            
            /* Signature Section */
            #certificate-content .mt-16 {
                margin-top: 40px;
                margin-bottom: 0;
            }
            
            #certificate-content .mt-12 {
                margin-top: 25px;
            }
            
            #certificate-content .mt-8 {
                margin-top: 20px;
            }
            
            #certificate-content .mb-8 {
                margin-bottom: 20px;
            }
            
            #certificate-content .pb-6 {
                padding-bottom: 15px;
            }
            
            #certificate-content img {
                width: 60px;
                height: 60px;
            }
            
            /* Footer */
            #certificate-content .border-t {
                margin-top: 20px;
                padding-top: 15px;
            }
            
            .print\\:hidden {
                display: none !important;
            }
        }
    </style>
</body>
</html>
