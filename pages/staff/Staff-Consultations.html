<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consultations - iClinic Healthcare Management System</title>
    
    <!-- Tailwind CSS -->
    <script>
        // Suppress Tailwind CDN production warning
        const originalWarn = console.warn;
        console.warn = function(...args) {
            const message = args[0];
            if (typeof message === 'string' && (
                message.includes('cdn.tailwindcss.com should not be used in production') ||
                message.includes('tailwindcss.com') ||
                message.includes('PostCSS plugin')
            )) {
                return; // Suppress Tailwind warnings
            }
            originalWarn.apply(console, args);
        };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>

    
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Feather Icons -->
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- AOS Animation -->
    <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
    
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }
        
        /* Custom scrollbar for better UX */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 8px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #0056b3, #003d82);
            border-radius: 8px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #004494, #002d61);
        }
        
        /* Dark mode scrollbar */
        .dark ::-webkit-scrollbar-track {
            background: #374151;
        }
        
        /* Hide scrollbar for suggested replies */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .dark ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #60a5fa, #3b82f6);
        }
        
        /* Glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
        }
        
        .dark .glass {
            background: rgba(20, 35, 55, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(55, 65, 81, 0.3);
        }
        
        body.dark {
            --tw-bg-opacity: 1;
            background-color: #0f172a;
        }
        
        body {
            background-color: #ffffff;
        }
        
        /* Sidebar gradient */
        .gradient-bg-sidebar {
            background: linear-gradient(135deg, #0056b3 0%, #003d82 100%);
            position: relative;
        }
        
        .gradient-bg-sidebar::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(45deg, transparent, rgba(253, 184, 19, 0.1), transparent);
            pointer-events: none;
        }
        
        .dark .gradient-bg-sidebar {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        }
        
        /* Card hover effects */
        .stat-card {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover::before {
            transform: translateX(0);
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
        }
        
        /* Section headers */
        .section-header {
            position: relative;
            display: inline-block;
        }
        
        .section-header::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 0;
            width: 40px;
            height: 3px;
            background: linear-gradient(90deg, #0056b3, #FDB813);
            border-radius: 2px;
        }
        
        /* Quick action cards */
        .quick-action-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .quick-action-card:hover {
            transform: translateY(-6px) scale(1.02);
        }
        
        /* Smooth animations */
        @keyframes slideInFromTop {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        .animate-slide-in {
            animation: slideInFromTop 0.6s ease-out;
        }
        
        .animate-fade-in {
            animation: fadeIn 0.8s ease-out;
        }
        
        /* Activity item hover */
        .activity-item {
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }
        
        .activity-item:hover {
            background: linear-gradient(90deg, rgba(0, 86, 179, 0.05) 0%, transparent 100%);
            border-left-color: #0056b3;
            padding-left: 12px;
        }
        
        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            .sidebar-collapsed {
                transform: translateX(-100%);
                position: fixed;
                z-index: 50;
            }
            
            .sidebar-collapsed.mobile-open {
                transform: translateX(0);
            }
        }
        
        /* Active sidebar item */
        .sidebar-item-active {
            background: linear-gradient(90deg, rgba(253, 184, 19, 0.2) 0%, rgba(253, 184, 19, 0.05) 100%);
            border-left: 4px solid var(--accent);
            box-shadow: 0 0 20px rgba(253, 184, 19, 0.2);
        }
        
        .dark .sidebar-item-active {
            background: linear-gradient(90deg, rgba(253, 184, 19, 0.25) 0%, rgba(253, 184, 19, 0.05) 100%);
            border-left: 4px solid var(--accent);
            box-shadow: 0 0 25px rgba(253, 184, 19, 0.3);
        }
        
        :root {
            --primary: #0056b3;
            --primary-dark: #003d82;
            --secondary: #FDB813;
            --accent: #FDB813;
            --accent-hover: #e5a200;
            --neutral: #6b7280;
            --success: #10b981;
            --danger: #ef4444;
            --purple: #8b5cf6;
            --navy-dark: #1e293b;
            --navy-darker: #0f172a;
        }
        
        .dark .bg-navy-dark {
            background-color: #2d3748;
        }
        
        .dark .bg-navy-darker {
            background-color: #1a202c;
        }
    </style>
</head>
<body class="bg-white transition-colors duration-200" x-data="consultationsModule()" x-init="init()">
    
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside :class="sidebarCollapsed ? 'w-20' : 'w-64'" 
               class="fixed left-0 top-0 h-screen gradient-bg-sidebar text-white transition-all duration-300 shadow-2xl z-40"
               @mouseenter="sidebarHovered = true"
               @mouseleave="sidebarHovered = false">
        
            <!-- Logo -->
            <div class="relative p-6">
                <div class="flex items-center gap-3" :class="sidebarCollapsed && !sidebarHovered ? 'justify-center' : ''">
                    <div class="flex items-center justify-center">
                        <img src="../assets/img/iclinic-logo.png" alt="Norzagaray College" class="w-14 h-14 object-contain">
                    </div>
                    <div x-show="!sidebarCollapsed || sidebarHovered" x-transition>
                        <h1 class="text-xl font-bold text-white">iClinic</h1>
                        <p class="text-xs text-yellow-300">Norzagaray College</p>
                    </div>
                </div>
            </div>
            
            <!-- Navigation -->
            <nav class="relative mt-8 px-4 space-y-2">
                <!-- Dashboard -->
                <a href="{{ url_for('staff_dashboard') }}"
                   class="flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all group hover:bg-white/10">
                    <div class="flex items-center justify-center" :class="sidebarCollapsed && !sidebarHovered ? 'w-full' : ''">
                        <i data-feather="home" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                    </div>
                    <span x-show="!sidebarCollapsed || sidebarHovered" x-transition class="font-medium">Dashboard</span>
                </a>
                
                <!-- Patients -->
                <a href="{{ url_for('staff_patients') }}"
                   class="flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all group hover:bg-white/10">
                    <div class="flex items-center justify-center" :class="sidebarCollapsed && !sidebarHovered ? 'w-full' : ''">
                        <i data-feather="users" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                    </div>
                    <span x-show="!sidebarCollapsed || sidebarHovered" x-transition class="font-medium">Patients</span>
                </a>
                
                <!-- Appointments -->
                <a href="{{ url_for('staff_appointments') }}"
                   class="flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all group hover:bg-white/10">
                    <div class="flex items-center justify-center" :class="sidebarCollapsed && !sidebarHovered ? 'w-full' : ''">
                        <i data-feather="calendar" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                    </div>
                    <span x-show="!sidebarCollapsed || sidebarHovered" x-transition class="font-medium">Appointments</span>
                </a>
                
                <!-- Announcements -->
                <a href="{{ url_for('staff_announcements') }}"
                   class="flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all group hover:bg-white/10">
                    <div class="flex items-center justify-center" :class="sidebarCollapsed && !sidebarHovered ? 'w-full' : ''">
                        <i data-feather="volume-2" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                    </div>
                    <span x-show="!sidebarCollapsed || sidebarHovered" x-transition class="font-medium">Announcements</span>
                </a>
                
                <!-- Consultations -->
                <a href="{{ url_for('staff_consultations') }}"
                   class="sidebar-item-active flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all group">
                    <div class="flex items-center justify-center" :class="sidebarCollapsed && !sidebarHovered ? 'w-full' : ''">
                        <i data-feather="message-circle" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                    </div>
                    <span x-show="!sidebarCollapsed || sidebarHovered" x-transition class="font-medium">Consultations</span>
                </a>
                
                <!-- Inventory -->
                <a href="{{ url_for('staff_inventory') }}"
                   class="flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all group hover:bg-white/10">
                    <div class="flex items-center justify-center" :class="sidebarCollapsed && !sidebarHovered ? 'w-full' : ''">
                        <i data-feather="package" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                    </div>
                    <span x-show="!sidebarCollapsed || sidebarHovered" x-transition class="font-medium">Inventory</span>
                </a>
                
                <!-- Reports -->
                <a href="{{ url_for('staff_reports') }}"
                   class="flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all group hover:bg-white/10">
                    <div class="flex items-center justify-center" :class="sidebarCollapsed && !sidebarHovered ? 'w-full' : ''">
                        <i data-feather="bar-chart-2" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                    </div>
                    <span x-show="!sidebarCollapsed || sidebarHovered" x-transition class="font-medium">Reports</span>
                </a>
                
            </nav>
        
        <!-- User Profile -->
        <div class="absolute bottom-0 w-full p-4 bg-gradient-to-t from-black/20 to-transparent">
            <div class="relative" @click.outside="userDropdown = false">
                <button @click="userDropdown = !userDropdown" 
                        class="w-full flex items-center gap-3 p-2 rounded-lg hover:bg-white/10 transition-colors" 
                        :class="sidebarCollapsed && !sidebarHovered ? 'justify-center' : ''">
                    <div class="w-10 h-10 bg-gradient-to-br from-yellow-400 to-yellow-500 rounded-full flex items-center justify-center shadow-lg">
                        <span class="text-blue-900 font-bold">{{ user.first_name[0] }}{{ user.last_name[0] }}</span>
                    </div>
                    <div x-show="!sidebarCollapsed || sidebarHovered" x-transition class="flex-1 text-left">
                        <p class="text-sm font-medium text-white">{{ user.first_name }} {{ user.last_name }}</p>
                        <p class="text-xs text-yellow-300">{{ user.position }}</p>
                    </div>
                    <i x-show="!sidebarCollapsed || sidebarHovered" data-feather="chevron-up" class="w-4 h-4 text-white/70"></i>
                </button>
                
                <!-- User Dropdown -->
                <div x-show="userDropdown" 
                     x-transition
                     class="absolute bottom-full left-4 right-4 mb-2 bg-white rounded-lg shadow-lg border border-gray-200 py-1">
                    <button @click="showLogoutConfirm = true; userDropdown = false" class="w-full flex items-center gap-2 px-3 py-2 text-sm text-red-600 hover:bg-red-50 rounded-md mx-1">
                        <i data-feather="log-out" class="w-4 h-4"></i>
                        Logout
                    </button>
                </div>
            </div>
        </div>
        </aside>
        
        <!-- Main Content Area -->
        <div :class="sidebarCollapsed ? 'md:ml-20' : 'md:ml-64'" class="flex-1 flex flex-col transition-all duration-300">
            
            <!-- Main Consultations Content -->
            <main class="flex-1 overflow-hidden bg-gray-50 p-6">
                <!-- Enhanced Consultations Header -->
                <div class="gradient-bg-sidebar text-white shadow-2xl relative overflow-hidden rounded-[2rem] ml-1">
                    <!-- Decorative Elements -->
                    <div class="absolute top-0 right-0 w-64 h-64 bg-white/5 rounded-full -translate-y-32 translate-x-32"></div>
                    <div class="absolute bottom-0 left-0 w-48 h-48 bg-yellow-400/10 rounded-full translate-y-24 -translate-x-24"></div>
                    
                    <!-- Header Content -->
                    <div class="relative px-6 py-5">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <!-- Title Section -->
                            <div class="flex items-center gap-4">
                                <div class="relative">
                                    <div class="w-12 h-12 bg-yellow-400 rounded-xl flex items-center justify-center shadow-lg transform rotate-2 hover:rotate-0 transition-transform duration-300">
                                        <i data-feather="message-circle" class="w-6 h-6 text-blue-900"></i>
                                    </div>
                                    
                                </div>
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <h1 class="text-2xl sm:text-3xl font-bold text-white">
                                            Consultations
                                        </h1>
                                    
                                    </div>
                                    <div class="flex items-center gap-2 text-blue-100">
                                        <i data-feather="activity" class="w-3 h-3"></i>
                                        <span class="text-sm">Manage patient consultations and online chats</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Compact Stats and Actions -->
                            <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3">
                                <!-- Quick Stats -->
                                <div class="flex items-center gap-2">
                                    
                                    <div class="flex items-center gap-1 bg-red-500/20 backdrop-blur-sm rounded-lg px-3 py-1.5 border border-red-400/30" x-show="unreadCount > 0">
                                        <i data-feather="bell" class="w-3 h-3 text-red-300"></i>
                                        <span class="text-red-200 text-xs font-medium" x-text="unreadCount + ' New'">New</span>
                                    </div>
                                </div>
                                
                                <!-- Action Buttons -->
                                <div class="flex items-center gap-2">
                                    <button @click="activeTab = 'consultations'" 
                                            :class="activeTab === 'consultations' ? 'bg-yellow-400 text-blue-900' : 'bg-white/15 text-white border-white/30'"
                                            class="group hover:bg-yellow-500 px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center gap-2 shadow-lg hover:shadow-xl hover:scale-105">
                                        <div class="w-6 h-6 bg-blue-900/20 rounded flex items-center justify-center group-hover:rotate-12 transition-transform">
                                            <i data-feather="clipboard" class="w-3 h-3"></i>
                                        </div>
                                        <span class="hidden sm:inline">All</span>
                                    </button>
                                    
                                    <button @click="activeTab = 'online'" 
                                            :class="activeTab === 'online' ? 'bg-yellow-400 text-blue-900' : 'bg-blue-600 text-white'"
                                            class="group hover:bg-yellow-500 px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center gap-2 shadow-lg hover:shadow-xl hover:scale-105 relative">
                                        <div class="w-6 h-6 bg-blue-900/20 rounded flex items-center justify-center group-hover:rotate-12 transition-transform">
                                            <i data-feather="message-circle" class="w-3 h-3"></i>
                                        </div>
                                        <span>Online</span>
                                        <span x-show="unreadCount > 0" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center" x-text="unreadCount"></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- All Consultations Tab -->
                <div x-show="activeTab === 'consultations'" class="p-6 h-full overflow-y-auto">
                    
                    <!-- Consultation Statistics -->
                    <div class="mb-6">
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5">
                            <!-- Total Medical Records Card -->
                            <div class="stat-card bg-white rounded-xl shadow-md border border-gray-100 p-6 hover:shadow-xl" data-aos="fade-up" data-aos-delay="100">
                                <div class="flex items-center justify-between">
                                    <div class="flex-1">
                                        <p class="text-xs font-semibold uppercase tracking-wide text-gray-500 mb-1">Total Records</p>
                                        <p class="text-3xl font-bold text-gray-900" x-text="consultations.length">0</p>
                                        <div class="flex items-center gap-2 mt-3">
                                            <span class="inline-flex items-center text-xs font-medium text-blue-600 bg-blue-50 px-2 py-1 rounded-full">
                                                All patients
                                            </span>
                                        </div>
                                    </div>
                                    <div class="w-14 h-14 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center shadow-lg">
                                        <i data-feather="file-text" class="w-7 h-7 text-white"></i>
                                    </div>
                                </div>
                            </div>
                        
                            <!-- Today's Consultations Card -->
                            <div class="stat-card bg-white rounded-xl shadow-md border border-gray-100 p-6 hover:shadow-xl" data-aos="fade-up" data-aos-delay="200">
                                <div class="flex items-center justify-between">
                                    <div class="flex-1">
                                        <p class="text-xs font-semibold uppercase tracking-wide text-gray-500 mb-1">Today's Visits</p>
                                        <p class="text-3xl font-bold text-gray-900" x-text="todayConsultations">0</p>
                                        <div class="flex items-center gap-2 mt-3">
                                            <span class="inline-flex items-center text-xs font-medium text-green-600 bg-green-50 px-2 py-1 rounded-full">
                                                Active today
                                            </span>
                                        </div>
                                    </div>
                                    <div class="w-14 h-14 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center shadow-lg">
                                        <i data-feather="calendar" class="w-7 h-7 text-white"></i>
                                    </div>
                                </div>
                            </div>
                        
                            <!-- This Week Card -->
                            <div class="stat-card bg-white rounded-xl shadow-md border border-gray-100 p-6 hover:shadow-xl" data-aos="fade-up" data-aos-delay="300">
                                <div class="flex items-center justify-between">
                                    <div class="flex-1">
                                        <p class="text-xs font-semibold uppercase tracking-wide text-gray-500 mb-1">This Week</p>
                                        <p class="text-3xl font-bold text-gray-900" x-text="thisWeekConsultations">0</p>
                                        <div class="flex items-center gap-2 mt-3">
                                            <span class="inline-flex items-center text-xs font-medium text-purple-600 bg-purple-50 px-2 py-1 rounded-full">
                                                Last 7 days
                                            </span>
                                        </div>
                                    </div>
                                    <div class="w-14 h-14 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
                                        <i data-feather="trending-up" class="w-7 h-7 text-white"></i>
                                    </div>
                                </div>
                            </div>
                        
                            <!-- This Month Card -->
                            <div class="stat-card bg-white rounded-xl shadow-md border border-gray-100 p-6 hover:shadow-xl" data-aos="fade-up" data-aos-delay="400">
                                <div class="flex items-center justify-between">
                                    <div class="flex-1">
                                        <p class="text-xs font-semibold uppercase tracking-wide text-gray-500 mb-1">This Month</p>
                                        <p class="text-3xl font-bold text-gray-900" x-text="thisMonthConsultations">0</p>
                                        <div class="flex items-center gap-2 mt-3">
                                            <span class="inline-flex items-center text-xs font-medium text-orange-700 bg-orange-50 px-2 py-1 rounded-full">
                                                Current month
                                            </span>
                                        </div>
                                    </div>
                                    <div class="w-14 h-14 bg-gradient-to-br from-orange-400 to-orange-500 rounded-xl flex items-center justify-center shadow-lg">
                                        <i data-feather="bar-chart-2" class="w-7 h-7 text-white"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Enhanced Filters and Search -->
                    <div class="mb-6 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl shadow-lg border border-blue-100 p-6">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                                <i data-feather="filter" class="w-5 h-5 text-white"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-gray-900">Filter Medical Records</h3>
                                <p class="text-sm text-gray-600">Refine your search to find specific consultations</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Patient Type Filter -->
                            <div class="space-y-2">
                                <label class="flex items-center gap-2 text-sm font-semibold text-gray-700">
                                    <i data-feather="users" class="w-4 h-4 text-blue-600"></i>
                                    Patient Type
                                </label>
                                <select x-model="selectedRole" 
                                        class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white text-gray-900 transition-all hover:border-blue-300">
                                    <option value="">All Patient Types</option>
                                    <option value="Student">üë®‚Äçüéì Students</option>
                                    <option value="Teaching Staff">üë®‚Äçüè´ Teaching Staff</option>
                                    <option value="Non-Teaching Staff">üëî Non-Teaching Staff</option>
                                    <option value="Visitor">üö∂ Visitors</option>
                                    <option value="President">üé© President</option>
                                    <option value="Dean">üë®‚Äçüíº Dean</option>
                                </select>
                            </div>
                            
                            <!-- Date Range Filter -->
                            <div class="space-y-2">
                                <label class="flex items-center gap-2 text-sm font-semibold text-gray-700">
                                    <i data-feather="calendar" class="w-4 h-4 text-blue-600"></i>
                                    Date Range
                                </label>
                                <select x-model="selectedDateFilter" 
                                        class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white text-gray-900 transition-all hover:border-blue-300">
                                    <option value="">All Dates</option>
                                    <option value="today">üìÖ Today</option>
                                    <option value="week">üìÜ This Week</option>
                                    <option value="month">üóìÔ∏è This Month</option>
                                </select>
                            </div>
                            
                            <!-- Search Input -->
                            <div class="space-y-2">
                                <label class="flex items-center gap-2 text-sm font-semibold text-gray-700">
                                    <i data-feather="search" class="w-4 h-4 text-blue-600"></i>
                                    Search Patient
                                </label>
                                <div class="relative">
                                    <input type="text" x-model="searchTerm" 
                                           placeholder="Enter name or ID..." 
                                           class="w-full px-4 py-2.5 pl-10 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white text-gray-900 transition-all hover:border-blue-300">
                                    <i data-feather="search" class="w-4 h-4 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2"></i>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex items-center justify-between mt-5 pt-5 border-t border-blue-200">
                            <div class="flex items-center gap-2">
                                <div x-show="selectedRole || selectedDateFilter || searchTerm" 
                                     class="flex items-center gap-2 px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium">
                                    <i data-feather="check-circle" class="w-4 h-4"></i>
                                    <span>Filters Active</span>
                                </div>
                            </div>
                            
                            <button @click="clearFilters()" 
                                    x-show="selectedRole || selectedDateFilter || searchTerm"
                                    class="px-5 py-2.5 bg-white hover:bg-red-50 text-red-600 border-2 border-red-200 hover:border-red-300 rounded-lg transition-all font-medium flex items-center gap-2 shadow-sm hover:shadow">
                                <i data-feather="x-circle" class="w-4 h-4"></i>
                                <span>Clear All Filters</span>
                            </button>
                        </div>
                    </div>

                    <!-- Results Counter -->
                    <div class="mb-4 bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                                    <i data-feather="database" class="w-4 h-4 text-blue-600"></i>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-900">
                                        Showing <span class="text-blue-600 font-bold" x-text="filteredConsultations.length"></span> 
                                        of <span class="text-gray-600 font-bold" x-text="consultations.length"></span> records
                                    </p>
                                    <p class="text-xs text-gray-500">Medical consultation records</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Consultations Table -->
                    <div class="bg-white rounded-xl shadow-md border border-gray-100 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reason of Visit</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Treatment</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    <template x-for="consultation in filteredConsultations" :key="consultation.id">
                                        <tr @click="viewConsultation(consultation)" class="hover:bg-blue-50 transition-colors cursor-pointer">
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="filteredConsultations.indexOf(consultation) + 1"></td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="text-sm font-medium text-gray-900" x-text="consultation.patient"></div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <span x-text="consultation.role || 'Student'" 
                                                      :class="{
                                                          'bg-blue-100 text-blue-800': consultation.role === 'Student' || !consultation.role,
                                                          'bg-green-100 text-green-800': consultation.role === 'Teaching Staff',
                                                          'bg-purple-100 text-purple-800': consultation.role === 'Non-Teaching Staff',
                                                          'bg-orange-100 text-orange-800': consultation.role === 'Visitor',
                                                          'bg-red-100 text-red-800': consultation.role === 'Dean',
                                                          'bg-yellow-100 text-yellow-800': consultation.role === 'President'
                                                      }"
                                                      class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                                                </span>
                                            </td>
                                            <td class="px-6 py-4">
                                                <div class="text-sm text-gray-900 max-w-xs truncate" x-text="consultation.fullDetails?.symptoms || consultation.symptoms || 'No reason specified'"></div>
                                            </td>
                                            <td class="px-6 py-4">
                                                <div class="text-sm text-gray-600 max-w-xs truncate" x-text="consultation.fullDetails?.treatment || consultation.treatment || '-'"></div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="consultation.date"></td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="formatTime(consultation.time)"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Online Consultations Tab -->
                <div x-show="activeTab === 'online'" class="flex h-full">
                    <!-- Students List Sidebar -->
                    <div class="w-80 bg-white border-r border-gray-200 flex flex-col" :class="selectedChat ? 'hidden lg:flex' : 'flex'">
                        <!-- Header -->
                        <!-- Enhanced Chat List Header -->
                        <div class="p-5 border-b border-gray-200 bg-white shadow-sm">
                            <!-- Title Section -->
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-md">
                                        <i data-feather="message-circle" class="w-5 h-5 text-white"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-bold text-gray-900">Consultations</h3>
                                        <p class="text-xs text-gray-500">Active patient chats</p>
                                    </div>
                                </div>
                                
                                <!-- Action Buttons -->
                                <div class="flex items-center gap-2">
                                    <!-- Unread Count Badge -->
                                    <div x-show="unreadCount > 0" 
                                         class="bg-red-500 text-white text-xs font-bold px-3 py-1.5 rounded-full shadow-sm animate-pulse">
                                        <span x-text="unreadCount"></span> new
                                    </div>
                                    
                                    <!-- Total Chats Badge -->
                                    <div class="bg-blue-50 text-blue-700 text-xs font-semibold px-3 py-1.5 rounded-full border border-blue-200">
                                        <i data-feather="users" class="w-3 h-3 inline mr-1"></i>
                                        <span x-text="onlineChats.length"></span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Enhanced Search Bar -->
                            <div class="relative">
                                <input x-model="studentSearch" 
                                       type="text" 
                                       placeholder="Search patients by name or ID..." 
                                       class="w-full pl-10 pr-10 py-2.5 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:bg-white transition-all duration-200 text-sm placeholder-gray-400">
                                <i data-feather="search" class="absolute left-3 top-3 w-4 h-4 text-gray-400"></i>
                                
                                <!-- Clear Search Button -->
                                <button x-show="studentSearch" 
                                        @click="studentSearch = ''"
                                        class="absolute right-3 top-2.5 text-gray-400 hover:text-gray-600">
                                    <i data-feather="x" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Active Chats List - Enhanced Messenger Style -->
                        <div class="flex-1 overflow-y-auto max-h-[calc(100vh-300px)] scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 hover:scrollbar-thumb-gray-400">
                            <template x-for="chat in filteredChats" :key="chat.id">
                                <div @click="selectChat(chat)" 
                                     :class="selectedChat?.id === chat.id ? 'bg-blue-50 border-r-4 border-blue-500 shadow-sm' : 'hover:bg-gray-50'"
                                     class="p-4 border-b border-gray-100 cursor-pointer transition-all duration-200 hover:shadow-sm relative group">
                                    
                                    <!-- New Chat Indicator -->
                                    <div x-show="chat.isNew" class="absolute top-2 left-2 w-3 h-3 bg-green-500 rounded-full animate-ping"></div>
                                    
                                    <div class="flex items-center space-x-3">
                                        <div class="relative">
                                            <div class="w-14 h-14 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-md transition-transform group-hover:scale-105">
                                                <span x-text="chat.patient ? chat.patient.split(' ').map(n => n[0]).join('') : 'P'"></span>
                                            </div>
                                            <!-- Typing Indicator -->
                                            <div x-show="chat.isTyping" class="absolute -bottom-1 -right-1 w-5 h-5 bg-yellow-500 border-3 border-white rounded-full animate-bounce">
                                                <div class="w-2 h-2 bg-white rounded-full mx-auto mt-0.5"></div>
                                            </div>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-center justify-between mb-1">
                                                <div class="flex items-center space-x-2">
                                                    <h4 class="text-sm font-bold text-gray-900 truncate uppercase tracking-wide" x-text="chat.patient || 'Unknown Patient'"></h4>
                                                    <!-- New Message Dot -->
                                                    <div x-show="chat.unreadCount > 0" class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
                                                </div>
                                            </div>
            
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center space-x-2">
                                                    <span class="text-sm text-blue-600 font-semibold" x-text="chat.patientId || chat.studentId || 'N/A'"></span>
                                                    <span x-show="chat.patientType" class="text-xs bg-blue-50 text-blue-700 px-2 py-0.5 rounded-full font-medium" x-text="chat.patientType"></span>
                                                </div>
                                                <div class="flex items-center space-x-1">
                                                    <!-- Message Count Badge -->
                                                    <div x-show="chat.unreadCount > 0" 
                                                         class="bg-red-500 text-white text-xs rounded-full px-2 py-1 min-w-[20px] text-center font-bold shadow-sm">
                                                        <span x-text="chat.unreadCount"></span>
                                                    </div>
                                                    <!-- Priority Indicator -->
                                                    <div x-show="chat.priority === 'urgent'" class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                            
                            <!-- Enhanced Empty state -->
                            <div x-show="filteredChats.length === 0" class="p-8 text-center">
                                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i data-feather="message-circle" class="w-8 h-8 text-gray-400"></i>
                                </div>
                                <h3 class="text-gray-700 font-medium mb-2" x-text="studentSearch ? 'No patients found' : 'Waiting for consultations'"></h3>
                                <p class="text-gray-500 text-sm mb-1" x-text="studentSearch ? 'Try a different search term' : 'Patients will appear here automatically'"></p>
                                <p class="text-gray-400 text-xs" x-show="!studentSearch">when they start a new consultation</p>
                                <div class="mt-4 flex items-center justify-center space-x-1" x-show="!studentSearch">
                                    <div class="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></div>
                                    <div class="w-2 h-2 bg-blue-400 rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
                                    <div class="w-2 h-2 bg-blue-400 rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Window -->
                    <div class="flex-1 flex" :class="!selectedChat ? 'hidden lg:flex' : 'flex'">
                        <template x-if="selectedChat">
                            <!-- Main Chat Area -->
                            <div class="flex-1 flex flex-col bg-white">
                                <!-- Messenger-Style Chat Header -->
                                <div class="p-4 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-white shadow-sm">
                                    <div class="flex items-center justify-between">
                                        <!-- Left Side: Patient Info -->
                                        <div class="flex items-center space-x-4">
                                            <button @click="selectedChat = null" class="lg:hidden text-gray-600 hover:bg-gray-100 p-2 rounded-lg">
                                                <i data-feather="arrow-left" class="w-5 h-5"></i>
                                            </button>
                                            <div class="relative">
                                                <div class="w-14 h-14 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-md">
                                                    <span x-text="selectedChat.patient ? selectedChat.patient.split(' ').map(n => n[0]).join('') : 'P'"></span>
                                                </div>
                                            </div>
                                            <div>
                                                <h3 class="text-xl font-bold text-gray-900" x-text="selectedChat.patient || 'Unknown Patient'"></h3>
                                                <div class="flex items-center space-x-3 mt-1">
                                                    <span class="text-sm text-blue-600 font-medium bg-blue-100 px-2 py-1 rounded-full" x-text="selectedChat.patientId || selectedChat.studentId || 'N/A'"></span>
                                                    <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full" x-text="selectedChat.role || selectedChat.patientType || 'Student'"></span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Right Side: Delete Button -->
                                        <button @click="confirmDeleteChat(selectedChat)" 
                                                class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors duration-200 flex items-center space-x-2 shadow-sm">
                                            <i data-feather="trash-2" class="w-4 h-4"></i>
                                            <span class="text-sm font-medium">Delete Chat</span>
                                        </button>
                                    </div>
                                </div>

                                <!-- Messages Area -->
                                <div class="overflow-y-auto p-6 bg-gray-50" style="height: calc(100vh - 400px); min-height: 300px;" x-ref="messagesContainer">
                                    <div class="space-y-4">
                                        <!-- No messages state -->
                                        <div x-show="selectedChat && (!selectedChat.messages || selectedChat.messages.length === 0)" class="flex items-center justify-center h-full">
                                            <div class="text-center text-gray-500">
                                                <i data-feather="message-circle" class="w-12 h-12 mx-auto mb-3 text-gray-300"></i>
                                                <p class="text-sm">No messages yet</p>
                                                <p class="text-xs mt-1">Start the conversation by sending a message</p>
                                            </div>
                                        </div>
                                        
                                        <!-- Messenger-Style Messages -->
                                        <template x-for="message in (selectedChat?.messages || [])" :key="message.id">
                                            <div class="flex items-start gap-3 mb-4" :class="message.sender === 'doctor' ? 'flex-row-reverse' : 'flex-row'">
                                                <!-- Avatar -->
                                                <div class="flex-shrink-0">
                                                    <div :class="message.sender === 'doctor' ? 'bg-blue-500' : 'bg-gray-500'" 
                                                         class="w-8 h-8 rounded-full flex items-center justify-center text-white text-xs font-bold">
                                                        <span x-text="message.sender === 'doctor' ? 'N' : (selectedChat?.patient ? selectedChat.patient.split(' ').map(n => n[0]).join('') : 'P')"></span>
                                                    </div>
                                                </div>
                                                
                                                <!-- Message Content -->
                                                <div class="flex-1 max-w-xs lg:max-w-md">
                                                    <!-- Message Bubble -->
                                                    <div :class="message.sender === 'doctor' ? 'bg-blue-500 text-white' : 'bg-white text-gray-900 border border-gray-200'" 
                                                         class="px-4 py-3 rounded-2xl shadow-sm relative">
                                                        
                                                        <!-- Message Tail -->
                                                        <div :class="message.sender === 'doctor' ? 'right-0 border-l-blue-500' : 'left-0 border-r-gray-200'" 
                                                             class="absolute top-3 w-0 h-0 border-t-4 border-b-4 border-transparent" 
                                                             :style="message.sender === 'doctor' ? 'right: -8px; border-left: 8px solid #3b82f6;' : 'left: -8px; border-right: 8px solid #e5e7eb;'"></div>
                                                        
                                                        <!-- File/Media Message -->
                                                        <div x-show="message.type === 'file'" class="flex items-center space-x-3 mb-2">
                                                            <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center">
                                                                <i data-feather="file" class="w-5 h-5 text-gray-600"></i>
                                                            </div>
                                                            <div>
                                                                <p class="text-sm font-medium" x-text="message.fileName"></p>
                                                                <p class="text-xs opacity-75" x-text="message.fileSize"></p>
                                                            </div>
                                                        </div>
                                                        
                                                        <!-- Text Message -->
                                                        <p class="text-sm leading-relaxed" x-text="message.text || 'No message content'"></p>
                                                    </div>
                                                    
                                                    <!-- Message Time and Status -->
                                                    <div :class="message.sender === 'doctor' ? 'text-right' : 'text-left'" class="mt-1 px-2">
                                                        <span class="text-xs text-gray-500" x-text="message.time"></span>
                                                        <span x-show="message.sender === 'doctor'" class="text-xs text-blue-500 ml-1">‚úì</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>

                                <!-- Messenger-Style Input Area -->
                                <div class="bg-white border-t border-gray-200">
                                    <!-- Facebook-Style Suggested Replies -->
                                    <div class="px-4 pt-3 pb-2 border-b border-gray-100">
                                        <div class="flex items-center mb-2">
                                            <svg class="w-4 h-4 text-gray-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                            </svg>
                                            <span class="text-xs font-semibold text-gray-600 uppercase tracking-wide">Suggested Replies</span>
                                        </div>
                                        <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                                            <!-- Suggested Reply 1 -->
                                            <button @click="newMessage = 'Thank you for reaching out. How can I help you today?'; sendMessage()" 
                                                    class="flex-shrink-0 px-4 py-2.5 bg-white border-2 border-gray-200 rounded-full text-sm font-medium text-gray-700 hover:bg-gray-50 hover:border-blue-400 transition-all duration-200 shadow-sm hover:shadow">
                                                üëã Thank you for reaching out
                                            </button>
                                            
                                            <!-- Suggested Reply 2 -->
                                            <button @click="newMessage = 'Please come to the clinic for further evaluation.'; sendMessage()" 
                                                    class="flex-shrink-0 px-4 py-2.5 bg-white border-2 border-gray-200 rounded-full text-sm font-medium text-gray-700 hover:bg-gray-50 hover:border-blue-400 transition-all duration-200 shadow-sm hover:shadow">
                                                üè• Visit the clinic
                                            </button>
                                            
                                            <!-- Suggested Reply 3 -->
                                            <button @click="newMessage = 'I recommend taking rest and staying hydrated.'; sendMessage()" 
                                                    class="flex-shrink-0 px-4 py-2.5 bg-white border-2 border-gray-200 rounded-full text-sm font-medium text-gray-700 hover:bg-gray-50 hover:border-blue-400 transition-all duration-200 shadow-sm hover:shadow">
                                                üíä Rest and hydrate
                                            </button>
                                            
                                            <!-- Suggested Reply 4 -->
                                            <button @click="newMessage = 'Can you describe your symptoms in more detail?'; sendMessage()" 
                                                    class="flex-shrink-0 px-4 py-2.5 bg-white border-2 border-gray-200 rounded-full text-sm font-medium text-gray-700 hover:bg-gray-50 hover:border-blue-400 transition-all duration-200 shadow-sm hover:shadow">
                                                üìã Describe symptoms
                                            </button>
                                            
                                            <!-- Suggested Reply 5 -->
                                            <button @click="newMessage = 'How long have you been experiencing this?'; sendMessage()" 
                                                    class="flex-shrink-0 px-4 py-2.5 bg-white border-2 border-gray-200 rounded-full text-sm font-medium text-gray-700 hover:bg-gray-50 hover:border-blue-400 transition-all duration-200 shadow-sm hover:shadow">
                                                ‚è∞ How long?
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Message Input Row -->
                                    <div class="p-4 flex items-end space-x-3">
                                        <!-- Message Input -->
                                        <div class="flex-1 relative">
                                            <textarea x-model="newMessage" 
                                                     @keydown.enter.prevent="sendMessage()"
                                                     @input="autoResize($event)"
                                                     rows="1"
                                                     :placeholder="selectedChat ? 'Type a message...' : 'Select a chat to start messaging'"
                                                     :disabled="!selectedChat"
                                                     class="w-full px-5 py-3 pr-14 border-2 border-gray-300 rounded-3xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none text-sm bg-gray-50 hover:bg-white transition-all duration-200 disabled:bg-gray-100 disabled:cursor-not-allowed"></textarea>
                                            
                                            <!-- Send Button (Inside Input) -->
                                            <button @click="sendMessage()" 
                                                    :disabled="!newMessage.trim() || !selectedChat"
                                                    :class="(newMessage.trim() && selectedChat) ? 'bg-blue-500 hover:bg-blue-600 text-white' : 'bg-gray-300 text-gray-500 cursor-not-allowed'"
                                                    class="absolute right-2 top-1/2 transform -translate-y-1/2 p-2.5 rounded-full transition-all duration-200">
                                                <i data-feather="send" class="w-4 h-4"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                        
                        
                        <!-- Empty State -->
                        <template x-if="!selectedChat">
                            <div class="flex-1 flex items-center justify-center bg-gray-50">
                                <div class="text-center">
                                    <i data-feather="message-circle" class="w-20 h-20 text-gray-300 mx-auto mb-4"></i>
                                    <h3 class="text-xl font-semibold text-gray-900 mb-2">Start a Conversation</h3>
                                    <p class="text-gray-500 mb-6">Select a student from the list to begin consultation</p>
                                    <div class="bg-white rounded-lg p-4 border border-gray-200 max-w-sm mx-auto">
                                        <h4 class="font-medium text-gray-900 mb-2">Quick Tips:</h4>
                                        <ul class="text-sm text-gray-600 space-y-1 text-left">
                                            <li>‚Ä¢ Share files and media</li>
                                            <li>‚Ä¢ Take consultation notes</li>
                                            <li>‚Ä¢ Pin important messages</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </main>
        </div>
        
        <!-- Loading Overlay with iClinic Logo -->
        <div x-show="isLoadingConsultations" 
             x-cloak
             class="fixed inset-0 bg-white bg-opacity-95 flex items-center justify-center z-50"
             style="display: none;">
            <div class="text-center">
                <!-- iClinic Logo with Animation -->
                <div class="relative mb-6">
                    <!-- Animated Circle Background -->
                    <div class="absolute inset-0 flex items-center justify-center">
                        <div class="w-32 h-32 border-4 border-blue-200 rounded-full animate-ping"></div>
                    </div>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <div class="w-32 h-32 border-4 border-blue-400 border-t-transparent rounded-full animate-spin"></div>
                    </div>
                    
                    <!-- Logo Container -->
                    <div class="relative w-32 h-32 bg-white rounded-full flex items-center justify-center shadow-2xl mx-auto border-4 border-blue-100">
                        <!-- iClinic Logo Image -->
                        <img src="../../assets/img/iclinic-logo.png" 
                             alt="iClinic Logo" 
                             class="w-20 h-20 object-contain animate-pulse">
                    </div>
                </div>
                
                <!-- Loading Text -->
                <h3 class="text-2xl font-bold text-gray-900 mb-2">iClinic</h3>
                <p class="text-gray-600 mb-4">Loading consultations...</p>
                
                <!-- Animated Dots -->
                <div class="flex items-center justify-center space-x-2">
                    <div class="w-3 h-3 bg-blue-500 rounded-full animate-bounce"></div>
                    <div class="w-3 h-3 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                    <div class="w-3 h-3 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                </div>
            </div>
        </div>
        
        <!-- Custom Modal Component -->
        <div x-show="modal.show" 
             x-cloak
             @click.self="modal.show = false"
             class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
             style="display: none;">
            <div @click.stop 
                 x-show="modal.show"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 transform scale-90"
                 x-transition:enter-end="opacity-100 transform scale-100"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100 transform scale-100"
                 x-transition:leave-end="opacity-0 transform scale-90"
                 class="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden">
                
                <!-- Modal Header -->
                <div class="px-6 py-4 border-b border-gray-200" :class="{
                    'bg-red-50': modal.type === 'error',
                    'bg-green-50': modal.type === 'success',
                    'bg-blue-50': modal.type === 'info',
                    'bg-yellow-50': modal.type === 'warning'
                }">
                    <div class="flex items-center space-x-3">
                        <!-- Icon -->
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center" :class="{
                                'bg-red-100': modal.type === 'error',
                                'bg-green-100': modal.type === 'success',
                                'bg-blue-100': modal.type === 'info',
                                'bg-yellow-100': modal.type === 'warning'
                            }">
                                <svg x-show="modal.type === 'error'" class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                                <svg x-show="modal.type === 'success'" class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                <svg x-show="modal.type === 'info'" class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <svg x-show="modal.type === 'warning'" class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                            </div>
                        </div>
                        <!-- Title -->
                        <h3 class="text-lg font-semibold text-gray-900" x-text="modal.title"></h3>
                    </div>
                </div>
                
                <!-- Modal Body -->
                <div class="px-6 py-4">
                    <p class="text-gray-600 whitespace-pre-line" x-text="modal.message"></p>
                </div>
                
                <!-- Modal Footer -->
                <div class="px-6 py-4 bg-gray-50 flex justify-end space-x-3">
                    <button x-show="modal.showCancel" 
                            @click="modal.onCancel(); modal.show = false"
                            class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium">
                        <span x-text="modal.cancelText"></span>
                    </button>
                    <button @click="modal.onConfirm(); modal.show = false"
                            class="px-4 py-2 rounded-lg text-white font-medium transition-colors" :class="{
                                'bg-red-600 hover:bg-red-700': modal.type === 'error' || modal.type === 'warning',
                                'bg-green-600 hover:bg-green-700': modal.type === 'success',
                                'bg-blue-600 hover:bg-blue-700': modal.type === 'info'
                            }">
                        <span x-text="modal.confirmText"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script>
        function consultationsModule() {
            return {
                // State
                sidebarCollapsed: false,
                mobileMenuOpen: false,
                userDropdown: false,
                
                // Modal state
                modal: {
                    show: false,
                    type: 'info', // 'success', 'error', 'warning', 'info'
                    title: '',
                    message: '',
                    confirmText: 'OK',
                    cancelText: 'Cancel',
                    showCancel: false,
                    onConfirm: () => {},
                    onCancel: () => {}
                },
                
                // Loading state
                isLoadingConsultations: false,
                showSettingsModal: false,
                showLogoutConfirm: false,
                notificationDropdown: false,
                userDropdown: false,
                activeTab: 'consultations',
                selectedRole: '',
                selectedDateFilter: '',
                searchTerm: '',
                showAddModal: false,
                showViewModal: false,
                showEditModal: false,
                showDeleteModal: false,
                selectedConsultation: null,
                
                
                // Chat state
                selectedChat: null,
                newMessage: '',
                unreadCount: 0,
                messagePollingInterval: null,
                lastMessageTime: 0,
                showFileUpload: false,
                studentSearch: '',
                consultationNotes: '',
                
                // Student data
                availableStudents: [],
                chatFiles: [],
                chatMedia: [],
                pinnedMessages: [],
                
                // Medical records data from database
                consultations: [],

                // Sample student data - connected to database
                onlineChats: [],
                
                // Audio context for notifications
                audioContext: null,
                userHasInteracted: false,
                
                // Computed properties
                get filteredConsultations() {
                    return this.consultations.filter(consultation => {
                        // Filter by patient role/type
                        const matchesRole = !this.selectedRole || consultation.role === this.selectedRole;
                        
                        // Filter by date range
                        let matchesDate = true;
                        if (this.selectedDateFilter) {
                            const consultDate = new Date(consultation.date);
                            const today = new Date();
                            
                            if (this.selectedDateFilter === 'today') {
                                const todayStr = today.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                                matchesDate = consultation.date === todayStr;
                            } else if (this.selectedDateFilter === 'week') {
                                const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                                matchesDate = consultDate >= weekAgo && consultDate <= today;
                            } else if (this.selectedDateFilter === 'month') {
                                matchesDate = consultDate.getMonth() === today.getMonth() && 
                                            consultDate.getFullYear() === today.getFullYear();
                            }
                        }
                        
                        // Filter by search term (patient name or ID)
                        const matchesSearch = !this.searchTerm || 
                            consultation.patient.toLowerCase().includes(this.searchTerm.toLowerCase()) ||
                            consultation.patientId.toLowerCase().includes(this.searchTerm.toLowerCase());
                        
                        return matchesRole && matchesDate && matchesSearch;
                    });
                },
                
                clearFilters() {
                    this.selectedRole = '';
                    this.selectedDateFilter = '';
                    this.searchTerm = '';
                    
                    // Reinitialize feather icons after Alpine updates DOM
                    this.$nextTick(() => {
                        if (typeof feather !== 'undefined') {
                            feather.replace();
                        }
                    });
                },

                get filteredStudents() {
                    return this.availableStudents.filter(student => {
                        if (!this.studentSearch) return true;
                        const searchTerm = this.studentSearch.toLowerCase();
                        return student.name.toLowerCase().includes(searchTerm) ||
                               student.studentId.toLowerCase().includes(searchTerm) ||
                               student.course.toLowerCase().includes(searchTerm);
                    });
                },

                get filteredChats() {
                    return this.onlineChats.filter(chat => {
                        if (!this.studentSearch) return true;
                        const searchTerm = this.studentSearch.toLowerCase();
                        const patientName = (chat.patient || '').toLowerCase();
                        const patientId = (chat.patientId || chat.studentId || '').toLowerCase();
                        const patientType = (chat.patientType || '').toLowerCase();
                        return patientName.includes(searchTerm) ||
                               patientId.includes(searchTerm) ||
                               patientType.includes(searchTerm);
                    });
                },
                
                // Statistics computed properties
                get todayConsultations() {
                    const today = new Date();
                    const todayStr = today.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    return this.consultations.filter(c => c.date === todayStr).length;
                },
                
                get thisWeekConsultations() {
                    const today = new Date();
                    const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                    return this.consultations.filter(c => {
                        const consultDate = new Date(c.date);
                        return consultDate >= weekAgo && consultDate <= today;
                    }).length;
                },
                
                get thisMonthConsultations() {
                    const today = new Date();
                    const currentMonth = today.getMonth();
                    const currentYear = today.getFullYear();
                    return this.consultations.filter(c => {
                        const consultDate = new Date(c.date);
                        return consultDate.getMonth() === currentMonth && consultDate.getFullYear() === currentYear;
                    }).length;
                },
                
                // Format time to 12-hour format with AM/PM (PH format)
                formatTime(time) {
                    if (!time) return 'N/A';
                    
                    // Convert to string if not already
                    const timeStr = String(time);
                    
                    // Handle different time formats
                    let hours, minutes;
                    
                    if (timeStr.includes(':')) {
                        // Format: "HH:MM" or "HH:MM:SS"
                        const parts = timeStr.split(':');
                        hours = parseInt(parts[0]);
                        minutes = parts[1];
                        
                        // Validate hours and minutes
                        if (isNaN(hours) || !minutes) {
                            return timeStr; // Return original if invalid
                        }
                    } else {
                        return timeStr; // Return as-is if not in expected format
                    }
                    
                    // Convert to 12-hour format
                    const period = hours >= 12 ? 'PM' : 'AM';
                    hours = hours % 12 || 12; // Convert 0 to 12 for midnight
                    return `${hours}:${minutes} ${period}`;
                },
                
                // Methods
                async init() {
                    // Ensure modal is closed on page load
                    this.modal.show = false;
                    
                    // Load medical records from database
                    await this.loadMedicalRecords();
                    
                    // Load online consultations from database
                    await this.loadOnlineConsultations();
                    
                    // Load students from database
                    await this.loadStudents();
                    
                    // Initialize feather icons
                    setTimeout(() => {
                        if (typeof feather !== 'undefined') {
                            feather.replace();
                        }
                    }, 100);
                    
                    // Initialize AOS
                    if (typeof AOS !== 'undefined') {
                        AOS.init({
                            duration: 800,
                            easing: 'ease-out-cubic'
                        });
                    }
                    
                    // Request notification permission
                    this.requestNotificationPermission();
                    
                    // Initialize audio context on first user interaction
                    this.initializeAudioContext();
                    
                    // Update unread count
                    this.updateUnreadCount();
                    
                    // üîÑ REAL-TIME AUTO-REFRESH: Check for new medical records every 10 seconds
                    setInterval(() => {
                        this.loadMedicalRecords();
                    }, 10000); // 10 seconds interval
                    
                    // Auto-refresh online consultations every 10 seconds for real-time updates
                    setInterval(() => {
                        this.loadOnlineConsultations();
                    }, 10000);
                    
                    // Additional polling for immediate new consultation detection
                    this.startNewConsultationPolling();
                    
                    console.log('‚úÖ Real-time monitoring started: Medical records will auto-refresh every 10 seconds');
                },

                async loadOnlineConsultations(showLoading = false) {
                    // Only show loading animation if explicitly requested (e.g., refresh button)
                    if (showLoading) {
                        this.isLoadingConsultations = true;
                    }
                    
                    // Track start time for minimum loading duration
                    const startTime = Date.now();
                    
                    try {
                        console.log('üîÑ Loading online consultations from API...');
                        const response = await fetch('/api/online-consultations');
                        console.log('üì° Online consultations API Response status:', response.status);
                        
                        if (response.status === 401) {
                            console.warn('Session expired, redirecting to login');
                            window.location.href = '/login';
                            return;
                        }
                        if (response.ok) {
                            const consultations = await response.json();
                            console.log('‚úÖ Loaded online consultations:', consultations.length, 'consultations');
                            console.log('üí¨ Sample consultation:', consultations[0]);
                            
                            // Store previous consultation IDs to detect new ones
                            const previousChatIds = new Set(this.onlineChats.map(chat => chat.id));
                            
                            // Create a Map to track unique consultations by ID
                            const uniqueConsultationsMap = new Map();
                            
                            consultations.forEach(consultation => {
                                // Only keep the first occurrence of each consultation ID
                                if (!uniqueConsultationsMap.has(consultation.id)) {
                                    uniqueConsultationsMap.set(consultation.id, consultation);
                                }
                            });
                            
                            // Convert Map back to array and transform data
                            const newOnlineChats = Array.from(uniqueConsultationsMap.values()).map(consultation => {
                                // Preserve existing messages if chat already exists
                                const existingChat = this.onlineChats.find(chat => chat.id === consultation.id);
                                return {
                                    id: consultation.id,
                                    patient: consultation.patient || 'Unknown Patient',
                                    patientId: consultation.patientId || 'N/A',  // Use patientId from backend
                                    studentId: consultation.patientId || 'N/A',  // Keep for backward compatibility
                                    patientType: consultation.patientType,
                                    role: consultation.role || consultation.patientType || 'Student', // Add role field for all user types
                                    online: consultation.online || true, // Default to online for active consultations
                                    unreadCount: consultation.unreadCount || 0,
                                    lastMessage: consultation.lastMessage || 'Started a new consultation',
                                    lastMessageTime: consultation.lastMessageTime || consultation.created_at,
                                    messages: existingChat ? existingChat.messages : [] // Preserve existing messages
                                };
                            });
                            
                            // Detect new consultations for notifications
                            const newConsultations = newOnlineChats.filter(chat => !previousChatIds.has(chat.id));
                            
                            // Show notification for new consultations
                            if (newConsultations.length > 0) {
                                this.showNewConsultationNotification(newConsultations);
                            }
                            
                            this.onlineChats = newOnlineChats;
                            
                            console.log('üéØ Final online chats:', this.onlineChats.length, 'chats');
                            console.log('üìä Sample chat:', this.onlineChats[0]);
                            console.log('üîç Full onlineChats array:', this.onlineChats);
                            
                            // Force Alpine.js to update the UI
                            this.$nextTick(() => {
                                console.log('üîÑ Alpine.js UI updated, onlineChats length:', this.onlineChats.length);
                            });
                            this.updateUnreadCount();
                            
                            // Auto-select first new consultation if no chat is currently selected
                            if (!this.selectedChat && newConsultations.length > 0) {
                                this.selectChat(newConsultations[0]);
                            }
                        } else {
                            console.error('Failed to load online consultations');
                        }
                    } catch (error) {
                        console.error('Error loading online consultations:', error);
                    } finally {
                        // Only apply minimum loading time if loading was shown
                        if (showLoading) {
                            const elapsedTime = Date.now() - startTime;
                            const remainingTime = Math.max(0, 2000 - elapsedTime);
                            
                            setTimeout(() => {
                                this.isLoadingConsultations = false;
                            }, remainingTime);
                        }
                    }
                },

                async loadStudents() {
                    try {
                        // Fetch ALL patients from database (students, staff, visitors)
                        const response = await fetch('/api/all-patients');
                        if (response.ok) {
                            const patients = await response.json();
                            console.log('‚úÖ Loaded all patients:', patients.length);
                            this.availableStudents = patients.map(patient => ({
                                id: patient.id,
                                name: patient.name,
                                studentId: patient.identifier || patient.id,
                                course: patient.department || patient.role || 'N/A',
                                role: patient.role,
                                online: Math.random() > 0.5, // Random online status for demo
                                hasUnread: false
                            }));
                            console.log('‚úÖ Available patients for consultation:', this.availableStudents.length);
                        } else {
                            console.error('‚ùå Failed to load patients');
                        }
                    } catch (error) {
                        console.error('‚ùå Error loading patients:', error);
                    }
                },

                getSampleStudents() {
                    return [
                        { studentId: 'ST-2024-001', name: 'Maria Santos', course: 'BSIT', year: '3rd Year', online: true },
                        { studentId: 'ST-2024-002', name: 'Juan Dela Cruz', course: 'BSCS', year: '2nd Year', online: false },
                        { studentId: 'ST-2024-003', name: 'Ana Garcia', course: 'BSBA', year: '4th Year', online: true }
                    ];
                },

                initializeSampleData() {
                    // Only 3 students with active chats - realistic clinic scenario
                    this.students = [
                        { studentId: 'ST-2024-001', name: 'Maria Santos', course: 'BSIT', year: '3rd Year', online: true },
                        { studentId: 'ST-2024-002', name: 'Juan Dela Cruz', course: 'BSCS', year: '2nd Year', online: false },
                        { studentId: 'ST-2024-003', name: 'Ana Garcia', course: 'BSBA', year: '4th Year', online: true }
                    ];

                    // Initialize active chats for these students
                    this.onlineChats = [
                        {
                            id: 1,
                            patient: 'Maria Santos',
                            studentId: 'ST-2024-001',
                            online: true,
                            lastMessage: 'Thank you for the prescription!',
                            lastMessageTime: '2:30 PM',
                            unreadCount: 2,
                            messages: [
                                { id: 1, sender: 'system', text: 'Chat started with Maria Santos', time: '2:15 PM' },
                                { id: 2, sender: 'student', text: 'Hi nurse, I have a headache and fever', time: '2:16 PM' },
                                { id: 3, sender: 'nurse', text: 'Hello Maria! How long have you been experiencing these symptoms?', time: '2:17 PM' },
                                { id: 4, sender: 'student', text: 'Since yesterday morning', time: '2:18 PM' },
                                { id: 5, sender: 'nurse', text: 'I recommend taking paracetamol and getting some rest. Please come to the clinic if symptoms worsen.', time: '2:25 PM' },
                                { id: 6, sender: 'student', text: 'Thank you for the prescription!', time: '2:30 PM' }
                            ]
                        },
                        {
                            id: 2,
                            patient: 'Juan Dela Cruz',
                            studentId: 'ST-2024-002',
                            online: false,
                            lastMessage: 'Okay, I\'ll be there at 3 PM',
                            lastMessageTime: '1:45 PM',
                            unreadCount: 0,
                            messages: [
                                { id: 1, sender: 'system', text: 'Chat started with Juan Dela Cruz', time: '1:30 PM' },
                                { id: 2, sender: 'student', text: 'Good afternoon, I need to get my medical clearance', time: '1:32 PM' },
                                { id: 3, sender: 'nurse', text: 'Hello Juan! Please come to the clinic with your ID and requirements', time: '1:35 PM' },
                                { id: 4, sender: 'student', text: 'What time is the clinic open?', time: '1:40 PM' },
                                { id: 5, sender: 'nurse', text: 'We\'re open until 5 PM today. You can come anytime before 4 PM', time: '1:42 PM' },
                                { id: 6, sender: 'student', text: 'Okay, I\'ll be there at 3 PM', time: '1:45 PM' }
                            ]
                        },
                        {
                            id: 3,
                            patient: 'Ana Garcia',
                            studentId: 'ST-2024-003',
                            online: true,
                            lastMessage: 'I\'ll send the lab results now',
                            lastMessageTime: '12:20 PM',
                            unreadCount: 1,
                            messages: [
                                { id: 1, sender: 'system', text: 'Chat started with Ana Garcia', time: '12:00 PM' },
                                { id: 2, sender: 'student', text: 'Hi! I have my lab results ready', time: '12:05 PM' },
                                { id: 3, sender: 'nurse', text: 'Great! Please send them so I can review', time: '12:10 PM' },
                                { id: 4, sender: 'student', text: 'I\'ll send the lab results now', time: '12:20 PM' }
                            ]
                        }
                    ];

                    // Sample chat files
                    this.chatFiles = [
                        { id: 1, name: 'Lab_Results_Ana.pdf', size: '245 KB', date: 'Dec 13, 2024' },
                        { id: 2, name: 'Medical_Certificate.pdf', size: '180 KB', date: 'Dec 12, 2024' }
                    ];

                    // Sample media files
                    this.chatMedia = [
                        { id: 1, name: 'Prescription_Photo.jpg', thumbnail: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iIzMzNzNkYyIvPjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+UHJlc2NyaXB0aW9uPC90ZXh0Pjwvc3ZnPg==' },
                        { id: 2, name: 'Xray_Result.jpg', thumbnail: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iIzEwYjk4MSIvPjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+WC1SYXk8L3RleHQ+PC9zdmc+' }
                    ];

                    // Sample pinned messages
                    this.pinnedMessages = [
                        { id: 1, text: 'Maria: Please bring your medical records tomorrow for follow-up', date: 'Dec 13, 2024' },
                        { id: 2, text: 'Juan: Medical clearance requirements - ID, 2x2 photo, health form', date: 'Dec 12, 2024' }
                    ];
                },

                startChat(student) {
                    // Create or find existing chat
                    let existingChat = this.onlineChats.find(chat => chat.studentId === student.studentId);
                    
                    if (!existingChat) {
                        // Create new chat
                        existingChat = {
                            id: Date.now(),
                            patient: student.name,
                            studentId: student.studentId,
                            online: student.online,
                            messages: [
                                {
                                    id: 1,
                                    sender: 'system',
                                    text: `Chat started with ${student.name}`,
                                    time: new Date().toLocaleTimeString('en-US', {hour: 'numeric', minute:'2-digit', hour12: true})
                                }
                            ]
                        };
                        this.onlineChats.push(existingChat);
                    }
                    
                    this.selectedChat = existingChat;
                },

                async sendMessage() {
                    if (!this.newMessage.trim() || !this.selectedChat) {
                        console.warn('‚ö†Ô∏è Cannot send empty message or no chat selected');
                        return;
                    }
                    
                    const messageText = this.newMessage.trim();
                    const consultationId = this.selectedChat.id;
                    
                    console.log('üì§ Sending message:', messageText);
                    
                    // Clear input immediately for better UX
                    this.newMessage = '';
                    
                    // Update activity timestamp to prevent polling during send
                    this.lastMessageTime = Date.now();
                    
                    try {
                        const response = await fetch(`/api/online-consultations/${consultationId}/send-message`, {
                            method: 'POST',
                            credentials: 'same-origin',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                message: messageText,
                                sender_type: 'staff'
                            })
                        });
                        
                        if (response.ok) {
                            console.log('‚úÖ Message sent successfully');
                            
                            // Add message to local state immediately for instant feedback
                            const localMessage = {
                                id: `local_${Date.now()}`,
                                sender: 'doctor',
                                text: messageText,
                                time: new Date().toLocaleTimeString('en-US', {hour: 'numeric', minute:'2-digit', hour12: true}),
                                type: 'text',
                                fromDatabase: false // Mark as local message
                            };
                            
                            this.selectedChat.messages.push(localMessage);
                            this.selectedChat.lastMessage = messageText;
                            this.selectedChat.lastMessageTime = 'Just now';
                            
                            // Auto-scroll to bottom
                            this.$nextTick(() => {
                                const container = this.$refs.messagesContainer;
                                if (container) {
                                    container.scrollTop = container.scrollHeight;
                                }
                            });
                            
                            // Reload messages after a short delay to sync with database
                            setTimeout(() => {
                                this.loadMessages(consultationId);
                            }, 1000);
                        } else {
                            const errorText = await response.text();
                            console.error('‚ùå Failed to send message:', response.status, errorText);
                            this.showAlert('Failed to send message. Please try again.', 'error');
                            // Restore the message text if sending failed
                            this.newMessage = messageText;
                        }
                    } catch (error) {
                        console.error('‚ùå Error sending message:', error);
                        this.showAlert('Error sending message. Please check your connection.', 'error');
                        // Restore the message text if sending failed
                        this.newMessage = messageText;
                    }
                },

                handleFileUpload(event) {
                    const file = event.target.files[0];
                    if (!file || !this.selectedChat) return;
                    
                    const message = {
                        id: Date.now(),
                        sender: 'doctor',
                        text: 'Shared a file',
                        time: new Date().toLocaleTimeString('en-US', {hour: 'numeric', minute:'2-digit', hour12: true}),
                        type: 'file',
                        fileName: file.name,
                        fileSize: this.formatFileSize(file.size)
                    };
                    
                    this.selectedChat.messages.push(message);
                    
                    // Add to chat files
                    this.chatFiles.unshift({
                        id: Date.now(),
                        name: file.name,
                        date: 'Just now',
                        size: this.formatFileSize(file.size)
                    });
                    
                    this.showFileUpload = false;
                    event.target.value = '';
                },

                formatFileSize(bytes) {
                    if (bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                },

                autoResize(event) {
                    const textarea = event.target;
                    textarea.style.height = 'auto';
                    textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
                },

                saveNotes() {
                    if (!this.consultationNotes.trim()) return;
                    
                    // Here you would typically save to database
                    this.showAlert('Consultation notes saved successfully!', 'success');
                },

                unpinMessage(messageId) {
                    this.pinnedMessages = this.pinnedMessages.filter(msg => msg.id !== messageId);
                },


                async loadMedicalRecords() {
                    try {
                        console.log('üîç Loading medical records from API...');
                        // Fetch all medical records from database (using test endpoint temporarily)
                        const response = await fetch('/api/test-all-medical-records');
                        console.log('üì° API Response status:', response.status);
                        
                        if (response.ok) {
                            const records = await response.json();
                            console.log('‚úÖ Loaded medical records:', records.length, 'records');
                            console.log('üìã First record sample:', records[0]);
                            
                            // üîî Check for new records (real-time detection)
                            const previousCount = this.consultations.length;
                            const newCount = records.length;
                            
                            if (previousCount > 0 && newCount > previousCount) {
                                const newRecordsCount = newCount - previousCount;
                                console.log(`üÜï NEW MEDICAL RECORDS DETECTED: ${newRecordsCount} new record(s)!`);
                                
                                // Show notification
                                this.showNotification(`${newRecordsCount} new medical record(s) added!`, 'success');
                                
                                // Play notification sound if available
                                this.playNotificationSound();
                            }
                            
                            // Transform medical records to consultation format - only essential data
                            this.consultations = records.map(record => ({
                                id: `${record.patient_role.replace(/\s+/g, '_')}_${record.id}`, // Unique ID: Role_ID
                                originalId: record.id, // Keep original ID for reference
                                patient: record.patient_name || 'Unknown Patient',
                                patientId: record.patient_id ? `STU-${record.patient_id}` : 'N/A',
                                role: record.patient_role || 'Student',
                                date: this.formatDate(record.visit_date),
                                time: this.formatTimeOnly(record.visit_time), // Don't add || 'N/A' here, let formatTime handle it
                                type: this.determineConsultationType(record.chief_complaint || record.symptoms),
                                status: 'Completed',
                                doctor: record.staff_name || 'Unknown Doctor',
                                // Store full details for view modal
                                fullDetails: {
                                    symptoms: record.chief_complaint || record.symptoms,
                                    diagnosis: record.treatment, // Use treatment as diagnosis for now
                                    treatment: record.treatment,
                                    prescribed_medicine: record.prescribed_medicine,
                                    notes: record.notes,
                                    visit_date: record.visit_date,
                                    visit_time: record.visit_time,
                                    created_at: record.created_at,
                                    // Additional medical details
                                    medical_history: record.medical_history,
                                    vital_signs: {
                                        blood_pressure: record.blood_pressure_systolic && record.blood_pressure_diastolic ? 
                                            `${record.blood_pressure_systolic}/${record.blood_pressure_diastolic}` : 'N/A',
                                        pulse_rate: record.pulse_rate || 'N/A',
                                        temperature: record.temperature || 'N/A',
                                        weight: record.weight || 'N/A',
                                        height: record.height || 'N/A'
                                    }
                                }
                            }));
                            
                            console.log('üéØ Transformed consultations:', this.consultations.length, 'items');
                            console.log('üìä Sample consultation:', this.consultations[0]);
                        } else {
                            const errorText = await response.text();
                            console.error('‚ùå Failed to load medical records:', response.status, errorText);
                            
                            if (response.status === 401) {
                                console.warn('üîê Authentication required - redirecting to login');
                                this.showAlert('Session expired. Please login again.', 'warning', 'Session Expired');
                                setTimeout(() => { window.location.href = '/login'; }, 2000);
                                return;
                            }
                            
                            // Add fallback sample data for testing
                            console.log('üîß Adding sample consultation data for testing...');
                            this.consultations = [
                                {
                                    id: 'sample-1',
                                    patient: 'Sample Patient',
                                    patientId: 'STU-001',
                                    date: this.formatDate(new Date()),
                                    time: this.formatTime(new Date()),
                                    type: 'General Consultation',
                                    status: 'Completed',
                                    doctor: 'Sample Doctor',
                                    fullDetails: {
                                        symptoms: 'Sample symptoms for testing',
                                        diagnosis: 'Sample diagnosis',
                                        treatment: 'Sample treatment',
                                        prescribed_medicine: 'Sample medicine',
                                        notes: 'Sample notes',
                                        visit_date: new Date().toISOString().split('T')[0],
                                        visit_time: new Date().toTimeString().split(' ')[0],
                                        created_at: new Date().toISOString()
                                    }
                                }
                            ];
                        }
                    } catch (error) {
                        console.error('üí• Error loading medical records:', error);
                        
                        if (error.message && error.message.includes('401')) {
                            console.warn('üîê Authentication error - redirecting to login');
                            this.showAlert('Please login to access consultations.', 'warning', 'Authentication Required');
                            setTimeout(() => { window.location.href = '/login'; }, 2000);
                            return;
                        }
                        
                        // Add fallback sample data for testing
                        console.log('üîß Adding sample consultation data due to error...');
                        this.consultations = [
                            {
                                id: 'error-sample-1',
                                patient: 'Error Test Patient',
                                patientId: 'STU-ERROR',
                                date: this.formatDate(new Date()),
                                time: this.formatTime(new Date()),
                                type: 'Error Test Consultation',
                                status: 'Completed',
                                doctor: 'Error Test Doctor',
                                fullDetails: {
                                    symptoms: 'Error test symptoms',
                                    diagnosis: 'Error test diagnosis',
                                    treatment: 'Error test treatment',
                                    prescribed_medicine: 'Error test medicine',
                                    notes: 'Error test notes',
                                    visit_date: new Date().toISOString().split('T')[0],
                                    visit_time: new Date().toTimeString().split(' ')[0],
                                    created_at: new Date().toISOString()
                                }
                            }
                        ];
                    }
                },

                formatDate(dateString) {
                    if (!dateString) return 'N/A';
                    const date = new Date(dateString);
                    return date.toLocaleDateString('en-US', { 
                        month: 'short', 
                        day: 'numeric', 
                        year: 'numeric' 
                    });
                },
                formatTimeOnly(timeString) {
                    if (!timeString) return null; // Return null instead of 'N/A' so formatTime can handle it
                    
                    // Convert to string if not already
                    const timeStr = String(timeString);
                    
                    // Handle time strings like "10:30:00" or "10:30"
                    if (timeStr.includes(':')) {
                        const timeParts = timeStr.split(':');
                        if (timeParts.length >= 2) {
                            // Return HH:MM format (24-hour)
                            return `${timeParts[0].padStart(2, '0')}:${timeParts[1].padStart(2, '0')}`;
                        }
                    }
                    
                    return null; // Return null if invalid format
                },
                
                determineConsultationType(symptoms) {
                    if (!symptoms) return 'General';
                    
                    const symptomText = symptoms.toLowerCase();
                    if (symptomText.includes('emergency') || symptomText.includes('urgent') || 
                        symptomText.includes('chest pain') || symptomText.includes('difficulty breathing')) {
                        return 'Emergency';
                    } else if (symptomText.includes('follow') || symptomText.includes('check')) {
                        return 'Follow-up';
                    } else if (symptomText.includes('online') || symptomText.includes('chat')) {
                        return 'Online';
                    }
                    return 'General';
                },
                
                exportConsultations() {
                    const csvContent = this.generateConsultationsReport();
                    const blob = new Blob([csvContent], { type: 'text/plain' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `consultations-report-${new Date().toISOString().split('T')[0]}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                },
                
                generateConsultationsReport() {
                    let report = 'CONSULTATIONS REPORT\n';
                    report += '='.repeat(50) + '\n';
                    report += `Generated on: ${new Date().toLocaleDateString()}\n\n`;
                    
                    report += 'CONSULTATIONS SUMMARY:\n';
                    report += `-`.repeat(20) + '\n';
                    report += `Active Today: ${this.activeConsultations}\n`;
                    report += `Completed Today: ${this.completedConsultations}\n`;
                    report += `Pending: ${this.pendingConsultations}\n`;
                    report += `Online Chats: ${this.onlineChats.length}\n\n`;
                    
                    report += 'DETAILED CONSULTATIONS:\n';
                    report += `-`.repeat(20) + '\n';
                    
                    this.consultations.forEach(consultation => {
                        report += `Patient: ${consultation.patient} (${consultation.patientId})\n`;
                        report += `Date: ${consultation.date} at ${consultation.time}\n`;
                        report += `Type: ${consultation.type}\n`;
                        report += `Status: ${consultation.status}\n`;
                        report += `Doctor: ${consultation.doctor}\n`;
                        report += `Notes: ${consultation.notes}\n`;
                        report += '-'.repeat(30) + '\n';
                    });
                    
                    return report;
                },
                
                // Chat methods
                async selectChat(chat) {
                    console.log('üéØ Selecting chat:', chat.id, chat.patient);
                    
                    // Clear any existing polling interval
                    if (this.messagePollingInterval) {
                        clearInterval(this.messagePollingInterval);
                        this.messagePollingInterval = null;
                    }
                    
                    this.selectedChat = chat;
                    
                    // Mark messages as read in database
                    try {
                        const response = await fetch(`/api/online-consultations/${chat.id}/mark-read`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            console.log(`‚úÖ Marked ${result.marked_count} messages as read`);
                            
                            // Update UI immediately
                            chat.unreadCount = 0;
                            this.updateUnreadCount();
                        }
                    } catch (error) {
                        console.error('Error marking messages as read:', error);
                    }
                    
                    // Load real messages from database
                    await this.loadMessages(chat.id);
                    
                    // Start polling for new messages
                    this.startMessagePolling(chat.id);
                    
                    // Scroll to bottom of messages
                    this.$nextTick(() => {
                        const container = this.$refs.messagesContainer;
                        if (container) {
                            container.scrollTop = container.scrollHeight;
                        }
                    });
                },
                
                startMessagePolling(consultationId) {
                    console.log('üîÑ Starting message polling for consultation:', consultationId);
                    
                    // Clear any existing polling
                    if (this.messagePollingInterval) {
                        clearInterval(this.messagePollingInterval);
                    }
                    
                    // Poll for new messages every 3 seconds for real-time chat experience
                    this.messagePollingInterval = setInterval(async () => {
                        if (this.selectedChat && this.selectedChat.id === consultationId) {
                            // Only load messages if we don't have any recent activity
                            const lastActivity = this.lastMessageTime || 0;
                            const now = Date.now();
                            if (now - lastActivity > 2000) { // Only poll if no activity in last 2 seconds
                                await this.loadMessages(consultationId);
                            }
                        } else {
                            // Stop polling if chat is no longer selected
                            clearInterval(this.messagePollingInterval);
                            this.messagePollingInterval = null;
                        }
                    }, 3000);
                },
                
                async loadMessages(consultationId) {
                    try {
                        const response = await fetch(`/api/online-consultations/${consultationId}/messages`, {
                            credentials: 'same-origin'
                        });
                        
                        if (response.status === 401) {
                            console.warn('üîê Session expired, redirecting to login');
                            window.location.href = '/login';
                            return;
                        }
                        
                        if (response.ok) {
                            const messages = await response.json();
                            console.log(`üì® Loaded ${messages.length} messages for consultation ${consultationId}`);
                            
                            if (!this.selectedChat || this.selectedChat.id !== consultationId) {
                                return; // Chat was changed, don't update
                            }
                            
                            // Convert API messages to frontend format
                            const dbMessages = messages.map(msg => ({
                                id: `db_${msg.id}`, // Prefix to identify database messages
                                originalId: msg.id,
                                sender: msg.sender_type === 'patient' ? 'patient' : 'doctor',
                                text: msg.message || msg.text || 'No message content',
                                time: new Date(msg.sent_at || msg.created_at).toLocaleTimeString('en-US', { 
                                    hour: 'numeric', 
                                    minute: '2-digit',
                                    hour12: true 
                                }),
                                fromDatabase: true
                            }));
                            
                            // Get existing local messages (not from database)
                            const existingMessages = this.selectedChat.messages || [];
                            const localMessages = existingMessages.filter(msg => !msg.fromDatabase);
                            
                            // Combine database messages with local messages
                            const allMessages = [...dbMessages, ...localMessages];
                            
                            // Remove duplicates based on text and sender
                            const uniqueMessages = [];
                            const seen = new Set();
                            
                            allMessages.forEach(msg => {
                                const key = `${msg.sender}_${msg.text}`;
                                if (!seen.has(key)) {
                                    seen.add(key);
                                    uniqueMessages.push(msg);
                                }
                            });
                            
                            // Sort by time
                            uniqueMessages.sort((a, b) => {
                                const timeA = a.time || '00:00';
                                const timeB = b.time || '00:00';
                                return timeA.localeCompare(timeB);
                            });
                            
                            // Only update if message count changed to prevent unnecessary re-renders
                            if (this.selectedChat.messages.length !== uniqueMessages.length) {
                                this.selectedChat.messages = uniqueMessages;
                                
                                // Auto-scroll to bottom only if new messages arrived
                                this.$nextTick(() => {
                                    const container = this.$refs.messagesContainer;
                                    if (container) {
                                        const isScrolledToBottom = container.scrollHeight - container.clientHeight <= container.scrollTop + 100;
                                        if (isScrolledToBottom) {
                                            container.scrollTop = container.scrollHeight;
                                        }
                                    }
                                });
                            }
                            
                            console.log('‚úÖ Messages updated:', uniqueMessages.length, 'total messages');
                        } else {
                            console.error('‚ùå Failed to load messages:', response.status);
                        }
                    } catch (error) {
                        console.error('‚ùå Error loading messages:', error);
                    }
                },
                
                async loadChatMessages(consultationId) {
                    try {
                        const response = await fetch(`/api/online-consultations/${consultationId}/messages`);
                        if (response.status === 401) {
                            console.warn('Session expired, redirecting to login');
                            window.location.href = '/login';
                            return;
                        }
                        if (response.ok) {
                            const messages = await response.json();
                            console.log('Loaded messages with sender_type:', messages); // Debug log
                            if (this.selectedChat) {
                                // Transform messages from API
                                const transformedMessages = messages.map(msg => {
                                    // Fix sender mapping based on sender_type from database
                                    let sender;
                                    if (msg.sender_type === 'patient') {
                                        sender = 'patient';
                                    } else if (msg.sender_type === 'staff') {
                                        sender = 'doctor';
                                    } else {
                                        // Fallback for legacy data
                                        sender = msg.sender === 'patient' ? 'patient' : 'doctor';
                                    }
                                    
                                    console.log(`Message ${msg.id}: sender_type=${msg.sender_type}, mapped to=${sender}`); // Debug log
                                    
                                    return {
                                        id: msg.id,
                                        sender: sender,
                                        text: msg.text || msg.message || 'No message content',
                                        time: msg.time || this.formatTime(msg.created_at),
                                        type: msg.type || 'text',
                                        fromDatabase: true // Mark as from database
                                    };
                                });
                                
                                // Only update if we have different message count or if this is initial load
                                const currentDbMessages = this.selectedChat.messages.filter(m => m.fromDatabase);
                                if (currentDbMessages.length !== transformedMessages.length || !this.selectedChat.messages.length) {
                                    // Keep local messages (not from database) and merge with database messages
                                    const localMessages = this.selectedChat.messages.filter(m => !m.fromDatabase);
                                    this.selectedChat.messages = [...transformedMessages, ...localMessages];
                                    
                                    // Sort by time to maintain order
                                    this.selectedChat.messages.sort((a, b) => {
                                        const timeA = a.time || '00:00';
                                        const timeB = b.time || '00:00';
                                        return timeA.localeCompare(timeB);
                                    });
                                }
                            }
                            
                            // Auto-scroll to bottom
                            this.$nextTick(() => {
                                if (this.$refs.messagesContainer) {
                                    this.$refs.messagesContainer.scrollTop = this.$refs.messagesContainer.scrollHeight;
                                }
                            });
                        } else {
                            console.error('Failed to load chat messages');
                        }
                    } catch (error) {
                        console.error('Error loading chat messages:', error);
                    }
                },

                // Modal helper functions
                showModal(options) {
                    this.modal = {
                        show: true,
                        type: options.type || 'info',
                        title: options.title || 'Notification',
                        message: options.message || '',
                        confirmText: options.confirmText || 'OK',
                        cancelText: options.cancelText || 'Cancel',
                        showCancel: options.showCancel || false,
                        onConfirm: options.onConfirm || (() => {}),
                        onCancel: options.onCancel || (() => {})
                    };
                },
                
                showAlert(message, type = 'info', title = null) {
                    const titles = {
                        success: 'Success',
                        error: 'Error',
                        warning: 'Warning',
                        info: 'Information'
                    };
                    
                    this.showModal({
                        type: type,
                        title: title || titles[type],
                        message: message,
                        confirmText: 'OK',
                        showCancel: false
                    });
                },
                
                showConfirm(message, onConfirm, type = 'warning', title = 'Confirm Action') {
                    this.showModal({
                        type: type,
                        title: title,
                        message: message,
                        confirmText: 'Confirm',
                        cancelText: 'Cancel',
                        showCancel: true,
                        onConfirm: onConfirm,
                        onCancel: () => {}
                    });
                },
                
                formatTimeAgo(dateString) {
                    if (!dateString) return 'Just now';
                    
                    try {
                        const now = new Date();
                        const date = new Date(dateString);
                        
                        // Check if date is valid
                        if (isNaN(date.getTime())) {
                            return 'Just now';
                        }
                        
                        const diffInMinutes = Math.floor((now - date) / (1000 * 60));
                        
                        if (diffInMinutes < 1) return 'Just now';
                        if (diffInMinutes < 60) return `${diffInMinutes}m ago`;
                        
                        const diffInHours = Math.floor(diffInMinutes / 60);
                        if (diffInHours < 24) return `${diffInHours}h ago`;
                        
                        const diffInDays = Math.floor(diffInHours / 24);
                        if (diffInDays < 7) return `${diffInDays}d ago`;
                        
                        return date.toLocaleDateString();
                    } catch (error) {
                        console.error('Error formatting date:', error);
                        return 'Just now';
                    }
                },
                
                // Delete chat confirmation
                confirmDeleteChat(chat) {
                    if (!chat) return;
                    
                    this.showConfirm(
                        `Are you sure you want to delete the chat history with ${chat.patient}?\n\n` +
                        `This will permanently delete all messages and end the consultation.\n\n` +
                        `This action cannot be undone.`,
                        () => this.deleteChat(chat),
                        'error',
                        'Delete Chat History'
                    );
                },
                
                // Delete chat function
                async deleteChat(chat) {
                    if (!chat || !chat.id) return;
                    
                    try {
                        console.log(`üóëÔ∏è Deleting chat for ${chat.patient} (ID: ${chat.id})`);
                        
                        const response = await fetch(`/api/online-consultations/${chat.id}`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            console.log('‚úÖ Chat deleted successfully:', result);
                            
                            // Remove from onlineChats array
                            this.onlineChats = this.onlineChats.filter(c => c.id !== chat.id);
                            
                            // Clear selected chat if it was the deleted one
                            if (this.selectedChat && this.selectedChat.id === chat.id) {
                                this.selectedChat = null;
                            }
                            
                            // Show success notification
                            this.showNotification(`Chat with ${chat.patient} has been deleted`, 'success');
                            
                            // Update unread count
                            this.updateUnreadCount();
                        } else {
                            const error = await response.json();
                            console.error('‚ùå Failed to delete chat:', error);
                            this.showNotification('Failed to delete chat. Please try again.', 'error');
                        }
                    } catch (error) {
                        console.error('‚ùå Error deleting chat:', error);
                        this.showNotification('An error occurred while deleting the chat.', 'error');
                    }
                },
                
                // Show notification helper
                showNotification(message, type = 'info') {
                    // Create a simple notification
                    const notification = document.createElement('div');
                    notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
                        type === 'success' ? 'bg-green-500' : 
                        type === 'error' ? 'bg-red-500' : 
                        'bg-blue-500'
                    } text-white font-medium`;
                    notification.textContent = message;
                    
                    document.body.appendChild(notification);
                    
                    // Remove after 3 seconds
                    setTimeout(() => {
                        notification.remove();
                    }, 3000);
                },
                
                updateUnreadCount() {
                    this.unreadCount = this.onlineChats.reduce((total, chat) => total + chat.unreadCount, 0);
                },
                
                startNewConsultationPolling() {
                    // Reduced frequency polling for new consultations
                    setInterval(() => {
                        this.checkForNewConsultations();
                    }, 10000); // Check every 10 seconds for new consultations (reduced from 2 seconds)
                },
                
                async checkForNewConsultations() {
                    try {
                        const response = await fetch('/api/online-consultations');
                        if (response.ok) {
                            const consultations = await response.json();
                            const currentIds = new Set(this.onlineChats.map(chat => chat.id));
                            const newConsultations = consultations.filter(c => !currentIds.has(c.id));
                            
                            if (newConsultations.length > 0) {
                                console.log('üîî New consultations detected:', newConsultations);
                                // Trigger full reload to get the new consultations
                                this.loadOnlineConsultations();
                            }
                        }
                    } catch (error) {
                        console.error('Error checking for new consultations:', error);
                    }
                },
                
                showNewConsultationNotification(newConsultations) {
                    // Removed automatic notifications to avoid false alerts on page refresh
                    // The unread badge system will handle new message notifications
                },
                
                showInAppNotification(message) {
                    // Create temporary notification element
                    const notification = document.createElement('div');
                    notification.className = 'fixed top-4 right-4 bg-blue-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-slide-in';
                    notification.innerHTML = `
                        <div class="flex items-center space-x-2">
                            <i data-feather="message-circle" class="w-5 h-5"></i>
                            <span>${message}</span>
                        </div>
                    `;
                    
                    document.body.appendChild(notification);
                    
                    // Replace feather icons
                    if (typeof feather !== 'undefined') {
                        feather.replace();
                    }
                    
                    // Remove after 5 seconds
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 5000);
                },
                
                playNotificationSound() {
                    // Simple notification sound using Web Audio API
                    // Only play if user has interacted with the page
                    if (!this.audioContext) {
                        return; // No audio context available
                    }
                    
                    try {
                        if (this.audioContext.state === 'suspended') {
                            return; // Don't try to play if context is suspended
                        }
                        
                        const oscillator = this.audioContext.createOscillator();
                        const gainNode = this.audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(this.audioContext.destination);
                        
                        oscillator.frequency.value = 800;
                        oscillator.type = 'sine';
                        
                        gainNode.gain.setValueAtTime(0.1, this.audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.5);
                        
                        oscillator.start(this.audioContext.currentTime);
                        oscillator.stop(this.audioContext.currentTime + 0.5);
                    } catch (error) {
                        console.debug('Could not play notification sound:', error);
                    }
                },
                
                requestNotificationPermission() {
                    if ('Notification' in window && Notification.permission === 'default') {
                        Notification.requestPermission();
                    }
                },
                
                initializeAudioContext() {
                    // Add event listeners for user interaction to initialize audio context
                    const initAudio = () => {
                        if (!this.audioContext && !this.userHasInteracted) {
                            try {
                                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                                this.userHasInteracted = true;
                                console.debug('Audio context initialized after user interaction');
                            } catch (error) {
                                console.debug('Could not initialize audio context:', error);
                            }
                        }
                    };
                    
                    // Listen for various user interaction events
                    ['click', 'keydown', 'touchstart'].forEach(event => {
                        document.addEventListener(event, initAudio, { once: true });
                    });
                },

                // View Consultation Function
                async viewConsultation(consultation) {
                    try {
                        // Show loading state
                        this.selectedConsultation = null;
                        this.showViewModal = true;
                        
                        // Use originalId (database ID) instead of prefixed id
                        const recordId = consultation.originalId || consultation.id;
                        
                        // Determine the correct endpoint based on patient type
                        const role = consultation.role;
                        const isVisitor = role === 'Visitor';
                        const isTeaching = role === 'Teaching Staff';
                        const isNonTeaching = role === 'Non-Teaching Staff';
                        const isDean = role === 'Dean';
                        const isPresident = role === 'President';
                        
                        let endpoint;
                        if (isVisitor) {
                            endpoint = `/api/visitor-medical-record/${recordId}`;
                        } else if (isTeaching) {
                            endpoint = `/api/teaching-medical-record/${recordId}`;
                        } else if (isNonTeaching) {
                            endpoint = `/api/non-teaching-medical-record/${recordId}`;
                        } else if (isDean) {
                            endpoint = `/api/dean-medical-record/${recordId}`;
                        } else if (isPresident) {
                            endpoint = `/api/president-medical-record/${recordId}`;
                        } else {
                            endpoint = `/api/medical-record/${recordId}`;
                        }
                        
                        console.log(`üîç Viewing ${role} consultation #${recordId} using: ${endpoint}`);
                        
                        // Fetch complete consultation details from database
                        const response = await fetch(endpoint);
                        if (response.ok) {
                            const fullRecord = await response.json();
                            
                            // Map the complete record data - INCLUDE ALL FIELDS
                            this.selectedConsultation = {
                                id: fullRecord.id,
                                patient: consultation.patient || consultation.patient_name || fullRecord.patient_name || 'Unknown Patient',
                                patient_name: consultation.patient_name || consultation.patient || fullRecord.patient_name,
                                role: consultation.role,
                                visit_date: fullRecord.visit_date,
                                visit_time: fullRecord.visit_time,
                                date: consultation.date,
                                time: consultation.time,
                                fullDetails: {
                                    symptoms: fullRecord.chief_complaint || fullRecord.symptoms || '',
                                    diagnosis: fullRecord.diagnosis || '',
                                    treatment: fullRecord.treatment || '',
                                    prescribed_medicine: fullRecord.prescribed_medicine || ''
                                },
                                // Medical History fields
                                medical_history: fullRecord.medical_history || '',
                                fever_duration: fullRecord.fever_duration || '',
                                current_medication: fullRecord.current_medication || '',
                                medication_schedule: fullRecord.medication_schedule || '',
                                // Vital Signs
                                blood_pressure: fullRecord.blood_pressure || '',
                                blood_pressure_systolic: fullRecord.blood_pressure_systolic || '',
                                blood_pressure_diastolic: fullRecord.blood_pressure_diastolic || '',
                                pulse_rate: fullRecord.pulse_rate || '',
                                temperature: fullRecord.temperature || '',
                                respiratory_rate: fullRecord.respiratory_rate || '',
                                heart_rate: fullRecord.heart_rate || fullRecord.pulse_rate || '',
                                // Physical Measurements
                                weight: fullRecord.weight || '',
                                height: fullRecord.height || '',
                                bmi: fullRecord.bmi || '',
                                // Procedures
                                dental_procedure: fullRecord.dental_procedure || '',
                                procedure_notes: fullRecord.procedure_notes || '',
                                follow_up_date: fullRecord.follow_up_date || '',
                                special_instructions: fullRecord.special_instructions || '',
                                notes: fullRecord.notes || '',
                                doctor_name: fullRecord.doctor_name || 'Unknown Doctor',
                                staff_name: fullRecord.staff_name || fullRecord.doctor_name || '',
                                created_at: fullRecord.created_at || '',
                                updated_at: fullRecord.updated_at || '',
                                admission_time: fullRecord.admission_time || '',
                                discharge_time: fullRecord.discharge_time || '',
                                // Clinic stay information
                                will_stay_in_clinic: fullRecord.will_stay_in_clinic || false,
                                stay_reason: fullRecord.stay_reason || '',
                                stay_status: fullRecord.stay_status || 'not_staying'
                            };
                        } else {
                            // Fallback to basic consultation data if API fails
                            this.selectedConsultation = consultation;
                            console.warn('Failed to fetch complete consultation details, using basic data');
                        }
                        
                        // Initialize Feather icons after modal content is loaded
                        this.$nextTick(() => {
                            if (typeof feather !== 'undefined') {
                                try {
                                    feather.replace();
                                    console.log('‚úÖ Feather icons initialized for view modal');
                                } catch (error) {
                                    console.warn('Feather icons initialization warning:', error);
                                }
                            }
                        });
                    } catch (error) {
                        console.error('Error fetching consultation details:', error);
                        // Fallback to basic consultation data
                        this.selectedConsultation = consultation;
                        
                        // Initialize Feather icons even on error
                        this.$nextTick(() => {
                            if (typeof feather !== 'undefined') {
                                try {
                                    feather.replace();
                                } catch (error) {
                                    console.warn('Feather icons initialization warning:', error);
                                }
                            }
                        });
                    }
                },

                // Delete Consultation Function
                deleteConsultation(consultation) {
                    this.selectedConsultation = consultation;
                    this.showDeleteModal = true;
                },

                // Confirm Delete Function
                async confirmDelete() {
                    if (!this.selectedConsultation) return;
                    
                    try {
                        // Use originalId (database ID) instead of prefixed id
                        const recordId = this.selectedConsultation.originalId || this.selectedConsultation.id;
                        
                        // Determine the correct delete endpoint based on patient type/role
                        const patientRole = this.selectedConsultation.role || 'Student';
                        let endpoint;
                        
                        // Map patient roles to their respective delete endpoints
                        switch(patientRole) {
                            case 'Visitor':
                                endpoint = `/api/delete-visitor-medical-record/${recordId}`;
                                break;
                            case 'Teaching Staff':
                                endpoint = `/api/delete-teaching-medical-record/${recordId}`;
                                break;
                            case 'Non-Teaching Staff':
                                endpoint = `/api/delete-non-teaching-medical-record/${recordId}`;
                                break;
                            case 'Dean':
                                endpoint = `/api/delete-dean-medical-record/${recordId}`;
                                break;
                            case 'President':
                                endpoint = `/api/delete-president-medical-record/${recordId}`;
                                break;
                            case 'Student':
                            default:
                                endpoint = `/api/delete-medical-record/${recordId}`;
                                break;
                        }
                        
                        console.log(`üóëÔ∏è Deleting ${patientRole} consultation #${recordId} using: ${endpoint}`);
                        
                        const response = await fetch(endpoint, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json',
                            }
                        });

                        if (response.ok) {
                            // Remove the consultation from the local array
                            this.consultations = this.consultations.filter(
                                c => c.id !== this.selectedConsultation.id
                            );
                            
                            // Close modal and reset
                            this.showDeleteModal = false;
                            this.selectedConsultation = null;
                            
                            // Show success message
                            this.showSuccess(`${patientRole} consultation deleted successfully!`);
                            
                            // Reload medical records to refresh the list
                            await this.loadMedicalRecords();
                        } else {
                            const error = await response.json();
                            this.showError('Error deleting consultation: ' + (error.error || 'Unknown error'));
                        }
                    } catch (error) {
                        console.error('Error deleting consultation:', error);
                        this.showError('Error deleting consultation. Please try again.');
                    }
                },

                cancelDelete() {
                    this.showDeleteModal = false;
                    this.selectedConsultation = null;
                },

                // Update Consultation Function
                async updateConsultation() {
                    if (!this.selectedConsultation) return;

                    try {
                        // Here you would typically send the updated data to the API
                        // For now, we'll just update the local array
                        const index = this.consultations.findIndex(c => c.id === this.selectedConsultation.id);
                        if (index !== -1) {
                            this.consultations[index] = { ...this.selectedConsultation };
                        }

                        this.showEditModal = false;
                        this.selectedConsultation = null;
                        this.showNotification('Consultation updated successfully.', 'success');
                        
                        // Optionally reload medical records
                        await this.loadMedicalRecords();
                    } catch (error) {
                        console.error('Error updating consultation:', error);
                        this.showNotification('Error updating consultation. Please try again.', 'error');
                    }
                },

                showSuccess(message) {
                    // Create and show success notification
                    const notification = document.createElement('div');
                    notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300';
                    notification.innerHTML = `
                        <div class="flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            <span>${message}</span>
                        </div>
                    `;
                    document.body.appendChild(notification);
                    
                    // Animate in
                    setTimeout(() => notification.classList.remove('translate-x-full'), 100);
                    
                    // Remove after 3 seconds
                    setTimeout(() => {
                        notification.classList.add('translate-x-full');
                        setTimeout(() => document.body.removeChild(notification), 300);
                    }, 3000);
                },

                showError(message) {
                    // Create and show error notification
                    const notification = document.createElement('div');
                    notification.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300';
                    notification.innerHTML = `
                        <div class="flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            <span>${message}</span>
                        </div>
                    `;
                    document.body.appendChild(notification);
                    
                    // Animate in
                    setTimeout(() => notification.classList.remove('translate-x-full'), 100);
                    
                    // Remove after 3 seconds
                    setTimeout(() => {
                        notification.classList.add('translate-x-full');
                        setTimeout(() => document.body.removeChild(notification), 300);
                    }, 3000);
                },

                // Show Notification Function
                showNotification(message, type = 'info') {
                    const notification = document.createElement('div');
                    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transition-all duration-300 ${
                        type === 'success' ? 'bg-green-500 text-white' :
                        type === 'error' ? 'bg-red-500 text-white' :
                        'bg-blue-500 text-white'
                    }`;
                    notification.textContent = message;
                    
                    document.body.appendChild(notification);
                    
                    // Remove after 3 seconds
                    setTimeout(() => {
                        notification.remove();
                    }, 3000);
                }
            }
        }
    </script>

    <!-- View Consultation Modal -->
    <div x-show="showViewModal && selectedConsultation && !showEditModal" 
         x-transition:enter="transition ease-out duration-300" 
         x-transition:enter-start="opacity-0" 
         x-transition:enter-end="opacity-100" 
         x-transition:leave="transition ease-in duration-200" 
         x-transition:leave-start="opacity-100" 
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" 
         style="display: none;">
        <div x-show="showViewModal && selectedConsultation" 
             x-transition:enter="transition ease-out duration-300" 
             x-transition:enter-start="opacity-0 transform scale-95" 
             x-transition:enter-end="opacity-100 transform scale-100" 
             x-transition:leave="transition ease-in duration-200" 
             x-transition:leave-start="opacity-100 transform scale-100" 
             x-transition:leave-end="opacity-0 transform scale-95"
             class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6 rounded-t-xl">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold">Consultation Details</h3>
                            <p class="text-blue-100 text-sm" x-text="selectedConsultation ? (selectedConsultation.visit_date || selectedConsultation.date) : ''"></p>
                        </div>
                    </div>
                    <button @click="showViewModal = false; selectedConsultation = null;" 
                            class="text-white hover:text-blue-200 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Modal Content -->
            <template x-if="selectedConsultation">
                <div class="p-6 space-y-6">
                <!-- Medical Information Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Patient Information Card -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl p-4 md:col-span-2">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                            <h4 class="font-bold text-blue-900">Patient Information</h4>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-white rounded-lg p-3">
                                <p class="text-xs text-gray-600 mb-1">Patient Name</p>
                                <p class="font-semibold text-gray-900" x-text="selectedConsultation?.patient || selectedConsultation?.patient_name || 'Unknown Patient'"></p>
                            </div>
                            <div class="bg-white rounded-lg p-3">
                                <p class="text-xs text-gray-600 mb-1">Role</p>
                                <p class="font-semibold text-gray-900" x-text="selectedConsultation?.role || 'Student'"></p>
                            </div>
                            <div class="bg-white rounded-lg p-3">
                                <p class="text-xs text-gray-600 mb-1">Visit Date</p>
                                <p class="font-semibold text-gray-900" x-text="selectedConsultation?.date || selectedConsultation?.visit_date || 'N/A'"></p>
                            </div>
                            <div class="bg-white rounded-lg p-3">
                                <p class="text-xs text-gray-600 mb-1">Visit Time</p>
                                <p class="font-semibold text-gray-900" x-text="formatTime(selectedConsultation?.time || selectedConsultation?.visit_time)"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Reason for Visit / Chief Complaint -->
                    <div x-show="selectedConsultation && (selectedConsultation.fullDetails?.symptoms || selectedConsultation.symptoms || selectedConsultation.chief_complaint)" class="bg-white border border-gray-200 rounded-xl p-4 md:col-span-2">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center">
                                <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                            </div>
                            <h4 class="font-semibold text-gray-800">Chief Complaint</h4>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-3">
                            <p class="text-gray-800" x-text="selectedConsultation.fullDetails?.symptoms || selectedConsultation.symptoms || selectedConsultation.chief_complaint || 'Not specified'"></p>
                        </div>
                    </div>

                    <!-- Diagnosis -->
                    <div x-show="selectedConsultation && ((selectedConsultation.fullDetails?.diagnosis && typeof selectedConsultation.fullDetails.diagnosis === 'string' && selectedConsultation.fullDetails.diagnosis.trim() !== '' && selectedConsultation.fullDetails.diagnosis.toLowerCase() !== 'not specified' && selectedConsultation.fullDetails.diagnosis.length > 3) || (selectedConsultation.diagnosis && typeof selectedConsultation.diagnosis === 'string' && selectedConsultation.diagnosis.trim() !== '' && selectedConsultation.diagnosis.toLowerCase() !== 'not specified' && selectedConsultation.diagnosis.length > 3))" class="bg-white border border-gray-200 rounded-xl p-4">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-8 h-8 bg-indigo-100 rounded-lg flex items-center justify-center">
                                <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                                </svg>
                            </div>
                            <h4 class="font-semibold text-gray-800">Diagnosis</h4>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-3">
                            <p class="text-gray-800" x-text="selectedConsultation.fullDetails?.diagnosis || selectedConsultation.diagnosis"></p>
                        </div>
                    </div>

                    <!-- Treatment -->
                    <div x-show="selectedConsultation && ((selectedConsultation.fullDetails?.treatment && typeof selectedConsultation.fullDetails.treatment === 'string' && selectedConsultation.fullDetails.treatment.trim() !== '') || (selectedConsultation.treatment && typeof selectedConsultation.treatment === 'string' && selectedConsultation.treatment.trim() !== ''))" class="bg-white border border-gray-200 rounded-xl p-4">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                                <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                                </svg>
                            </div>
                            <h4 class="font-semibold text-gray-800">Treatment</h4>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-3">
                            <p class="text-gray-800" x-text="selectedConsultation.fullDetails?.treatment || selectedConsultation.treatment"></p>
                        </div>
                    </div>

                    <!-- Prescribed Medicine -->
                    <div x-show="selectedConsultation && ((selectedConsultation.fullDetails?.prescribed_medicine && typeof selectedConsultation.fullDetails.prescribed_medicine === 'string' && selectedConsultation.fullDetails.prescribed_medicine.trim() !== '' && selectedConsultation.fullDetails.prescribed_medicine.toLowerCase() !== 'no medicine prescribed') || (selectedConsultation.prescribed_medicine && typeof selectedConsultation.prescribed_medicine === 'string' && selectedConsultation.prescribed_medicine.trim() !== '' && selectedConsultation.prescribed_medicine.toLowerCase() !== 'no medicine prescribed'))" class="bg-white border border-gray-200 rounded-xl p-4">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                                <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                                </svg>
                            </div>
                            <h4 class="font-semibold text-gray-800">Prescribed Medicine</h4>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-3">
                            <p class="text-gray-800" x-text="selectedConsultation.fullDetails?.prescribed_medicine || selectedConsultation.prescribed_medicine"></p>
                        </div>
                    </div>

                    <!-- Vital Signs - Only show if at least one vital sign is filled -->
                    <div class="bg-white border border-gray-200 rounded-xl p-4 md:col-span-2" x-show="selectedConsultation && ((selectedConsultation.blood_pressure && selectedConsultation.blood_pressure.trim() !== '') || (selectedConsultation.temperature && selectedConsultation.temperature != 0 && selectedConsultation.temperature != '0.00') || (selectedConsultation.heart_rate && selectedConsultation.heart_rate != 0) || (selectedConsultation.pulse_rate && selectedConsultation.pulse_rate != 0) || (selectedConsultation.respiratory_rate && selectedConsultation.respiratory_rate != 0) || (selectedConsultation.weight && selectedConsultation.weight != 0 && selectedConsultation.weight != '0.00') || (selectedConsultation.height && selectedConsultation.height != 0))">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center">
                                <svg class="w-4 h-4 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                                </svg>
                            </div>
                            <h4 class="font-semibold text-gray-800">Vital Signs</h4>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div x-show="selectedConsultation && selectedConsultation.blood_pressure && selectedConsultation.blood_pressure.trim() !== ''" class="text-center p-3 bg-gray-50 rounded-lg">
                                <p class="text-xs text-gray-600 mb-1">Blood Pressure</p>
                                <p class="font-semibold text-gray-800" x-text="selectedConsultation.blood_pressure"></p>
                            </div>
                            <div x-show="selectedConsultation && selectedConsultation.temperature && selectedConsultation.temperature != 0 && selectedConsultation.temperature != '0.00'" class="text-center p-3 bg-gray-50 rounded-lg">
                                <p class="text-xs text-gray-600 mb-1">Temperature</p>
                                <p class="font-semibold text-gray-800" x-text="selectedConsultation.temperature + '¬∞C'"></p>
                            </div>
                            <div x-show="selectedConsultation && selectedConsultation.pulse_rate && selectedConsultation.pulse_rate != 0" class="text-center p-3 bg-gray-50 rounded-lg">
                                <p class="text-xs text-gray-600 mb-1">Pulse Rate</p>
                                <p class="font-semibold text-gray-800" x-text="selectedConsultation.pulse_rate + ' bpm'"></p>
                            </div>
                            <div x-show="selectedConsultation && selectedConsultation.heart_rate && selectedConsultation.heart_rate != 0" class="text-center p-3 bg-gray-50 rounded-lg">
                                <p class="text-xs text-gray-600 mb-1">Heart Rate</p>
                                <p class="font-semibold text-gray-800" x-text="selectedConsultation.heart_rate + ' bpm'"></p>
                            </div>
                            <div x-show="selectedConsultation && selectedConsultation.respiratory_rate && selectedConsultation.respiratory_rate != 0" class="text-center p-3 bg-gray-50 rounded-lg">
                                <p class="text-xs text-gray-600 mb-1">Respiratory Rate</p>
                                <p class="font-semibold text-gray-800" x-text="selectedConsultation.respiratory_rate + ' /min'"></p>
                            </div>
                            <div x-show="selectedConsultation && selectedConsultation.weight && selectedConsultation.weight != 0 && selectedConsultation.weight != '0.00'" class="text-center p-3 bg-gray-50 rounded-lg">
                                <p class="text-xs text-gray-600 mb-1">Weight</p>
                                <p class="font-semibold text-gray-800" x-text="selectedConsultation.weight + ' kg'"></p>
                            </div>
                            <div x-show="selectedConsultation && selectedConsultation.height && selectedConsultation.height != 0" class="text-center p-3 bg-gray-50 rounded-lg">
                                <p class="text-xs text-gray-600 mb-1">Height</p>
                                <p class="font-semibold text-gray-800" x-text="selectedConsultation.height + ' cm'"></p>
                            </div>
                            <div x-show="selectedConsultation && selectedConsultation.bmi && selectedConsultation.bmi != 0" class="text-center p-3 bg-gray-50 rounded-lg">
                                <p class="text-xs text-gray-600 mb-1">BMI</p>
                                <p class="font-semibold text-gray-800" x-text="selectedConsultation.bmi"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Medical History & Medication Section -->
                    <div x-show="selectedConsultation && ((selectedConsultation.medical_history && selectedConsultation.medical_history.trim() !== '' && selectedConsultation.medical_history.length > 3) || (selectedConsultation.fever_duration && selectedConsultation.fever_duration.trim() !== '' && selectedConsultation.fever_duration.length > 2) || (selectedConsultation.current_medication && selectedConsultation.current_medication.trim() !== '' && selectedConsultation.current_medication.length > 3) || (selectedConsultation.medication_schedule && selectedConsultation.medication_schedule.trim() !== '' && selectedConsultation.medication_schedule.length > 3))" class="bg-white border border-gray-200 rounded-xl p-4 md:col-span-2">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-8 h-8 bg-teal-100 rounded-lg flex items-center justify-center">
                                <svg class="w-4 h-4 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <h4 class="font-semibold text-gray-800">Medical History & Current Medication</h4>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div x-show="selectedConsultation.medical_history && selectedConsultation.medical_history.trim() !== '' && selectedConsultation.medical_history.length > 3" class="bg-gray-50 rounded-lg p-3">
                                <p class="text-xs text-gray-600 mb-2 font-semibold">Medical History</p>
                                <p class="text-gray-900 text-sm" x-text="selectedConsultation.medical_history"></p>
                            </div>
                            <div x-show="selectedConsultation.fever_duration && selectedConsultation.fever_duration.trim() !== '' && selectedConsultation.fever_duration.length > 2" class="bg-gray-50 rounded-lg p-3">
                                <p class="text-xs text-gray-600 mb-2 font-semibold">Fever Duration</p>
                                <p class="text-gray-900 text-sm" x-text="selectedConsultation.fever_duration"></p>
                            </div>
                            <div x-show="selectedConsultation.current_medication && selectedConsultation.current_medication.trim() !== '' && selectedConsultation.current_medication.length > 3" class="bg-gray-50 rounded-lg p-3">
                                <p class="text-xs text-gray-600 mb-2 font-semibold">Current Medication</p>
                                <p class="text-gray-900 text-sm" x-text="selectedConsultation.current_medication"></p>
                            </div>
                            <div x-show="selectedConsultation.medication_schedule && selectedConsultation.medication_schedule.trim() !== '' && selectedConsultation.medication_schedule.length > 3" class="bg-gray-50 rounded-lg p-3">
                                <p class="text-xs text-gray-600 mb-2 font-semibold">Medication Schedule</p>
                                <p class="text-gray-900 text-sm" x-text="selectedConsultation.medication_schedule"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Dental & Procedures Section -->
                    <div x-show="selectedConsultation && (selectedConsultation.dental_procedure || selectedConsultation.procedure_notes)" class="bg-white border border-gray-200 rounded-xl p-4 md:col-span-2">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-8 h-8 bg-pink-100 rounded-lg flex items-center justify-center">
                                <svg class="w-4 h-4 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <h4 class="font-semibold text-gray-800">Dental & Procedures</h4>
                        </div>
                        <div class="space-y-3">
                            <div x-show="selectedConsultation.dental_procedure && selectedConsultation.dental_procedure.trim() !== ''" class="bg-gray-50 rounded-lg p-3">
                                <p class="text-xs text-gray-600 mb-2 font-semibold">Dental Procedure</p>
                                <p class="text-gray-900 text-sm" x-text="selectedConsultation.dental_procedure"></p>
                            </div>
                            <div x-show="selectedConsultation.procedure_notes && selectedConsultation.procedure_notes.trim() !== ''" class="bg-gray-50 rounded-lg p-3">
                                <p class="text-xs text-gray-600 mb-2 font-semibold">Procedure Notes</p>
                                <p class="text-gray-900 text-sm" x-text="selectedConsultation.procedure_notes"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Follow-up & Instructions Section -->
                    <div x-show="selectedConsultation && (selectedConsultation.follow_up_date || selectedConsultation.special_instructions)" class="bg-white border border-gray-200 rounded-xl p-4 md:col-span-2">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-8 h-8 bg-cyan-100 rounded-lg flex items-center justify-center">
                                <svg class="w-4 h-4 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                            </div>
                            <h4 class="font-semibold text-gray-800">Follow-up & Special Instructions</h4>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div x-show="selectedConsultation.follow_up_date" class="bg-gray-50 rounded-lg p-3">
                                <p class="text-xs text-gray-600 mb-2 font-semibold">Follow-up Date</p>
                                <p class="text-gray-900 text-sm font-semibold" x-text="selectedConsultation.follow_up_date"></p>
                            </div>
                            <div x-show="selectedConsultation.special_instructions && selectedConsultation.special_instructions.trim() !== ''" class="bg-gray-50 rounded-lg p-3">
                                <p class="text-xs text-gray-600 mb-2 font-semibold">Special Instructions</p>
                                <p class="text-gray-900 text-sm" x-text="selectedConsultation.special_instructions"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Staff & Timestamps Section -->
                    <div x-show="selectedConsultation && (selectedConsultation.staff_name || selectedConsultation.created_at)" class="bg-white border border-gray-200 rounded-xl p-4 md:col-span-2">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center">
                                <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <h4 class="font-semibold text-gray-800">Record Information</h4>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div x-show="selectedConsultation.staff_name" class="bg-gray-50 rounded-lg p-3">
                                <p class="text-xs text-gray-600 mb-1">Attended By</p>
                                <p class="font-semibold text-gray-900 text-sm" x-text="selectedConsultation.staff_name"></p>
                            </div>
                            <div x-show="selectedConsultation.created_at" class="bg-gray-50 rounded-lg p-3">
                                <p class="text-xs text-gray-600 mb-1">Record Created</p>
                                <p class="font-semibold text-gray-900 text-sm" x-text="selectedConsultation.created_at"></p>
                            </div>
                            <div x-show="selectedConsultation.admission_time" class="bg-gray-50 rounded-lg p-3">
                                <p class="text-xs text-gray-600 mb-1">Admission Time</p>
                                <p class="font-semibold text-gray-900 text-sm" x-text="selectedConsultation.admission_time"></p>
                            </div>
                            <div x-show="selectedConsultation.discharge_time" class="bg-gray-50 rounded-lg p-3">
                                <p class="text-xs text-gray-600 mb-1">Discharge Time</p>
                                <p class="font-semibold text-gray-900 text-sm" x-text="selectedConsultation.discharge_time"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Original Medical History (kept for backward compatibility) -->
                    <div x-show="false" class="bg-white border border-gray-200 rounded-xl p-4 md:col-span-2">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-8 h-8 bg-teal-100 rounded-lg flex items-center justify-center">
                                <svg class="w-4 h-4 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <h4 class="font-semibold text-gray-800">Medical History</h4>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <p class="text-gray-900" x-text="selectedConsultation.medical_history"></p>
                        </div>
                    </div>

                    <!-- Additional Notes -->
                    <div x-show="selectedConsultation && selectedConsultation.notes && selectedConsultation.notes.trim() !== ''" class="bg-white border border-gray-200 rounded-xl p-4 md:col-span-2">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-8 h-8 bg-yellow-100 rounded-lg flex items-center justify-center">
                                <svg class="w-4 h-4 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </div>
                            <h4 class="font-semibold text-gray-800">Additional Notes</h4>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4 min-h-[80px]">
                            <p class="text-gray-900" x-text="selectedConsultation.notes"></p>
                        </div>
                    </div>
                </div>

                <!-- Modal Actions -->
                <div class="flex justify-center mt-8 pt-6 border-t border-gray-200">
                    <button @click="showViewModal = false; selectedConsultation = null" 
                            class="px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-semibold transition-all duration-200 flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        Close
                    </button>
                </div>
            </div>
            </template>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div x-show="showDeleteModal" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"
         @click.self="showDeleteModal = false">
        
        <div x-show="showDeleteModal"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform scale-95"
             x-transition:enter-end="opacity-100 transform scale-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 transform scale-100"
             x-transition:leave-end="opacity-0 transform scale-95"
             class="bg-white rounded-2xl shadow-2xl max-w-md w-full">
            
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-red-600 to-red-700 px-6 py-4 rounded-t-2xl">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
                        <i data-feather="trash-2" class="w-5 h-5 text-white"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-white">Delete Consultation</h3>
                        <p class="text-red-100 text-sm">This action cannot be undone</p>
                    </div>
                </div>
            </div>

            <!-- Modal Content -->
            <div class="p-6">
                <div class="mb-4">
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="flex items-start">
                            <i data-feather="alert-triangle" class="w-5 h-5 text-red-600 mr-3 mt-0.5"></i>
                            <div>
                                <h4 class="text-red-800 font-semibold text-sm">Confirm Deletion</h4>
                                <p class="text-red-700 text-sm mt-1">
                                    Are you sure you want to delete the consultation for 
                                    <span class="font-semibold" x-text="selectedConsultation?.patient"></span>?
                                </p>
                                <p class="text-red-600 text-xs mt-2">This will permanently remove all consultation data.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div x-show="selectedConsultation" class="mb-4 text-sm text-gray-600">
                    <p><strong>Patient:</strong> <span x-text="selectedConsultation?.patient"></span></p>
                    <p><strong>Date:</strong> <span x-text="selectedConsultation?.date"></span></p>
                    <p><strong>Time:</strong> <span x-text="selectedConsultation?.time"></span></p>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-end space-x-3">
                    <button @click="showDeleteModal = false"
                            class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors font-medium">
                        Cancel
                    </button>
                    <button @click="confirmDelete()"
                            class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium flex items-center space-x-2">
                        <i data-feather="trash-2" class="w-4 h-4"></i>
                        <span>Delete Consultation</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div x-show="showSettingsModal" x-cloak class="fixed inset-0 z-50 flex items-center justify-center p-4" style="display: none;">
        <div class="fixed inset-0 bg-black bg-opacity-50" @click="showSettingsModal = false"></div>
        <div class="relative bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-4 rounded-t-2xl">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <i data-feather="settings" class="w-6 h-6"></i>
                        <h3 class="text-xl font-bold">Settings</h3>
                    </div>
                    <button @click="showSettingsModal = false" class="text-white hover:text-gray-200 transition-colors">
                        <i data-feather="x" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>
            
            <!-- Modal Content -->
            <div class="p-6 space-y-6">
                <!-- Profile Settings -->
                <div>
                    <h4 class="text-lg font-medium text-gray-900 mb-4">Profile Information</h4>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">First Name</label>
                                <input type="text" value="{{ user.first_name }}" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Last Name</label>
                                <input type="text" value="{{ user.last_name }}" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Position</label>
                            <input type="text" value="{{ user.position }}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" value="{{ user.username }}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>
                
                <!-- Security Settings -->
                <div>
                    <h4 class="text-lg font-medium text-gray-900 mb-4">Security</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Current Password</label>
                            <input type="password" placeholder="Enter current password" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">New Password</label>
                            <input type="password" placeholder="Enter new password" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Confirm New Password</label>
                            <input type="password" placeholder="Confirm new password" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div class="bg-gray-50 px-6 py-4 rounded-b-2xl">
                <div class="flex justify-end space-x-3">
                    <button @click="showSettingsModal = false" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors font-medium">
                        Cancel
                    </button>
                    <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div x-show="showDeleteModal" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"
         @click.self="showDeleteModal = false">
        
        <div x-show="showDeleteModal"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform scale-95"
             x-transition:enter-end="opacity-100 transform scale-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 transform scale-100"
             x-transition:leave-end="opacity-0 transform scale-95"
             class="bg-white rounded-2xl shadow-2xl max-w-md w-full">
            
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-red-600 to-red-700 px-6 py-4 rounded-t-2xl">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
                        <i data-feather="trash-2" class="w-5 h-5 text-white"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-white">Delete Consultation</h3>
                        <p class="text-red-100 text-sm">This action cannot be undone</p>
                    </div>
                </div>
            </div>

            <!-- Modal Content -->
            <div class="p-6">
                <div class="mb-4">
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="flex items-start">
                            <i data-feather="alert-triangle" class="w-5 h-5 text-red-600 mr-3 mt-0.5"></i>
                            <div>
                                <h4 class="text-red-800 font-semibold text-sm">Confirm Deletion</h4>
                                <p class="text-red-700 text-sm mt-1">
                                    Are you sure you want to delete the consultation for 
                                    <span class="font-semibold" x-text="selectedConsultation?.patient"></span>?
                                </p>
                                <p class="text-red-600 text-xs mt-2">This will permanently remove all consultation data.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div x-show="selectedConsultation" class="mb-4 text-sm text-gray-600">
                    <p><strong>Patient:</strong> <span x-text="selectedConsultation?.patient"></span></p>
                    <p><strong>Date:</strong> <span x-text="selectedConsultation?.date"></span></p>
                    <p><strong>Time:</strong> <span x-text="selectedConsultation?.time"></span></p>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-end space-x-3">
                    <button @click="showDeleteModal = false"
                            class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors font-medium">
                        Cancel
                    </button>
                    <button @click="confirmDelete()"
                            class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium flex items-center space-x-2">
                        <i data-feather="trash-2" class="w-4 h-4"></i>
                        <span>Delete Consultation</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div x-show="showSettingsModal" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
         @click.self="showSettingsModal = false">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold text-gray-900">Settings</h3>
                    <button @click="showSettingsModal = false" class="text-gray-400 hover:text-gray-600">
                        <i data-feather="x" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <form class="space-y-6">
                    <!-- Profile Settings -->
                    <div>
                        <h4 class="text-lg font-medium text-gray-900 mb-4">Profile Information</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                                <input type="text" value="{{ user.first_name }} {{ user.last_name }}" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                <input type="email" value="{{ user.username }}" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Security Settings -->
                    <div>
                        <h4 class="text-lg font-medium text-gray-900 mb-4">Security</h4>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Current Password</label>
                                <input type="password" placeholder="Enter current password" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">New Password</label>
                                <input type="password" placeholder="Enter new password" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Confirm New Password</label>
                                <input type="password" placeholder="Confirm new password" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notification Settings -->
                    <div>
                        <h4 class="text-lg font-medium text-gray-900 mb-4">Notifications</h4>
                        <div class="space-y-3">
                            <label class="flex items-center">
                                <input type="checkbox" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700">Email notifications for new appointments</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700">SMS notifications for urgent matters</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700">Weekly summary reports</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" @click="showSettingsModal = false"
                                class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                            Cancel
                        </button>
                        <button type="submit"
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div x-show="showLogoutConfirm" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
         @click.self="showLogoutConfirm = false">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
            <div class="p-6">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mr-3">
                        <i data-feather="log-out" class="w-5 h-5 text-red-600"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900">Confirm Logout</h3>
                </div>
                
                <p class="text-gray-600 mb-6">Are you sure you want to logout? You will need to login again to access the system.</p>
                
                <div class="flex justify-end space-x-3">
                    <button @click="showLogoutConfirm = false"
                            class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button @click="window.location.href = '{{ url_for('logout') }}'"
                            class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                        Yes, Logout
                    </button>
                </div>
            </div>
        </div>
    </div>


</body>
</html>
